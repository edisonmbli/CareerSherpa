# 文档 1：需求文档 (Requirements Document)

**目标**：本文档旨在定义「Job Assistant AI」重构项目的核心业务需求、用户价值和功能边界。它是后续“解决方案设计”和“执行规划”的最高输入。

**致 AI IDE / 开发伙伴**：
本项目**不是**从零开始。我们正从一个“技术验证原型（Prototype）”迁移到一个“生产级（Production-Ready）”应用。

- **原型的功劳**：验证了 LLM 提取 Summary 的可行性 (`docs/backup/execution_plan_老版本_bk.md` M1 阶段)。
- **原型的包袱**：采用了与 Vercel Serverless 架构不兼容的“本地内存队列” (`llm-scheduler.ts`)，以及导致用户体验灾难的“同步阻塞式”工作流（在一步内合并了简历上传和岗位分析）。

**本次重构的核心是架构和流程的“颠覆”**：我们将彻底抛弃原型的“阻塞式流程”和“本地队列”，转向基于“异步消息队列”和“资产/服务分离”的新架构。

---

## 主题 1.1：产品愿景 (Product Vision) 与用户画像 (Personas)

### 1.1.1 产品愿景

**产品口号**：做求职路上“最后一公里”的 AI 助推器。

**核心业务场景**：
求职者在求职后期，需要针对海量的、感兴趣的岗位（JD）进行高频、重复的“定制化”工作。本项目旨在通过 AI 提效、提质。

**核心价值（三步曲）**：
我们将为用户提供一个“层层递进”的 AI 服务流，以一个`service_id`（服务单元）为核心，贯穿求职的三个关键步骤：

1.  **（必选）Step 1: 匹配度分析 (Match)**：基于用户的简历和目标 JD，提供匹配度评分、分析结论，以及“毛遂自荐”话术。
2.  **（可选）Step 2: 简历定制化 (Customize)**：基于 Step 1 的分析结果，生成一份针对该 JD 定制优化后的简历。
3.  **（可选）Step 3: 面试定向准备 (Interview)**：基于 Step 2 的定制化简历，生成专属的自我介绍和面试准备 Tips。

### 1.1.2 重构场景（关键！）

**旧原型（需抛弃）**：
原型将“上传简历/履历”和“分析 JD”混在同一步，导致用户每次分析新 JD 时都可能被“重新分析简历”的动作阻塞，这完全不符合用户心智。

**新架构（需实现）**：
我们必须在产品架构上严格区分两个概念：

1.  **“求职资产”（Assets）- 低频管理**：

    - **指什么**：`个人通用简历`（必选，1 份）和`个人详细履历`（可选，1 份）。
    - **在哪里管理**：**Profile Page** (个人主页)。
    - **何时处理**：用户注册后被引导上传，或后续自行更新。LLM 提取 Summary 的动作在*上传时*异步触发并落表。
    - **重构指令**：这意味着“上传简历/履历”的 Server Actions 必须与“创建服务”的 Actions **完全解耦**。

2.  **“求职服务”（Services）- 高频使用**：
    - **指什么**：针对某个具体 JD（岗位）发起的“Match -> Customize -> Interview”三步曲服务。
    - **在哪里管理**：**Workbench Page** (工作台)。
    - **何时处理**：用户在工作台粘贴 JD（或上传截图）时创建。
    - **重构指令**：“创建服务”的 Action 只处理 `job` 信息的提取，并*立即*（或通过流式）返回 Step 1 (Match) 的结果。它不再关心“简历资产”的解析，而是**直接消费**已经落表的`resume_summary_json`和`detailed_resume_summary_json`。

### 1.1.3 核心用户画像 (Personas)

我们的设计需要满足以下两类核心用户的需求：

**Persona 1：应届生 / 职场新人 (张伟)**

- **背景**：刚毕业或工作 1-2 年，求职经验不足，简历（资产）本身不完善。
- **核心诉求**：
  1.  **需要引导**：他不知道“通用简历”和“详细履历”的区别，需要清晰的指引甚至示例，来帮他准备好“求职资产”。
  2.  **依赖分析**：高度依赖 Step 1 (Match) 的分析结果，来判断自己是否匹配、短板在哪。
  3.  **渴望模板**：高度依赖 Step 2 (Customize) 和 Step 3 (Interview) 生成的“标准答案”。
- **重构信号**：
  - `Profile Page` 的体验至关重要。必须有强引导，解释“详细履历”的价值（“上下文越丰富越好”）。
  - Step 1 (Match) 的输出质量是留存他的关键。

**Persona 2：资深候选人 / 高频求职者 (李静)**

- **背景**：工作 5 年以上，“求职资产”（简历/履历）已经非常完善。她同时在看多个机会（海投或猎头推荐）。
- **核心诉求**：
  1.  **效率至上**：她无法忍受任何不必要的等待。她希望上传一次资产，就能*立即*、*并行*地分析多个 JD。
  2.  **成本敏感**：她理解 AI 服务的价值，但也关心成本。她需要透明的计费（金币系统）和可选择的服务（她可能 90% 的时间只用 Step 1）。
  3.  **掌控力**：她不需要 AI“教她做事”，而是需要 AI“帮她做事”。她需要 Step 2 (Customize) 产出的简历是可以*二次编辑*的（如 Markdown + 预览）。
- **重构信号**：
  - “资产/服务”分离的架构是*必须*的。
  - **异步化**是核心。`Workbench` 必须支持“并行创建多轮求职服务”。
  - “金币”计费系统 (`quotas`) 和付费/免费队列的划分 (`LLM 调度器`) 是服务她的基础。

## 主题 1.2：核心用户故事 (User Stories) 与验收标准 (Acceptance Criteria)

**致 AI IDE / 开发伙伴**：
本节将“用户体验地图” 转换为具体的用户故事。重点在于明确定义**新架构下的验收标准 (AC)**。

**重构关键**：

- **异步处理**：凡是涉及 LLM 调用的（如资产上传、服务创建），必须是异步非阻塞的。
- **状态管理**：前端必须能响应异步任务的状态（如 `pending`, `success`, `error`）。
- **原子化计费**：金币（Quotas）的扣减和返还必须是原子的。
- **流程分离**：`Profile` (资产) 和 `Workbench` (服务) 的逻辑必须严格分离。

---

### Epic 1: 用户引导与注册 (Onboarding)

**User Story 1.1: 游客访问与注册**

> **作为** 一名游客（未登录用户），
> **我想要** 访问 Landing Page，了解产品价值，并能通过社交账号或邮箱快速注册，
> **以便于** 我能开始使用服务并获得初始赠送金币。

**验收标准 (Acceptance Criteria):**

1.  **Given** 游客访问根路径 (`/`)，
    - **When** 加载页面，
    - **Then** 必须展示 Landing Page (用于介绍功能)。
2.  **Given** 游客在 Landing Page 点击“立即试用”，
    - **When** 触发注册流程 (由 Neon Auth / Clerk 提供)，
    - **Then** 系统支持邮箱或社交账号注册。
3.  **Given** 用户首次成功注册，
    - **When** 账户被创建，
    - **Then** 系统必须在 `quotas` 表中为该 `user_id` 初始化 `+N` 个金币 (N 可由环境变量配置，例如 8)。
    - **And** 用户被重定向到 `Profile Page` (引导其上传资产)。

**User Story 1.2: 已登录用户访问**

> **作为** 一名已登录用户，
> **我想要** 在访问根路径时跳过 Landing Page，
> **以便于** 我能直接进入工作台开始我的任务。

**验收标准 (Acceptance Criteria):**

1.  **Given** 用户已持有有效的登录态 (Session)，
    - **When** 访问根路径 (`/`)，
    - **Then** 系统必须自动重定向到 `Workbench Page` (工作台)。

---

### Epic 2: 求职资产管理 (Profile Page)

**User Story 2.1: 上传个人通用简历 (核心资产)**

> **作为** 一名新用户（张伟），
> **我想要** 在 `Profile Page` 上传我的“个人通用简历”（PDF 格式），并被告知这是后续服务的**必选项**，
> **以便于** 系统能异步解析我的简历，为后续的岗位匹配做准备。

**验收标准 (Acceptance Criteria):**

1.  **Given** 用户在 `Profile Page`，
    - **When** 上传“个人通用简历”(PDF)，
    - **Then** 系统必须**立即**返回上传成功的状态，**不允许**让用户在界面上等待 LLM 解析。
2.  **Given** 上传动作触发 (例如 Server Action)，
    - **When** 后端接收到文件，
    - **Then** 必须先执行**原子化**的金币扣减（例如 -1 金币）。
    - **And** 如果金币不足，必须明确告知用户将进入“免费低速队列”。
    - **And** 必须将“LLM 解析任务”（Task: `resume`）推送到 **QStash** 队列。
3.  **Given** QStash 的 Worker 消费了该任务，
    - **When** LLM 解析完成，
    - **Then** 必须将提取的 `resume_summary_json` 写入相应的数据表，并关联 `user_id`。
4.  **Given** LLM 任务失败，
    - **When** 系统捕获到异常，
    - **Then** 必须**原子化**地将金币返还给用户。
5.  **Given** 用户已上传过简历，
    - **When** 再次上传（覆盖操作），
    - **Then** 必须重复上述 1-4 的完整流程（包括扣金币、异步解析）。
    - **And** 系统只保留**一份**（最新的）通用简历。

**User Story 2.2: 上传个人详细履历 (可选资产)**

> **作为** 一名用户（张伟或李静），
> **我想要** 在 `Profile Page` 被引导上传“个人详细履历”（PDF，可选），并被告知这能提升 AI 输出质量，
> **以便于** AI 在后续服务中能有更丰富的上下文。

**验收标准 (Acceptance Criteria):**

1.  **Given** 用户在 `Profile Page`，
    - **When** 查看此模块，
    - **Then** 必须有明显的 UI 提示 (如 Tooltip 或示例)，告知用户提供详细履历的好处（例如“上下文越丰富越好”）。
2.  **Given** 用户上传“个人详细履历”，
    - **When** 触发上传 Action，
    - **Then** 必须遵循 User Story 2.1 中 1-4 的所有异步处理、金币扣减/返还、QStash 队列逻辑（Task: `detailed_resume`）。
3.  **Given** 用户已上传过履历，
    - **When** 再次上传（覆盖），
    - **Then** 同样遵循 1-4 的流程，系统只保留**一份**（最新的）详细履历。

---

### Epic 3: 核心服务流 (Workbench Page)

**User Story 3.1: 创建求职服务 (Step 1: Match)**

> **作为** 一名用户（李静），
> **我想要** 在 `Workbench Page` 粘贴岗位 JD（文字或截图），并立即创建一个“求职定制化服务”，
> **以便于** 我能快速（流式）获取 Step 1 的匹配度分析结果。

**验收标准 (Acceptance Criteria):**

1.  **Given** 用户在 `Workbench Page` 点击“创建服务”，
    - **When** 用户尚未上传“个人通用简历”，
    - **Then** 系统必须**驳回**创建请求，并提示用户先去 `Profile Page` 上传（这是**严格的前置依赖**）。
2.  **Given** 用户已上传简历，并粘贴了 JD 文本（或上传截图），
    - **When** 触发“创建服务” Action，
    - **Then** 系统必须执行**原子化**的金币扣减（例如 -2 金币）。
    - **And** 系统必须**立即**在 `services` 表创建一条记录（生成 `service_id`），并关联 `user_id`, `resume_id`, `detailed_resume_id` (如果有)。
    - **And** 系统必须（**异步或同步**，取决于 `job` 任务复杂度）触发 `job` 任务的 LLM 解析。
    - **And** 系统必须（**异步**）触发 `match` 任务的 LLM RAG 分析。
3.  **Given** `job` 任务正在处理（例如截图 OCR），
    - **When** 用户在前端等待，
    - **Then** 界面必须显示清晰的进度提示 (e.g., "正在提取岗位信息...")。
4.  **Given** `match` 任务的 LLM 已开始返回分析结果，
    - **When** 用户在前端等待，
    - **Then** 界面必须采用**流式 (Stream)** 方式，实时展示 `match` 任务的输出（分数、分析结论、求职话术）。
5.  **Given** 整个服务创建（含 `job` 和 `match`）失败，
    - **When** 系统捕获异常，
    - **Then** 必须**原子化**地返还金币，并在界面给出友好提示。
6.  **Given** 用户（李静）正在等待一个服务（Service A）的流式返回，
    - **When** 她点击“新建另外的定制化服务”，
    - **Then** 系统必须**允许**她创建 Service B，**Service A 和 B 必须可以并行处理**。

**User Story 3.2: 进阶服务 (Step 2: Customize)**

> **作为** 一名用户（张伟），
> **我想要** 在完成 Step 1 (Match) 之后，点击“帮我改简历”，
> **以便于** AI 能为我生成一份针对该 JD 定制化的简历。

**验收标准 (Acceptance Criteria):**

1.  **Given** 用户已完成某个 `service_id` 的 Step 1 (Match)，
    - **When** 点击“帮我改简历” (Customize)，
    - **Then** 系统必须先执行**原子化**金币扣减（例如 -2 金币）。
2.  **Given** 触发 `customize` 任务，
    - **When** LLM 开始处理，
    - **Then** 任务上下文必须包含：`resume_summary_json`, `detailed_resume_summary_json` (如有), `job_summary_json`, `match` 任务的结果，以及 RAG 知识库（简历撰写技巧）。
3.  **Given** LLM 返回结果，
    - **When** 任务完成，
    - **Then** 系统必须将新简历（建议为 Markdown 格式）存入数据表，关联 `customized_resume_id`。
    - **And** 界面必须（**可流式或非流式**）展示生成的简历。
4.  **Given** 任务失败，
    - **When** 系统捕获异常，
    - **Then** 必须**原子化**地返还金币。

**User Story 3.3: 进阶服务 (Step 3: Interview)**

> **作为** 一名用户（张伟），
> **我想要** 在完成 Step 2 (Customize) 之后，点击“生成面试 Tips”，
> **以便于** AI 帮我准备好自我介绍和面试要点。

**验收标准 (Acceptance Criteria):**

1.  **Given** 用户已完成某个 `service_id` 的 Step 2 (Customize)，
    - **When** 点击“生成面试 Tips” (Interview)，
    - **Then** 系统必须先执行**原子化**金币扣减（例如 -2 金币）。
2.  **Given** 触发 `interview` 任务，
    - **When** LLM 开始处理，
    - **Then** 任务上下文必须包含：`customized_resume` (Step 2 结果), `match` 任务结果，以及 RAG 知识库（面试准备技巧）。
3.  **Given** LLM 返回结果，
    - **When** 任务完成，
    - **Then** 界面必须采用**流式 (Stream)** 方式，实时展示面试 Tips（自我介绍、要点清单）。
4.  **Given** 任务失败，
    - **When** 系统捕获异常，
    - **Then** 必须**原子化**地返还金币。

---

### Epic 4: 历史回顾与迭代 (History & Iteration)

**User Story 4.1: 查看与续跑历史服务**

> **作为** 一名用户（李静），
> **我想要** 在左侧边栏查看我所有的历史服务记录，并能点击加载任一服务，
> **以便于** 我能回看历史产出，或者继续推进（如从 Step 1 推进到 Step 2）。

**验收标准 (Acceptance Criteria):**

1.  **Given** 用户在 `Workbench Page`，
    - **When** 查看左侧边栏，
    - **Then** 必须展示一个按时间倒序排列的“历史服务列表”（基于 `service_id`）。
2.  **Given** 用户点击一个历史服务（Service C），
    - **When** 该服务只完成了 Step 1 (Match)，
    - **Then** `Workbench` 的主工作区必须加载 Service C 的数据，展示 Step 1 的历史结果。
    - **And** Step 2 (Customize) 的触发按钮必须处于“可点击”状态，允许用户“继续推进”。
3.  **Given** 用户点击一个历史服务（Service D），
    - **When** 该服务已完成全部 3 个 Step，
    - **Then** 主工作区必须加载 Service D 的数据，并允许用户切换查看 3 个 Step 的所有历史输出内容。

**User Story 4.2: 编辑与导出定制化简历**

> **作为** 一名用户（李静），
> **我想要** 在查看 Step 2 (Customize) 生成的简历时，能对其进行二次编辑和导出，
> **以便于** 我能加入我的微调，并将其用于投递。

**验收标准 (Acceptance Criteria):**

1.  **Given** 用户在 `Workbench` 查看一份已生成的“定制化简历”（Step 2 结果），
    - **When** 界面加载，
    - **Then** 必须提供一个编辑器（例如“左侧 Markdown，右侧实时预览 PDF 效果”）。
2.  **Given** 用户在编辑器中修改了 Markdown 内容，
    - **When** 点击“保存”，
    - **Then** 系统必须能保存用户修改后的新版本（**此操作不扣金币**）。
3.  **Given** 用户对预览效果满意，
    - **When** 点击“导出 PDF”，
    - **Then** 系统必须能生成一份“可见即所得”的 PDF 文件供用户下载（**此操作不扣金币**）。

---

### Epic 5: 商业化 (Commercialization)

**User Story 5.1: 查看与购买金币**

> **作为** 一名认可产品价值的用户（李静），
> **我想要** 能清晰看到我的金币余额，并能方便地购买更多金币，
> **以便于** 我能在需要时使用付费高速队列。

**验收标准 (Acceptance Criteria):**

1.  **Given** 用户在 `Workbench Page`，
    - **When** 查看左侧边栏（或顶部导航），
    - **Then** 必须清晰展示当前“可用金币”数量 (`quotas`)。
2.  **Given** 用户点击金币余额，
    - **When** 导航触发，
    - **Then** 必须跳转到 `Profile Page`。
3.  **Given** 用户在 `Profile Page`，
    - **When** 查看金币模块，
    - **Then** 必须能看到金币的“购买选项”（例如 5 元 10 枚）。
    - **And** 必须能看到金币的“购买历史”和“消费历史”列表。
    - **And** 必须集成 Stripe (或中国本土支付集合平台) 支付能力，允许用户完成购买。
4.  **Given** 用户完成支付，
    - **When** 支付回调 (Webhook) 成功，
    - **Then** 系统必须**原子化**地为用户的 `quotas` 增加相应数量的金币 (`quota + N`)。

---

## 主题 1.3：功能性需求列表 (Functional Requirements)

**致 AI IDE / 开发伙伴**：
本节是“What to Build”的清单。它基于“用户故事”进一步拆解，明确了系统必须具备的功能模块。

**重构关键**：

- **重构 `LLM 调度器`**：这是本次重构的技术核心。我们将**彻底废弃**原型的本地队列 (`llm-scheduler.ts`)，**新建**一个基于 `Upstash QStash` + `Vercel KV` 的异步消息队列系统。
- **重构 `数据表`**：原型的 `prisma.schema` 已不满足新流程，需**重置并重建**（Reset Database）。
- **新建 `RAG` 流程**：原型中 `pgvector` 仅是启用，新架构需要**实际落地** RAG 的文档入库和检索流程。
- **新建 `商业化` 逻辑**：以“金币”（Quotas）为核心的计费、扣费、返还、购买逻辑是**全新功能**。

---

### FR-1: 认证与用户 (Authentication & User)

1.  **FR-1.1 (集成 Neon Auth)**：系统必须集成 Neon Auth 处理用户注册、登录、Session 管理。
    - **重构说明**：原型已集成 Neon Auth (`neon_auth.users_sync`)。重构时需保留此集成，并确保其 `user_id` 作为所有业务表（如 `quotas`, `services`）的核心外键。
2.  **FR-1.2 (Profile 管理)**：系统必须提供一个 `Profile Page` (`/profile`)。
3.  **FR-1.3 (用户资产管理区)**：`Profile Page` 必须允许用户上传和管理（覆盖）以下两项核心资产：
    - `个人通用简历` (PDF, 必选, 1 份)
    - `个人详细履历` (PDF, 可选, 1 份)
4.  **FR-1.4 (用户商业化管理区)**：`Profile Page` 必须展示用户的金币余额、消费历史、购买历史，并提供金币购买入口。

### FR-2: 核心服务 (Service Flow)

1.  **FR-2.1 (服务创建)**：系统必须提供一个 `Workbench Page` (`/workbench`) 作为核心工作区。
2.  **FR-2.2 (创建前置检查)**：`Workbench` 在创建新服务前，必须检查用户是否已上传“个人通用简历”。若未上传，必须驳回并引导用户至 `Profile Page`。
3.  **FR-2.3 (岗位 JD 上传)**：在 `Workbench` 创建服务时，必须支持用户通过“粘贴文本”或“上传截图”的方式提供 JD（岗位信息）。
4.  **FR-2.4 (服务单元)**：每次创建服务，系统必须生成一个唯一的 `service_id`，用于关联该服务下的所有产出（Match, Customize, Interview）。
5.  **FR-2.5 (服务层层递进)**：服务流程必须遵循严格的依赖关系：
    - `Step 1 (Match)` 是入口，依赖 `resume` + `job`。
    - `Step 2 (Customize)` 依赖 `Step 1` 的结果 (`match_id`)。
    - `Step 3 (Interview)` 依赖 `Step 2` 的结果 (`customized_resume_id`)。
6.  **FR-2.6 (并行服务)**：系统必须支持用户并行创建和处理多个 `service_id`。为防止黑产攻击，需要为每个 `user_id` 限制最大并发数（例如 3 个服务）。
7.  **FR-2.7 (历史服务查看)**：`Workbench` 必须提供“历史服务列表”，允许用户点击加载任一 `service_id` 的历史产出。
8.  **FR-2.8 (历史服务续跑)**：当加载一个未完成全部步骤的历史服务时，系统必须允许用户从中断处继续推进（例如执行 Step 2）。

### FR-3: LLM 任务与调度 (LLM & Queue) - 【重构核心】

1.  **FR-3.1 (抛弃本地队列)**：**必须彻底移除**原型中基于本地内存的 `llm-scheduler.ts` 及其复杂的 `type + tier` 队列逻辑。
2.  **FR-3.2 (引入 QStash)**：**必须新建**一个 LLM 调度器，使用 `Upstash QStash` 作为异步消息队列，用于处理所有耗时（超过 Vercel 超时限制）的 LLM 任务。
3.  **FR-3.3 (异步任务定义)**：以下 LLM 任务必须通过 QStash 异步执行：
    - `Task-resume` (上传通用简历时触发)
    - `Task-detailed_resume` (上传详细履历时触发)
    - `Task-job` (创建服务时触发，特别是 OCR)
    - `Task-match` (创建服务时触发)
    - `Task-customize` (用户点击“改简历”时触发)
    - `Task-interview` (用户点击“面试 Tips”时触发)
4.  **FR-3.4 (简化队列模型)**：新的调度器队列逻辑必须**简化**，直接绑定 LLM 模型和并发数（使用 `Vercel KV` 或类似工具进行并发控制）。
5.  **FR-3.5 (队列映射)**：必须实现“金币”状态与队列的映射：
    - `quotas > 0`：任务进入“付费高速队列”（如 DeepSeek，高并发）。
    - `quotas <= 0`：任务进入“免费低速队列”（如 GLM-4.5-Flash，低并发）。
6.  **FR-3.6 (任务与队列路由)**：必须根据“任务类型”和“队列状态”将任务路由到正确的模型队列（参照 `docs/项目颠覆性重构的想法.md` 中的表格）。
7.  **FR-3.7 (流式输出)**：对于面向用户的即时反馈任务（`match`, `interview`），系统必须支持 **SSE (Server-Sent Events)** 流式输出，将 LLM 结果实时展示到前端。
8.  **FR-3.8 (进度展示)**：对于流式之前的准备任务（如 `job` 提取），前端必须有明确的进度条或状态显示 (`progress display`)。

### FR-4: RAG (Retrieval-Augmented Generation) - 【新建】

1.  **FR-4.1 (pgvector 启用)**：必须使用 Neon DB 的 `pgvector` 扩展。
2.  **FR-4.2 (知识库入库)**：必须提供（或通过脚本支持）将“求职面试干货知识”（由我提供）清洗、分块、向量化后存入 `pgvector` 表。
3.  **FR-4.3 (RAG 检索)**：以下任务在调用 LLM 前，必须先从 RAG 知识库中检索相关上下文（Top-K 片段），并注入到 Prompt 中：
    - `Task-match` (检索“匹配度分析技巧”、“毛遂自荐经验”)
    - `Task-customize` (检索“简历撰写知识”)
    - `Task-interview` (检索“面试准备知识”“自我介绍技巧”)

### FR-5: 商业化 (Commercialization) - 【新建】

1.  **FR-5.1 (金币-Quotas)**：必须在数据库中（如 `quotas` 表）为每个 `user_id` 维护一个“金币”余额字段。
2.  **FR-5.2 (初始赠送)**：新用户注册时，必须自动获赠 N 枚金币（N 可配置）。
3.  **FR-5.3 (原子化扣减)**：在执行**任何** LLM 任务（包括资产上传和三步服务）之前，必须**原子化**地检查并扣减 `quotas` 表中的金币（参照 `项目颠覆性重构的想法.md` 中的扣费表）。
4.  **FR-5.4 (原子化返还)**：如果任何异步 LLM 任务执行失败（例如 API 500 或解析失败），系统必须**原子化**地将该任务所扣金币返还给用户。
5.  **FR-5.5 (支付集成)**：`Profile Page` 必须集成 `Stripe`（或 中国本土支付集成平台），提供金币购买包（例如 5 元 10 枚）。
6.  **FR-5.6 (支付回调)**：必须能处理 Stripe 的 Webhook 回调，在确认支付成功后，**原子化**地为用户增加金币。

### FR-6: UI/UX 与辅助功能

1.  **FR-6.1 (页面布局)**：应用必须包含以下核心页面布局：
    - `Landing Page` (游客访问)
    - `Profile Page` (管理资产和金币)
    - `Workbench Page` (三栏式布局：左侧历史列表，中间主工作区)
2.  **FR-6.2 (Markdown 编辑器)**：系统在展示 `Step 2 (Customize)` 结果时，必须提供一个“所见即所得”的编辑器（左侧 Markdown，右侧 PDF 预览）。
3.  **FR-6.3 (编辑器保存与导出)**：Markdown 编辑器必须支持“保存修改”（不扣金币）和“导出 PDF”（不扣金币）。
4.  **FR-6.4 (国际化)**：系统必须支持多语言切换（例如中/英文）。
5.  **FR-6.5 (主题切换)**：系统必须支持 Light / Dark 模式切换。
6.  **FR-6.6 (移动端适配)**：桌面端体验优先，移动端必须做响应式适配，确保核心功能可用。

---

## 主题 1.4：非功能性需求 (Non-Functional Requirements)

**致 AI IDE / 开发伙伴**：
本节定义了系统的质量标准和技术约束。这是确保重构后的应用在生产环境中（尤其是 Vercel 上）稳定、高效、安全运行的关键。

**重构关键**：

- **核心转变**：我们正从一个“有状态、本地”的原型（`docs/backup/execution_plan_老版本_bk.md` M1）转变为一个“无状态、分布式”的 Serverless 架构。
- **SLA 重点**：性能（Latency & Stream）、可靠性（Atomic Quotas）和可观测性（Logging）是本次重构的非功能性重点。

---

### NFR-1: 架构与部署 (Architecture & Deployment)

1.  **NFR-1.1 (部署环境)**：应用**必须**设计为在 **Vercel** 平台上运行，所有后端逻辑（Server Actions, API Routes）都将作为 Serverless Functions 部署。
2.  **NFR-1.2 (无状态要求)**：**（重构核心）** 所有 Serverless Functions **严禁**依赖本地内存或进程内状态。
    - **废弃**：原型的 `llm-scheduler.ts` 中基于内存的队列。
    - **采用**：使用 `Upstash QStash` 处理异步任务，使用 `Upstash Redis` 处理分布式锁（如并发控制）和短时缓存。
3.  **NFR-1.3 (技术栈)**：
    - **前端/后端**：Next.js (App Router)。
    - **样式**：Tailwind CSS + shadcn/ui。
    - **数据库**：Neon Postgres (启用 `pgvector` 扩展)。
    - **ORM**：Prisma (配合严格的 DAL - Data Access Layer)。
    - **认证**：Neon Auth 。
    - **支付**：Stripe（或 中国本土支付集成平台）。

### NFR-2: 性能 (Performance)

1.  **NFR-2.1 (感知延迟 - 流式)**：对于用户触发的即时 LLM 任务，**必须**采用 **SSE (Server-Sent Events)** 流式返回，以最大程度降低用户感知延迟。
    - **适用任务**：`Task-match` (匹配度分析), `Task-interview` (面试 Tips)。
2.  **NFR-2.2 (感知延迟 - 进度)**：对于流式开始前的准备任务（如 `Task-job` 的 OCR 或解析），前端**必须**显示明确的进度状态 (`progress display`)。
3.  **NFR-2.3 (服务等级目标 - SLO)**：
    - **P95 延迟**：`Task-match`（从触发到首个 token）应 ≤ 8 秒。`Task-customize` 和 `Task-interview`（从触发到首个 token）应 ≤ 12 秒。
    - **资产解析**：`Task-resume` 和 `Task-detailed_resume` 是异步后台任务，不设严格 P95，但应在 3 分钟内完成。
4.  **NFR-2.4 (并发控制)**：**（重构核心）** 必须用 `Vercel KV` 或类似工具实现**分布式并发控制**，严格遵守新 LLM 调度器定义的并发上限（例如 `deepseek-chat: 5`, `glm-4.5-flash: 2`），防止 API 密钥被上游（如 DeepSeek）封禁。
5.  **NFR-2.5 (用户级并发)**：系统**必须**支持同一用户并行发起多个 `service_id` 的创建（例如，李静同时分析 3 个 JD）。

### NFR-3: 可靠性与弹性 (Reliability & Resilience)

1.  **NFR-3.1 (原子化计费)**：**（新建核心）** 所有“金币” (`quotas`) 的操作**必须**是原子的。
    - **扣减**：在任务（包括异步任务）推送到 QStash **之前**，必须在数据库事务中完成扣减。
    - **返还**：在 QStash worker 捕获到**最终失败**（例如 LLM API 5xx 或 RAG 失败）时，**必须**触发一个原子化的返还操作，将金币退回用户账户。
2.  **NFR-3.2 (幂等性)**：所有触发计费和创建资源的操作（特别是 Server Actions）**必须**具备幂等性，防止用户因网络重试导致重复扣费。
    - **实现**：可使用 `Vercel KV` 配合请求哈希（hash）实现短时（例如 15 分钟）幂等键检查。
3.  **NFR-3.3 (任务重试)**：利用 `Upstash QStash` 的内置重试机制（例如指数退避）处理 LLM 服务的瞬时故障（如网络抖动、API 429）。

### NFR-4: 安全与合规 (Security & Compliance)

1.  **NFR-4.1 (认证)**：所有需要登录的页面 (`/profile`, `/workbench`) 和 Server Actions **必须**通过认证中间件（基于 Neon Auth / Clerk）进行保护。
2.  **NFR-4.2 (数据隐私 PII)**：用户上传的简历 (`resume`) 和履历 (`detailed_resume`) 包含高度敏感的个人信息 (PII)。
    - 数据库中的原始文本字段（`original_text`）**应**加密存储。
    - AI IDE 在设计日志（NFR-5）时，**严禁**将简历原文或敏感 `summary_json` 内容输出到标准日志中。
3.  **NFR-4.3 (数据删除)**：必须支持用户删除其账户及所有关联数据（简历、服务记录等），且操作应立即生效或在 24 小时内完成硬删除。
4.  **NFR-4.4 (支付安全)**：支付流程**必须**完全委托给 `Stripe`，应用后端仅处理 Stripe Webhook，**严禁**存储任何信用卡信息。

### NFR-5: 可观测性 (Observability)

1.  **NFR-5.1 (结构化日志)**：**必须**实现结构化日志（例如 JSON 格式，Vercel Logs 支持）。
2.  **NFR-5.2 (核心指标)**：日志中**必须**包含以下关键字段，以便于排障和成本分析：
    - `userId`
    - `serviceId`
    - `taskId` (QStash 消息 ID)
    - `taskName` (e.g., `resume`, `match`)
    - `queue` (e.g., `paid-deepseek`, `free-glm`)
    - `latencyMs` (任务总耗时)
    - `isStream` (true/false)
    - `tokenInput`, `tokenOutput`, `cost` (（如果 LLM provider 返回）)
    - `error` (如果失败)

### NFR-6: 易用性与国际化 (Usability & i18n)

1.  **NFR-6.1 (响应式设计)**：优先保障桌面端（Desktop-first）体验，但所有页面**必须**在移动端（Mobile）上可用且布局合理。
2.  **NFR-6.2 (国际化 i18n)**：系统**必须**支持至少中文（`zh`）和英文（`en`）两种语言，包括 UI 文本和 AI Prompt。
3.  **NFR-6.3 (主题)**：系统**必须**支持亮色（Light）和暗色（Dark）模式切换。
