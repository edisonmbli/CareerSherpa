# 66. 简历头像存储方案迁移指南 (Avatar Storage Migration Guide)

## 1. 现状核查与结论

### 1.1 当前代码是否写入 Base64 到数据库

结论：当前实现会把 Base64 头像写入数据库。

- 上传头像后，`BasicsForm` 会把 Base64 写入 `resumeData.basics.photoUrl`，同时写入 `localStorage`。
- `resume-store` 在保存时会把完整的 `resumeData` 提交到服务端，并通过 `updateCustomizedResumeAction` 持久化到 `edited_resume_json`。

这与“数据库不存 Base64”的目标冲突，需要在后续改造中彻底切断该写入链路。

### 1.2 本方案核心目标

- 数据库不存 Base64 头像内容。
- 本地编辑阶段仅使用浏览器缓存，头像只对本人可见。
- 头像上传到 Vercel Blob 只在分享场景触发。
- 以 Free Plan 为约束，尽量减少 Blob 资源占用和 API 操作次数。

---

## 2. 方案原则与 Vercel Blob 约束

### 2.1 公开可访问与不可变资源

- Blob URL 默认公开访问，因此路径必须不可猜测。
- 推荐将 Blob 视为不可变对象，使用随机后缀或时间戳生成路径。
- 避免覆盖同一路径，防止缓存不一致。

### 2.2 缓存行为

- 浏览器缓存与 Vercel 缓存默认可达 1 个月。
- 删除或覆盖后，缓存传播可能需要最多 60 秒。
- 如需更短缓存，可在上传时设置 `cacheControlMaxAge`，但最低为 60 秒。

### 2.3 删除与续期的成本判断

- 续期只更新分享有效期（`expireAt`）即可，不建议重新上传头像。
- 关闭分享不做实时删除，交由 Cron Job 统一回收。
- Free Plan 不会限制正常删除与续期操作，但应避免频繁覆盖同 URL。

---

## 3. 分享生命周期策略

### 3.1 分享有效期

去掉永久生效选项，统一使用：

- 3 天（默认）
- 7 天
- 15 天

### 3.2 启用分享

当用户启用分享或自动生成分享链接时：

1. 从本地缓存读取头像（如 `localStorage.user_avatar`）。
2. 若有头像，上传到 Vercel Blob。
3. 将 Blob URL 写入分享记录（建议 `ResumeShare.avatarUrl`）。
4. 设置分享有效期并返回分享链接。

若本地缓存为空，视为用户未上传头像，本次分享无头像即可。

### 3.3 续期

续期时只更新 `expireAt`，不重新上传头像。

理由：

- Blob 视为不可变资源，续期不应触发文件变更。
- 缓存更新与重新上传会增加成本与延迟。

如用户确实更新头像，可在分享开启状态下提供一个“同步头像到分享”按钮，手动触发上传与替换。

若分享已过期且头像已被 Cron 清理，续期时与“新建链接”流程一致：检查本地缓存，有则重新上传，无则保持无头像。

### 3.4 关闭分享

关闭分享时：

- 先设置分享不可访问并更新 `expireAt` 为当前时间。
- 不在关闭时立即删除 Blob，由 Cron Job 统一清理。

这样可以减少在线请求中的删除操作，降低实现复杂度与失败率。

---

## 4. 本地缓存策略

本地编辑场景仅需“自己可见”，因此：

- 使用 `localStorage` 长期缓存即可。
- 不考虑跨浏览器同步。
- 头像大小建议控制在 300KB 内，保证分享时可快速上传。

---

## 5. 统一封装接口

建议封装一个内部模块，屏蔽分享流程与环境差异，避免业务代码感知 Blob 细节。

### 5.1 方法职责建议

- `loadLocalAvatar()` 从本地缓存读取头像
- `saveLocalAvatar(base64)` 写入本地缓存
- `uploadAvatarForShare(base64, userId)` 返回 Blob URL
- `deleteShareAvatar(url)` 删除 Blob URL
- `resolveAvatarForShare()` 统一入口，决定是否上传、是否返回 URL

### 5.2 环境适配原则

- 本地开发：仍写入本地目录并返回可访问路径
- 生产环境：上传至 Vercel Blob 并返回 URL

底层可以复用 `lib/storage/upload.ts` 的环境识别逻辑，避免重复实现。

---

## 6. 数据库写入策略

### 6.1 禁止 Base64 落库

- 在保存 `resumeData` 时清理 `basics.photoUrl`。
- 分享场景下仅在 `ResumeShare` 记录中保存 Blob URL。

### 6.2 分享访问端读取逻辑

- 仅依赖数据库中的 Blob URL。
- 不依赖本地缓存。

---

## 7. 清理机制设计

### 7.1 Cron Job 定期清理

采用 Vercel Cron Job 每天定时执行清理：

- 仅扫描最近 3 到 5 天内过期的分享记录，避免全量扫描。
- 目标条件为 `expireAt` 已过期且存在 `avatarUrl`。
- 对应 Blob 删除后，清空 `ResumeShare.avatarUrl`。

### 7.2 失败缓冲

- 若某天 Cron 失败，回溯 3 到 5 天可以兜底。
- 清理逻辑尽量幂等，避免重复删除报错。

---

## 8. 方案总结

该方案在 Free Plan 约束下实现：

- 数据库零 Base64
- 本地体验不受影响
- 只有分享场景消耗 Blob
- 删除与续期均符合 Vercel Blob 最佳实践

## 9. PRD Setup 指南

### 9.1 申请 Vercel Blob Free Tier

- 进入 Vercel Dashboard → Storage → Create Database → Blob
- 选择 Free Plan 创建 Blob 存储
- 绑定到当前项目（CareerShaper）
- 生成并复制 `BLOB_READ_WRITE_TOKEN`

### 9.2 本项目启用与环境变量配置

- Vercel Project → Settings → Environment Variables
- 配置并保证在 Production/Preview 均可用：
  - `BLOB_READ_WRITE_TOKEN`
  - `CRON_SECRET`
  - `NEXT_PUBLIC_APP_BASE_URL`（生产域名，例如 https://xxx.vercel.app）
- 部署后确认 `@vercel/blob` 可用（生产环境自动走 Blob）

### 9.3 Cron Job 设置

- `vercel.json` 中配置定时任务，指向：
  - `GET /api/cron/cleanup-share-avatars`
- 线上调用需携带 Header：
  - `Authorization: Bearer ${CRON_SECRET}`
- 建议每日凌晨运行，扫描最近 3-5 天过期记录并清理 Blob

### 9.4 上线后 Health Check

- 分享链路检查
  - 新建分享链接后，`resume_shares.avatarUrl` 应写入
  - 访问分享链接，头像请求应返回 200
  - 头像 URL 应为 Blob URL（生产）或 `/uploads/...`（开发）
- Cron Job 检查
  - 直接访问 `/api/cron/cleanup-share-avatars`（带 Authorization）
  - 返回 JSON 中 `success: true`，并记录 `checked/deleted/cleared`
- 过期清理检查
  - 人工将 `expireAt` 设为过去时间，并保留 `avatarUrl`
  - 触发 Cron 后应清空 `avatarUrl` 且 Blob 文件不可访问
