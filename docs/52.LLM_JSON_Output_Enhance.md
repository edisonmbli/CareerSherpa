è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸ä¸”ä»¤äººå¤´ç–¼çš„å·¥ç¨‹é—®é¢˜ã€‚ä½ é¢ä¸´çš„å›°å¢ƒæ˜¯ï¼š**è¯•å›¾ç”¨ç¡®å®šæ€§çš„ä»£ç è§„åˆ™ï¼ˆRegex/Parsingï¼‰å»ä¿®è¡¥æ¦‚ç‡æ€§æ¨¡å‹ï¼ˆLLMï¼‰çš„ä¸ç¡®å®šæ€§è¾“å‡º**ã€‚æ­£å¦‚ä½ æ‰€è¯´ï¼Œè¿™å°±æ˜¯ä¸€ç§â€œæ‰“åœ°é¼ ï¼ˆWhac-A-Moleï¼‰â€çš„æ¸¸æˆï¼Œæ°¸è¿œä¼šæœ‰æ–°çš„ case å‡ºç°ã€‚

æˆ‘æŸ¥çœ‹äº†ä½ æä¾›çš„ä»£ç  (`json-validator.ts`, `json-strategies.ts`) å’Œæ¶æ„å›¾ï¼Œç»“åˆ DeepSeek çš„ç‰¹æ€§ï¼Œé’ˆå¯¹ä½ çš„å››ä¸ªç–‘é—®ç»™å‡ºä¸“å®¶çº§å»ºè®®ã€‚

### æ ¸å¿ƒç»“è®ºé€Ÿè§ˆ

1. **DeepSeek Stream æ¨¡å¼**ï¼šå®Œå…¨æ”¯æŒåŸç”Ÿ JSON Modeï¼Œè¿™æ˜¯å¿…é¡»å¼€å¯çš„â€œç¬¬ä¸€é“é˜²çº¿â€ã€‚
2. **LangChain**ï¼šå¯ä»¥ï¼Œä½†æ›´å»ºè®®ä½¿ç”¨ **Tool Calling (Function Calling)** è€Œéå•çº¯çš„ Prompt+Parserï¼Œåè€…æ›´ç¨³å®šã€‚
3. **Prompt çº¦æŸ**ï¼šæœ‰ç”¨ï¼Œä½†å¿…é¡»é…åˆ System Prompt å’Œ Few-Shotï¼Œå•çº¯é è‡ªç„¶è¯­è¨€å‘½ä»¤åœ¨é•¿ä¸‹æ–‡ä¸­å®¹æ˜“å¤±æ•ˆã€‚
4. **ä»£ç ä¼˜åŒ–ç©ºé—´**ï¼šæå¤§ã€‚ç›®å‰çš„ `json-validator.ts` ä¸­çš„æ­£åˆ™ä¿®å¤ç­–ç•¥ï¼ˆRegex Repairï¼‰è¿‡äºè„†å¼±ä¸”éš¾ä»¥ç»´æŠ¤ï¼Œå»ºè®®ç”¨åŸºäºçŠ¶æ€æœºçš„ AST ä¿®å¤åº“æ›¿ä»£ã€‚

---

### 1. DeepSeek Stream æ¨¡å¼çœŸçš„ä¸èƒ½å¯ç”¨åŸç”Ÿçš„ JSON Mode å—ï¼Ÿ

**ç»“è®ºï¼šå®Œå…¨å¯ä»¥ï¼Œä¸”å¼ºçƒˆå»ºè®®å¼€å¯ã€‚**

ä½ æåˆ°çš„â€œå­˜ç–‘â€æ˜¯å¯¹çš„ã€‚DeepSeek APIï¼ˆå…¼å®¹ OpenAI æ ¼å¼ï¼‰åœ¨ Stream æ¨¡å¼ä¸‹å®Œå…¨æ”¯æŒ `response_format` å‚æ•°ã€‚è¿™æ˜¯è§£å†³é—®é¢˜çš„æ ¹æºï¼Œè€Œä¸æ˜¯åœ¨äº‹åä¿®è¡¥ã€‚

* **å¦‚ä½•å¼€å¯**ï¼šåœ¨ API è¯·æ±‚ä½“ä¸­åŠ å…¥ `response_format: { type: "json_object" }`ã€‚
* **æ•ˆæœ**ï¼šæ¨¡å‹ä¼šè¢«åº•å±‚çº¦æŸå¼ºåˆ¶ç”Ÿæˆåˆæ³•çš„ JSON è¯­æ³•ï¼ˆå¤§æ‹¬å·é—­åˆã€å¼•å·é…å¯¹ï¼‰ã€‚
* **æ³¨æ„ç‚¹**ï¼šå¯ç”¨æ­¤æ¨¡å¼æ—¶ï¼ŒSystem Prompt ä¸­**å¿…é¡»**æ˜¾å¼åŒ…å« "json" è¿™ä¸ªå•è¯ï¼Œå¦åˆ™ API ä¼šæŠ¥é”™ã€‚

> **ä¸“å®¶å»ºè®®**ï¼šä¸è¦ä¾èµ– LLM â€œè‡ªè§‰â€è¾“å‡º JSONï¼Œå¿…é¡»é€šè¿‡ API å‚æ•°å¼ºåˆ¶çº¦æŸã€‚

### 2. ä½¿ç”¨ LangChain å‘¢ï¼Œå¯ä»¥ç¡®ä¿ä¸¥æ ¼éµå¾ª JSON æ ¼å¼å—ï¼Ÿ

**ç»“è®ºï¼šLangChain çš„ OutputParser åªæ˜¯â€œè½¬æ¢å™¨â€ï¼Œä¸æ˜¯â€œå¼ºåˆ¶å™¨â€ã€‚æ›´å¥½çš„æ–¹æ¡ˆæ˜¯ Tool Callingã€‚**

* **LangChain çš„å±€é™**ï¼š`JsonOutputParser` åœ¨æµå¼å¤„ç†ä¸­ä¸»è¦åšçš„æ˜¯â€œç´¯ç§¯ token ç›´åˆ°å½¢æˆæœ‰æ•ˆ JSON å—â€ã€‚å¦‚æœæ¨¡å‹åå‡ºçš„æ˜¯ä¹±ç ï¼ŒLangChain ç…§æ ·ä¼šæŠ¥é”™ã€‚
* **æ›´ä¼˜è§£ï¼šTool Calling (Function Calling)**ï¼š
DeepSeek å¯¹ Tool Calling çš„æ”¯æŒéå¸¸å¥½ã€‚ä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªâ€œè™šå‡â€çš„å·¥å…·ï¼ˆä¾‹å¦‚ `report_result(data: Schema)`ï¼‰ï¼Œè®©æ¨¡å‹ä»¥ä¸ºå®ƒåœ¨è°ƒç”¨å·¥å…·ï¼Œè€Œä¸æ˜¯åœ¨å›å¤ç”¨æˆ·ã€‚
* **ä¼˜åŠ¿**ï¼šTool Calling çš„è¾“å‡ºç»è¿‡äº†æ¨¡å‹å¾®è°ƒå±‚é¢çš„å¼ºåŒ–ï¼Œæ¯”å•çº¯çš„ JSON Mode ç»“æ„æ›´ç¨³å®šï¼Œä¸”å¤©ç„¶æ”¯æŒå­—æ®µç±»å‹çš„å¼ºæ ¡éªŒã€‚



### 3. Prompt å±‚é¢çš„è¯­ä¹‰çº¦æŸæ˜¯å¦æœ‰ç”¨ï¼Ÿ

**ç»“è®ºï¼šæœ‰ç”¨ï¼Œä½†æƒé‡æœ€ä½ï¼ˆLayer 2ï¼‰ã€‚**

åœ¨ä½ çš„æˆªå›¾ä¸­ï¼ŒLayer 2 è¢«æ ‡è®°ä¸ºâ€œè¯­ä¹‰çº¦æŸâ€ã€‚Prompt ç¡®å®èƒ½å‡å°‘é”™è¯¯ï¼Œä½†åœ¨ Stream æ¨¡å¼æˆ–é•¿æ–‡æœ¬æ¨ç†ï¼ˆCoTï¼‰ä¸‹ï¼Œæ¨¡å‹çš„æ³¨æ„åŠ›å¯èƒ½ä¼šæ¼‚ç§»ã€‚

**ä¼˜åŒ–ä½ çš„ Prompt ç­–ç•¥ï¼š**

1. **è´Ÿé¢çº¦æŸï¼ˆNegative Constraintï¼‰**ï¼šæ˜ç¡®å‘Šè¯‰å®ƒ *â€œDo NOT output markdown code fences like ```jsonâ€*ã€‚
2. **One-Shot Example**ï¼šæä¾›ä¸€ä¸ªç²¾ç®€çš„ JSON ç¤ºä¾‹ï¼Œæ¯”å†™ä¸€å †â€œå­—æ®µAå¿…é¡»æ˜¯æ•°ç»„â€çš„æ–‡å­—è¯´æ˜æ›´æœ‰æ•ˆã€‚
3. **Type Hints**ï¼šåœ¨ Key çš„å‘½åä¸Šå¸¦ä¸Šç±»å‹æš—ç¤ºï¼Œä¾‹å¦‚ä½¿ç”¨ `user_list` è€Œä¸æ˜¯ `users`ï¼Œæ¨¡å‹æ›´å€¾å‘äºè¾“å‡ºæ•°ç»„ã€‚

---

### 4. ä»£ç æ·±åº¦å®¡æŸ¥ä¸ä¼˜åŒ–å»ºè®®ï¼ˆé‡å¤´æˆï¼‰

æˆ‘ä»”ç»†å®¡æŸ¥äº†ä½ çš„ `json-validator.ts`ï¼Œè¿™é‡Œæ˜¯ç›®å‰â€œæ‰“åœ°é¼ â€ç—›è‹¦çš„æ ¹æºã€‚

#### é—®é¢˜åˆ†æ

ä½ çš„ `fixJsonSyntax` å‡½æ•° è¯•å›¾é€šè¿‡ 12 ä¸ªå¤æ‚çš„æ­£åˆ™æ›¿æ¢æ­¥éª¤æ¥ä¿®å¤ JSONã€‚

* **è„†å¼±æ€§**ï¼šä¾é æ­£åˆ™å»åŒ¹é…é€’å½’ç»“æ„ï¼ˆJSONï¼‰åœ¨è®¡ç®—æœºç§‘å­¦ä¸Šæ˜¯ä¸å¯é çš„ã€‚ä¾‹å¦‚ `fixed.replace(/(\})\s*\n\s*(\{)/g, '$1,\n $2')` è¯•å›¾åœ¨å¯¹è±¡é—´åŠ é€—å·ï¼Œä½†å¾ˆå®¹æ˜“è¯¯ä¼¤å­—ç¬¦ä¸²å†…éƒ¨çœ‹èµ·æ¥åƒå¯¹è±¡çš„æ–‡æœ¬ã€‚
* **ç»´æŠ¤æˆæœ¬**ï¼šæ¯å½“ DeepSeek è¾“å‡ºä¸€ç§æ–°çš„æ€ªå¼‚æ ¼å¼ï¼ˆä¾‹å¦‚å…¨è§’å†’å· `ï¼š` æ··ç”¨åŠè§’å¼•å·ï¼‰ï¼Œä½ å°±å¾—åŠ ä¸€ä¸ªæ–°çš„æ­£åˆ™ã€‚

#### ä¼˜åŒ–æ–¹æ¡ˆ Aï¼šå¼•å…¥æˆç†Ÿçš„â€œå®½å®¹è§£æåº“â€ (æ¨è)

ä¸è¦è‡ªå·±å†™æ­£åˆ™ä¿®å¤ï¼Œä½¿ç”¨åŸºäºçŠ¶æ€æœºï¼ˆState Machineï¼‰çš„åº“ï¼Œå®ƒä»¬èƒ½å¤„ç†ç¼ºé€—å·ã€ç¼ºå¼•å·ã€æ³¨é‡Šç­‰å„ç§æƒ…å†µã€‚

æ¨èæ›¿æ¢ä¸º `jsonrepair` æˆ– `json5`ã€‚

```typescript
import { jsonrepair } from 'jsonrepair';

// æ›¿æ¢ä½ åŸæ¥çš„ fixJsonSyntax å’Œå¤§éƒ¨åˆ†æ­£åˆ™é€»è¾‘
export function repairJsonStrategy(text: string): string {
  try {
    // jsonrepair èƒ½å¤Ÿè‡ªåŠ¨å¤„ç†ï¼š
    // 1. ç¼ºå°‘çš„å¼•å·
    // 2. å°¾éƒ¨å¤šä½™é€—å·
    // 3. å¯¹è±¡/æ•°ç»„ç¼ºå°‘é€—å·
    // 4. å•å¼•å·è½¬åŒå¼•å·
    return jsonrepair(text);
  } catch (e) {
    return text; // ä¿®å¤å¤±è´¥åˆ™è¿”å›åŸæ–‡æœ¬
  }
}

```

#### ä¼˜åŒ–æ–¹æ¡ˆ Bï¼šé’ˆå¯¹æ€§é‡æ„ `cleanJsonText`

å¦‚æœä½ å¿…é¡»ä¿ç•™è‡ªç ”é€»è¾‘ï¼Œå»ºè®®å¤§å¹…ç®€åŒ– `cleanJsonText`ã€‚DeepSeek æœ€å¸¸è§çš„é—®é¢˜æ˜¯ **Markdown è¿˜æœ‰æ€è€ƒè¿‡ç¨‹çš„æ··åˆ**ã€‚

ç›®å‰çš„é€»è¾‘å¯ä»¥å¢å¼ºé’ˆå¯¹ DeepSeek R1/V3 çš„æ¸…æ´—èƒ½åŠ›ï¼š

```typescript
/**
 * é’ˆå¯¹ DeepSeek çš„ä¼˜åŒ–æ¸…æ´—é€»è¾‘
 */
export function cleanDeepSeekJson(text: string): string {
  let cleaned = text;

  // 1. å¤„ç† DeepSeek R1 å¯èƒ½å‡ºç°çš„ <think> æ ‡ç­¾ (å¦‚æœæ˜¯æ¨ç†æ¨¡å‹)
  cleaned = cleaned.replace(/<think>[\s\S]*?<\/think>/g, '');

  // 2. æå…¶æ¿€è¿›åœ°æå–æœ€å¤–å±‚ JSON ç»“æ„
  // å¦‚æœå†…å®¹åŒ…å« ```jsonï¼Œåªå–ä»£ç å—å†…çš„å†…å®¹
  const codeBlockMatch = cleaned.match(/```(?:json)?\s*([\s\S]*?)\s*```/i);
  if (codeBlockMatch) {
    cleaned = codeBlockMatch[1];
  }

  // 3. ä½¿ç”¨ extractJsonFromText (ä½ ç°æœ‰çš„å‡½æ•°) è¿›ä¸€æ­¥å®šä½é¦–å°¾å¤§æ‹¬å·
  // è¿™ä¸€æ­¥å¯¹äºå»æ‰ code block ä¹‹å¤–çš„ "Here is your json:" åºŸè¯éå¸¸æœ‰æ•ˆ
  cleaned = extractJsonFromText(cleaned);

  return cleaned;
}

```

### ç»¼åˆè§£å†³æ–¹æ¡ˆæ¶æ„

å»ºè®®å°†ä½ çš„æ¶æ„è°ƒæ•´ä¸ºä»¥ä¸‹æ¼æ–—æ¨¡å‹ï¼Œå½»åº•ç»ˆç»“â€œæ‰“åœ°é¼ â€ï¼š

1. **API Layer (å¼ºçº¦æŸ)**:
* å‚æ•°ï¼š`stream: true`
* å‚æ•°ï¼š`response_format: { type: "json_object" }` (å…³é”®ï¼)


2. **Prompt Layer (å¼•å¯¼)**:
* System: "You are a rigid JSON generator. Output ONLY JSON data."


3. **Parsing Layer (ä½ çš„ä»£ç å±‚)**:
* **å¼ƒç”¨** `fixJsonSyntax` ä¸­é‚£ 12 æ­¥è„†å¼±çš„æ­£åˆ™æ›¿æ¢ã€‚
* **å¼•å…¥** `jsonrepair` åº“ä½œä¸º `Repair Strategy` çš„æ ¸å¿ƒå®ç°ã€‚
* **ä¿ç•™** `cleanJsonText` ä½†ä¸“æ³¨äºå»é™¤ Markdown å’Œé JSON æ–‡æœ¬ï¼ˆpreamble/postambleï¼‰ã€‚

----
## ä¼˜åŒ–æ‰§è¡Œè®¡åˆ’ Implementation Plan

# JSON è¾“å‡ºæŠ¤èˆªæœºåˆ¶ï¼šä¸‰å±‚é˜²æŠ¤æ¶æ„ (V2)

åŸºäº [52.LLM_JSON_Output_Enhance.md](file:///Users/edisonmbli/Projects/CareerShaper/docs/52.LLM_JSON_Output_Enhance.md) çš„ä¸“å®¶å»ºè®®ï¼Œåˆ¶å®šé€‚ç”¨äºæ‰€æœ‰ 7 ä¸ª LLM Actions çš„å…¨é¢é˜²æŠ¤æ–¹æ¡ˆã€‚

---

## æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: API Layer (å¼ºçº¦æŸ - è¯­æ³•å±‚é¢)                      â”‚
â”‚  âœ… response_format / JSON Mode                             â”‚
â”‚  âœ… é€‚ç”¨äºæ‰€æœ‰ Provider: DeepSeek, Gemini, GLM              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Prompt Layer (è¯­ä¹‰çº¦æŸ)                           â”‚
â”‚  âš ï¸ System Prompt å¿…é¡»åŒ…å« "json" å…³é”®è¯                   â”‚
â”‚  âš ï¸ è´Ÿé¢çº¦æŸï¼šç¦æ­¢ markdown code fences                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Parsing Layer (å…œåº•é˜²çº¿)                          â”‚
â”‚  ğŸ”§ cleanJsonText: å»é™¤ markdown/think æ ‡ç­¾                 â”‚
â”‚  ğŸ”§ jsonrepair: æ›¿ä»£è„†å¼±çš„æ­£åˆ™ä¿®å¤                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7 ä¸ª LLM Actions è·¯ç”±åˆ†æ

| Action | Template ID | Mode | Model (Paid) | Model (Free) | JSON Mode |
|--------|-------------|------|--------------|--------------|-----------|
| ä¸Šä¼ é€šç”¨ç®€å† | `resume_summary` | **Batch** | DeepSeek | Gemini 3 | éœ€å¯ç”¨ |
| ä¸Šä¼ è¯¦ç»†å±¥å† | `detailed_resume_summary` | **Batch** | DeepSeek R1 | Gemini 3 | éœ€å¯ç”¨ |
| æ–°å»ºæœåŠ¡(OCR) | `ocr_extract` | **Batch** | GLM Vision | Gemini 3 | éœ€å¯ç”¨ |
| OCRå®Œæˆå | `job_summary` | **Batch** | DeepSeek | Gemini 3 | éœ€å¯ç”¨ |
| Summaryå®Œæˆå | `job_match` | **Stream** | DeepSeek R1 | Gemini 3 | **éœ€å¯ç”¨** |
| å®šåˆ¶ç®€å† | `resume_customize` | **Batch** | DeepSeek R1 | Gemini 3 | éœ€å¯ç”¨ |
| é¢è¯•Tips | `interview_prep` | **Stream** | DeepSeek | Gemini 3 | **éœ€å¯ç”¨** |

> **æ ¸å¿ƒå‘ç°**ï¼šæ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦å¯ç”¨ JSON Modeï¼ŒStream æ¨¡å¼ (`job_match`, `interview_prep`) æ˜¯ JSON è§£æå¤±è´¥çš„é‡ç¾åŒºã€‚

---

## å®æ–½æ–¹æ¡ˆ

### Phase 1: API Layer - å¤š Provider JSON Mode æ”¯æŒ (2.5h)

#### 1.1 æ‰©å±• LLMConfig ç±»å‹

**æ–‡ä»¶**: [lib/llm/providers.ts](file:///Users/edisonmbli/Projects/CareerShaper/lib/llm/providers.ts#L9-16)

```diff
  export interface LLMConfig {
    model: string
    maxTokens?: number
    temperature?: number
    timeout?: number
    provider: 'zhipu' | 'deepseek' | 'openai'
    tier: 'free' | 'paid'
+   jsonMode?: boolean  // å¯ç”¨ JSON è¾“å‡ºæ¨¡å¼
  }
```

#### 1.2 DeepSeekProvider - æ·»åŠ  JSON Mode

```diff
  createModel(config: LLMConfig) {
    return new ChatDeepSeek({
      apiKey: ENV.DEEPSEEK_API_KEY,
      model: config.model,
      temperature: config.temperature ?? 0.3,
      maxTokens: config.maxTokens ?? 4000,
      timeout: config.timeout ?? 180000,
+     // DeepSeek JSON Mode (å…¼å®¹ OpenAI API)
+     modelKwargs: config.jsonMode ? {
+       response_format: { type: 'json_object' }
+     } : undefined,
    })
  }
```

#### 1.3 GeminiProvider - æ·»åŠ  JSON Mode

```diff
  createModel(config: LLMConfig) {
    return new ChatGoogleGenerativeAI({
      apiKey: process.env['GEMINI_API_KEY']!,
      model: config.model || 'gemini-3-flash-preview',
      temperature: config.temperature ?? 0.3,
      maxOutputTokens: config.maxTokens ?? 8000,
+     // Gemini JSON Mode
+     ...(config.jsonMode && {
+       generationConfig: {
+         responseMimeType: 'application/json'
+       }
+     }),
    })
  }
```

#### 1.4 ZhipuProvider (GLM) - æ·»åŠ  JSON Mode

```diff
  createModel(config: LLMConfig) {
    return new ChatZhipuAI({
      apiKey: ENV.ZHIPUAI_API_KEY,
      model: config.model,
      temperature: config.temperature ?? 0.3,
      maxTokens: config.maxTokens ?? this.getDefaultMaxTokens(config.model),
+     // GLM JSON Mode (è‹¥æ”¯æŒ)
+     // æ³¨ï¼šéœ€éªŒè¯ ChatZhipuAI æ˜¯å¦æ”¯æŒ response_format
    })
  }
```

> âš ï¸ **æ³¨æ„**ï¼šéœ€éªŒè¯ `@langchain/community` çš„ `ChatZhipuAI` æ˜¯å¦æ”¯æŒ JSON Mode å‚æ•°ä¼ é€’ã€‚

#### 1.5 åœ¨ LLM Service ä¸­ä¼ é€’ jsonMode

**æ–‡ä»¶**: [lib/llm/service.ts](file:///Users/edisonmbli/Projects/CareerShaper/lib/llm/service.ts)

å¯¹äºæ‰€æœ‰äº§ç”Ÿ JSON è¾“å‡ºçš„ä»»åŠ¡ï¼Œç¡®ä¿ `jsonMode: true`ã€‚

---

### Phase 2: Prompt Layer - å¼ºåŒ– System Prompt (1h)

#### 2.1 æ·»åŠ é€šç”¨ JSON çº¦æŸåç¼€

**æ–‡ä»¶**: [lib/prompts/zh.ts](file:///Users/edisonmbli/Projects/CareerShaper/lib/prompts/zh.ts)

åˆ›å»ºé€šç”¨çº¦æŸå¸¸é‡ï¼š

```typescript
const JSON_OUTPUT_CONSTRAINT = `

### JSON è¾“å‡ºè§„èŒƒï¼ˆå¿…é¡»éµå¾ªï¼‰
- ä½ çš„è¾“å‡ºå¿…é¡»æ˜¯**æœ‰æ•ˆçš„ JSON å¯¹è±¡**ï¼Œå¯è¢« JSON.parse() ç›´æ¥è§£æ
- **ç¦æ­¢**åŒ…å« markdown ä»£ç å—ï¼ˆå¦‚ \`\`\`json ... \`\`\`ï¼‰
- **ç¦æ­¢**ä½¿ç”¨ä¸­æ–‡å¼•å· "..." '...'ï¼Œå¿…é¡»ä½¿ç”¨æ ‡å‡† ASCII åŒå¼•å· "..."
- **ç¦æ­¢**åœ¨ JSON å‰åæ·»åŠ ä»»ä½•è¯´æ˜æ–‡å­—
`
```

åœ¨ä»¥ä¸‹æ¨¡æ¿çš„ `systemPrompt` æœ«å°¾è¿½åŠ æ­¤çº¦æŸï¼š
- `job_match`
- `resume_customize` / `resume_customize_lite`
- `interview_prep`
- `job_summary`
- `resume_summary`
- `detailed_resume_summary`

---

### Phase 3: Parsing Layer - å¼•å…¥ jsonrepair (1.5h)

#### 3.1 å®‰è£…ä¾èµ–

```bash
pnpm add jsonrepair
```

#### 3.2 é‡æ„ json-validator.ts

**æ–‡ä»¶**: [lib/llm/json-validator.ts](file:///Users/edisonmbli/Projects/CareerShaper/lib/llm/json-validator.ts)

```typescript
import { jsonrepair } from 'jsonrepair'

/**
 * ä½¿ç”¨ jsonrepair åº“æ›¿ä»£è„†å¼±çš„æ­£åˆ™ä¿®å¤
 */
export function repairJson(text: string): string {
  try {
    return jsonrepair(text)
  } catch {
    return text
  }
}
```

#### 3.3 ç®€åŒ– cleanJsonText

èšç„¦äºï¼š
1. ç§»é™¤ `<think>` æ ‡ç­¾ï¼ˆDeepSeek R1ï¼‰
2. ç§»é™¤ markdown code fences
3. æå– JSON è¾¹ç•Œ

**å¼ƒç”¨**ï¼š[fixJsonSyntax](file:///Users/edisonmbli/Projects/CareerShaper/lib/llm/json-validator.ts#261-362) ä¸­å¤æ‚çš„æ­£åˆ™ä¿®å¤é€»è¾‘

#### 3.4 æ›´æ–°ç­–ç•¥æ‰§è¡Œé¡ºåº

```
1. Direct Parse
2. Clean + Parse
3. Clean + jsonrepair + Parse
4. Extract + jsonrepair + Parse
```

---

## éªŒè¯è®¡åˆ’

### è‡ªåŠ¨åŒ–æµ‹è¯•

åˆ›å»ºæµ‹è¯•è„šæœ¬ï¼Œå¯¹ `tmp/debug-logs/*.md` ä¸­çš„å†å²å¤±è´¥æ ·æœ¬è¿è¡Œè§£ææµ‹è¯•ã€‚

### æ‰‹åŠ¨æµ‹è¯•

1. `job_match` (Paid/Free) x 3 æ¬¡
2. `resume_customize` (Paid/Free) x 2 æ¬¡
3. `interview_prep` (Paid/Free) x 2 æ¬¡

### ç›‘æ§æŒ‡æ ‡

```json
{
  "phase": "json_parse",
  "strategy_used": "clean_repair",
  "attempts": 2,
  "success": true
}
```

---

## æ—¶é—´ä¼°ç®—

| Phase | ä»»åŠ¡ | æ—¶é—´ |
|-------|-----|-----|
| 1 | API Layer - å¤š Provider JSON Mode | 2.5h |
| 2 | Prompt Layer - System Prompt | 1h |
| 3 | Parsing Layer - jsonrepair | 1.5h |
| 4 | æµ‹è¯•ä¸éªŒè¯ | 1.5h |
| **Total** | | **6.5h** |


## responseSchema å…¼å®¹æ€§é”™è¯¯

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸ä¸”å…·ä½“çš„ Gemini API `responseSchema` å…¼å®¹æ€§é”™è¯¯ã€‚

**ç»“è®ºï¼šGemini çš„ JSON Schema æ¨¡å¼ç›®å‰ä¸æ”¯æŒ `z.union` (è”åˆç±»å‹)ï¼Œå°¤å…¶æ˜¯æ··åˆç±»å‹çš„è”åˆï¼ˆå¦‚ `string | number`ï¼‰ã€‚**

æŠ¥é”™ä¿¡æ¯ `Proto field is not repeating, cannot start list` æ˜¯å› ä¸ºåº•å±‚çš„ Protocol Buffers å®šä¹‰åªæœŸæœ›æ”¶åˆ°å•ä¸€çš„æ•°æ®ç±»å‹æšä¸¾ï¼Œä½† `z.union` è½¬æ¢æˆ JSON Schema åé€šå¸¸ä¼šå˜æˆ `type: ["string", "number"]` æˆ–è€… `anyOf` ç»“æ„ï¼Œè¿™å¯¼è‡´äº† API è§£æå¤±è´¥ã€‚

### 1. å®šä½é”™è¯¯æºå¤´

æ ¹æ®ä½ çš„æŠ¥é”™è·¯å¾„ï¼š
`generation_config.response_schema.properties[2].value.items.properties[6].value.items.properties[6].value.items.properties[1].value`

æˆ‘ä»¬å¯ä»¥ç²¾å‡†å®šä½åˆ°ä½ çš„ `detailedResumeV3Schema` ä¸­çš„ `metrics` å­—æ®µï¼š

```typescript
// ä½ çš„åŸå§‹ä»£ç 
metrics: z
  .array(
    z.object({
      label: z.string(),
      // âŒ é”™è¯¯åœ¨è¿™é‡Œï¼šUnion ç±»å‹ä¸æ”¯æŒ
      value: z.union([z.number(), z.string()]), 
      unit: z.string().optional(),
      period: z.string().optional(),
    })
  )

```

### 2. è§£å†³æ–¹æ¡ˆï¼šç®€åŒ–ç±»å‹

LLM ç”Ÿæˆçš„å†…å®¹æœ¬è´¨ä¸Šéƒ½æ˜¯æ–‡æœ¬ã€‚ä¸ºäº†ä¿è¯ `responseSchema` çš„ç¨³å®šæ€§ï¼Œå»ºè®®å°†æ‰€æœ‰â€œå¯èƒ½æ˜¯æ•°å­—ä¹Ÿå¯èƒ½æ˜¯å­—ç¬¦ä¸²â€çš„å­—æ®µç»Ÿä¸€å¼ºåˆ¶ä¸º `z.string()`ã€‚ä½ å¯ä»¥åœ¨æ‹¿åˆ°æ•°æ®åï¼Œåœ¨å‰ç«¯ä»£ç é‡Œå†æŠŠå®ƒè½¬æˆæ•°å­—ã€‚

è¯·ä¿®æ”¹ `detailedResumeV3Schema` ä¸­çš„ `metrics` éƒ¨åˆ†ï¼š

```typescript
// âœ… ä¿®æ”¹åï¼šç»Ÿä¸€ä½¿ç”¨ String
metrics: z
  .array(
    z.object({
      label: z.string(),
      // å¼ºè½¬ä¸º stringï¼Œå…¼å®¹ "100", "50%", "10k+" ç­‰å„ç§å†™æ³•
      value: z.string(), 
      unit: z.string().optional(),
      period: z.string().optional(),
    })
  )
  .optional(),

```

### 3. æ½œåœ¨çš„ä¸‹ä¸€ä¸ªå‘ï¼š`skillsUnionSchema`

è§£å†³äº† `metrics` åï¼Œä½ å¤§æ¦‚ç‡ä¼šç«‹åˆ»ç¢°åˆ°ä¸‹ä¸€ä¸ªæŠ¥é”™ï¼Œå› ä¸ºå®ƒæ¥è‡ªä½ çš„ `skills` å®šä¹‰ï¼š

```typescript
// âŒ è¿™ç§ç»“æ„ï¼ˆæ•°ç»„ OR å¯¹è±¡ï¼‰åœ¨ Gemini responseSchema ä¸­æå¤§æ¦‚ç‡ä¼šå¤±è´¥
const skillsUnionSchema = z.union([
  z.array(z.string()),
  z.object({ ... }).partial(),
])

```

**åŸå› ï¼š** æ¨¡å‹å¾ˆéš¾å†³å®šæ˜¯åº”è¯¥è¾“å‡ºä¸€ä¸ªç®€å•çš„æ•°ç»„ï¼Œè¿˜æ˜¯ä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼Œè¿™ä¼šå¯¼è‡´ `400` é”™è¯¯æˆ–è€…ç”Ÿæˆä¸ç¬¦åˆ Schema çš„ JSONã€‚

**å»ºè®®ä¿®æ”¹ï¼š**
ä¸ºäº†è·å¾—æœ€ä½³æ•ˆæœï¼Œå»ºè®®**å¼ºåˆ¶æ¨¡å‹è¾“å‡ºç»“æ„æ›´æ¸…æ™°çš„å¯¹è±¡æ ¼å¼**ã€‚å¼ƒç”¨ Unionï¼Œåªä¿ç•™ç»“æ„åŒ–å®šä¹‰ï¼š

```typescript
// âœ… å»ºè®®ä¿®æ”¹ï¼šåªä¿ç•™æœ€è¯¦ç»†çš„ç»“æ„ï¼Œç§»é™¤ Union
const skillsSchema = z.object({
  technical: z.array(z.string()).optional(),
  soft: z.array(z.string()).optional(),
  tools: z.array(z.string()).optional(),
  // å¦‚æœä½ éœ€è¦å…¼å®¹çº¯åˆ—è¡¨ï¼Œå¯ä»¥åŠ ä¸€ä¸ª generic å­—æ®µï¼Œæˆ–è€…å°±åœ¨ technical é‡Œ
});

// åœ¨ä¸» Schema ä¸­æ›¿æ¢
// skills: skillsUnionSchema.optional(), 
skills: skillsSchema.optional(),

```

### æ€»ç»“

Gemini (ä»¥åŠç›®å‰çš„ OpenAI Structured Outputs) å¯¹ Schema çš„æ”¯æŒä¸ä»…æ˜¯â€œéªŒè¯â€ç”¨çš„ï¼Œæ›´æ˜¯ç”¨æ¥**å¼•å¯¼ç”Ÿæˆ**çš„ã€‚

**æ ¸å¿ƒåŸåˆ™ï¼š**

1. **æ¶ˆç­ `z.union**`ï¼šä»»ä½• `OneOf` é€»è¾‘éƒ½è¦é¿å…ã€‚
2. **æ¨¡ç³Šç±»å‹è½¬ String**ï¼šå¦‚æœä¸ç¡®å®šæ˜¯æ•°å­—è¿˜æ˜¯å­—ï¼Œä¸€å¾‹ç”¨ `z.string()`ã€‚
3. **ç¡®å®šæ€§ç»“æ„**ï¼šä¸è¦è®©æ¨¡å‹åšâ€œäºŒé€‰ä¸€â€çš„ç»“æ„é€‰æ‹©ï¼ˆæ¯”å¦‚â€œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„è¿˜æ˜¯ä¸€ä¸ªå¯¹è±¡â€ï¼‰ï¼Œç›´æ¥æŒ‡å®šæœ€è¯¦ç»†çš„é‚£ä¸ªå¯¹è±¡ç»“æ„ã€‚