# 67. æ—¥å¿—ç³»ç»Ÿè¿ç§»æŒ‡å— (Logging Migration Guide)

## 1. èƒŒæ™¯ä¸ç›®æ ‡

ä¸ºäº†ç»Ÿä¸€ç®¡ç† Next.js ä¸»åº”ç”¨ä¸ Hono Worker åå°æœåŠ¡çš„æ—¥å¿—ï¼Œå¹¶å®ç°ç”Ÿäº§ç¯å¢ƒçš„å¼‚å¸¸ç›‘æ§ï¼Œæœ¬é¡¹ç›®å¼•å…¥äº† **Sentry** ä½œä¸ºæ ‡å‡†çš„æ—¥å¿—ä¸é”™è¯¯è¿½è¸ªå¹³å°ã€‚

**ä¸»è¦å˜æ›´ï¼š**
- å¼•å…¥ `@sentry/nextjs` (Frontend/API) å’Œ `@sentry/node` (Worker)ã€‚
- æ”¹é€  `lib/logger.ts`ï¼Œä½¿å…¶è‡ªåŠ¨å°†é”™è¯¯ä¸ŠæŠ¥è‡³ Sentryã€‚
- è§„èŒƒåŒ–æ—¥å¿—è®°å½•æ–¹å¼ï¼ŒåºŸå¼ƒæ•£è½åœ¨ä»£ç ä¸­çš„ `console.log/error`ã€‚

## 2. æ¶æ„æ¦‚è§ˆ

### Next.js åº”ç”¨ (Vercel)
- **å®¢æˆ·ç«¯**: è‡ªåŠ¨æ•è· React é”™è¯¯è¾¹ç•Œã€æœªå¤„ç†çš„ Promise Rejectionã€‚
- **æœåŠ¡ç«¯ (API/RSC)**: é€šè¿‡ `sentry.server.config.ts` å’Œ `sentry.edge.config.ts` è‡ªåŠ¨æ•è·å¼‚å¸¸ã€‚
- **é…ç½®**: `next.config.ts` å·²é›†æˆ Sentry Webpack æ’ä»¶ï¼ˆç”¨äºä¸Šä¼  Source Mapsï¼‰ã€‚

### Hono Worker (VPS)
- **è¿è¡Œæ—¶**: Node.jsã€‚
- **é›†æˆ**: åœ¨ `worker/src/index.ts` ä¸­åˆå§‹åŒ– Sentry Node SDKã€‚
- **é”™è¯¯æ•è·**: å…¨å±€ `onError` ä¸­é—´ä»¶è‡ªåŠ¨ä¸ŠæŠ¥æœªæ•è·å¼‚å¸¸ï¼›å…³é”®ä¸šåŠ¡é€»è¾‘é€šè¿‡ `logError` æ‰‹åŠ¨ä¸ŠæŠ¥ã€‚

## 3. å¼€å‘æŒ‡å— (Best Practices)

### 3.1 å¦‚ä½•è®°å½•æ—¥å¿—

**æ¨èæ–¹å¼**ï¼šå§‹ç»ˆä½¿ç”¨ `lib/logger.ts` æä¾›çš„å·¥å…·å‡½æ•°ã€‚

```typescript
import { logInfo, logError } from '@/lib/logger'

// âœ… æ­£ç¡®ï¼šè®°å½•æ™®é€šä¿¡æ¯ (å¼€å‘ç¯å¢ƒ Consoleï¼Œç”Ÿäº§ç¯å¢ƒ Breadcrumb)
logInfo({
  reqId: 'req_123',
  route: 'api/test',
  message: 'Worker started processing',
  data: { jobId: '123' }
})

// âœ… æ­£ç¡®ï¼šè®°å½•é”™è¯¯ (è‡ªåŠ¨ä¸ŠæŠ¥ Sentry + Console)
try {
  await doSomething()
} catch (err) {
  logError({
    reqId: 'req_123',
    route: 'api/test',
    error: err, // ğŸ‘ˆ åŠ¡å¿…ä¼ å…¥åŸå§‹ Error å¯¹è±¡ï¼Œä»¥ä¿ç•™å †æ ˆä¿¡æ¯
    phase: 'db_transaction',
    context: { userId: 'u_1' } // é¢å¤–ä¸Šä¸‹æ–‡
  })
}
```

**ğŸš« é¿å…æ–¹å¼**ï¼š
- `console.log('here')`ï¼šæäº¤ä»£ç å‰è¯·åˆ é™¤ã€‚
- `console.error(err)`ï¼šç”Ÿäº§ç¯å¢ƒæ— æ³•æ”¶åˆ°æŠ¥è­¦ï¼Œä¸”ç¼ºä¹ä¸Šä¸‹æ–‡ã€‚
- `logError({ error: err.message })`ï¼šä¸¢å¤±å †æ ˆä¿¡æ¯ï¼ŒSentry åªèƒ½çœ‹åˆ°å­—ç¬¦ä¸²ã€‚

### 3.2 ç¯å¢ƒå˜é‡é…ç½®

è¯·åœ¨ `.env.local` (æœ¬åœ°) å’Œ Vercel/VPS ç¯å¢ƒå˜é‡ä¸­é…ç½®ä»¥ä¸‹é¡¹ï¼š

| å˜é‡å | æè¿° | å¿…éœ€ |
|---|---|---|
| `NEXT_PUBLIC_SENTRY_DSN` | Sentry DSN (ç”¨äºå®¢æˆ·ç«¯å’Œ Next.js æœåŠ¡ç«¯) | âœ… |
| `SENTRY_DSN` | Sentry DSN (ç”¨äº Workerï¼Œå¦‚æœªè®¾ç½®åˆ™å›é€€ä½¿ç”¨ NEXT_PUBLIC_SENTRY_DSN) | âŒ (å¯é€‰) |
| `SENTRY_AUTH_TOKEN` | ç”¨äºæ„å»ºæ—¶ä¸Šä¼  Source Maps | âœ… (CI/CD) |
| `SENTRY_ORG` | Sentry ç»„ç»‡å | âœ… (CI/CD) |
| `SENTRY_PROJECT` | Sentry é¡¹ç›®å | âœ… (CI/CD) |

### 3.3 æœ¬åœ°å¼€å‘è°ƒè¯•

- æœ¬åœ°å¼€å‘æ—¶ï¼Œæ—¥å¿—ä¾ç„¶ä¼šè¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆå¸¦é¢œè‰²å’Œæ ¼å¼åŒ–ï¼‰ã€‚
- Sentry é»˜è®¤åœ¨å¼€å‘ç¯å¢ƒ (`NODE_ENV=development`) ä¸ä¸Šä¼ é”™è¯¯ï¼Œé™¤éåœ¨ `sentry.*.config.ts` ä¸­æ‰‹åŠ¨å¼€å¯ `debug: true`ã€‚
- å¦‚æœéœ€è¦æµ‹è¯• Sentry ä¸ŠæŠ¥ï¼Œå¯ä¸´æ—¶è®¾ç½® `NODE_ENV=production` æˆ–ä¿®æ”¹åˆå§‹åŒ–é…ç½®ã€‚

## 4. è¿ç§»æ£€æŸ¥æ¸…å•

- [x] å®‰è£… Sentry ä¾èµ– (`@sentry/nextjs`, `@sentry/node`, `@sentry/profiling-node`)
- [x] åˆ›å»º Sentry é…ç½®æ–‡ä»¶ (`sentry.client.config.ts`, `sentry.server.config.ts`, `sentry.edge.config.ts`)
- [x] æ›´æ–° `next.config.ts` é›†æˆ Sentry
- [x] æ”¹é€  `lib/logger.ts` æ”¯æŒ Error å¯¹è±¡åŠ Sentry ä¸ŠæŠ¥
- [x] åˆå§‹åŒ– Worker æœåŠ¡çš„ Sentry SDK
- [ ] **Action Required**: å¼€å‘è€…éœ€ç”³è¯· Sentry DSN å¹¶å¡«å…¥ `.env.local`
- [ ] **Action Required**: æ¸…ç†é—ç•™çš„ `console.log` (å»ºè®®ä½¿ç”¨å…¨å±€æœç´¢é€æ­¥æ›¿æ¢)
