### Workbench Page DOR (Definition of Ready)

**目标**：为 M9（核心流）和 M10（辅助流）构建核心 UI 容器（`Workbench`），并定义其复杂的“五态”交互逻辑。

#### 1. 页面结构 (Page Structure)

- **路由**：
  - `app/[locale]/workbench/page.tsx`：默认页，用于**创建新服务**。
  - `app/[locale]/workbench/[serviceId]/page.tsx`：用于**查看/续跑**历史服务。
- **核心布局 (M3 规范)**：
  - **`<WorkbenchLayout>` (新建)**：一个 Server Component，实现“两列布局”。
  - **`Sidebar` (左侧导航栏)**：
    - **`<SidebarClient>` (新建)**：一个 Client Component，包含：
      - **新建按钮**：`Button (primary)` - `+ 新建服务`。点击后 `router.push('/workbench')`。
      - **历史列表**：`<HistoryList>` (Server Component)，获取并显示 `db.service.findMany(...)` 列表，每一项都是一个 `NextLink` 指向 `/workbench/[serviceId]`。
      - **底部菜单**：`i18nToggle`、`ThemeToggle`、`UserAvatar` (链接到 `/profile`)。
  - **`Main Workspace` (中间主工作区)**：
    - `page.tsx` 或 `[serviceId]/page.tsx` 将作为 `children` 传入 `<WorkbenchLayout>`。
- **移动端适配 (M3 规范)**：
  - `Sidebar` 默认隐藏，通过 `Header` + `Drawer`（`shadcn/ui`） 唤出。

#### 2. 交互与五态 (Interaction & 5 States)

`Workbench` 必须管理**三种**核心交互模式，每种都有“五态”：

**模式 A：新服务 (流式任务 - M9 `job_match`)**

- **场景**：用户在 `/workbench` 粘贴 JD 文本，点击“开始分析”。
- **`Idle (空闲态)`**：
  - `Textarea` 和 `Input type="file"` (用于 M9 OCR) 可用。`Button` "开始分析" 可用。
  - **(关键)** **必须**显示一个 `Alert` (variant: "info")：“请先前往「个人主页」上传通用简历。AI 必须基于您的简历才能进行匹配。”（_此 `Alert` 仅在 `resume.status !== 'COMPLETED'` 时显示_）。
- **`Queued (排队态)`**：
  - (用户点击“分析”，Server Action 返回 `success: true`)
  - `Textarea` 和 `Button` 均 `disabled`。
  - `Toaster (info)` 弹出：“任务已提交，正在排队...”。
  - (若 `isFree=true`) `Toaster (warning)` 弹出：“金币不足，已转入免费队列”。
  - 主工作区显示 `AppCard` + `Progress`（不确定进度）+ “排队中...”。
- **`Processing (流式处理中)`**：
  - (M6.5 的 `sse-stream` 开始推送 `token` 事件)
  - `Progress` 隐藏，`AppCard` 内开始**实时渲染** Markdown 流。
- **`Success (成功态)`**：
  - (SSE 收到 `end` 事件)
  - `Toaster (success)` 弹出：“匹配度分析完成！”。
  - 页面**自动跳转**到 `/workbench/[newServiceId]`，并显示 `Tab 1 (Match)` 的内容。
- **`Failed (失败态)`**：
  - (SSE 收到 `error` 事件或 Action `fetch` 失败)
  - `Button` 恢复 `enabled`。
  - `Toaster (error)` 弹出：“任务失败，金币已退回”。

**模式 B：续跑任务 (轮询任务 - M10 `customize`)**

- **场景**：用户在 `/workbench/[serviceId]` 页面，`Tab 1 (Match)` 已完成，点击 `Tab 2 (Customize)` 内的“生成定制化简历”按钮。
- **`Idle (空闲态)`**：`Button` "生成定制化简历" 可点击。
- **`Queued (排队态)`**：
  - (Server Action 返回 `success: true, taskId: ...`)
  - `Button` 变为 `disabled`。
  - `Toaster (info)` / `Toaster (warning)` 弹出（同上）。
- **`Processing (轮询中)`**：
  - `CardContent` 显示 `Progress` 组件和“AI 正在撰写中...”文本。
  - **(握手)** `useTaskPolling` Hook **启动**，轮询 `GET /api/task-status`（M2 成果）。
- **`Success (成功态)`**：
  - (`useTaskPolling` 钩子返回 `COMPLETED`)
  - `Progress` 隐藏，替换为“Markdown 编辑器”（M10 任务）。
  - `Toaster (success)` 弹出：“定制化简历已生成！”。
- **`Failed (失败态)`**：
  - (`useTaskPolling` 钩子返回 `FAILED`)
  - `Progress` 隐藏，替换为 `Alert (destructive)`：“任务失败，金币已退回”。
  - `Button` 恢复 `enabled`。

**模式 C：复杂任务链 (轮询 -> 流式 - M9 OCR `job_match`)**

- **场景**：用户在 `/workbench` 上传 JD 截图。
- **`Processing (轮询中)`**：
  - (Server Action 返回 `status: 'OCR_PENDING'`)
  - `Progress` + “正在识别岗位截图...”。`useTaskPolling` 启动。
  - (轮询返回 `SUMMARY_PENDING`) UI 文本更新为 "正在提取岗位要点..."。
  - (轮询返回 `MATCH_PENDING`) UI 文本更新为 "已进入匹配队列..."。
- **`Processing (流式处理中)`**：
  - **（关键握手）**：`useTaskPolling` Hook 检测到 `MATCH_PENDING` 状态，**必须停止轮询**。
  - `Workbench` 主组件**立即**建立 `GET /api/sse-stream` 连接。
  - `Progress` 替换为“流式渲染”卡片。

#### 3. 触发与服务端 (Triggers & Server)

- **输入控件**：
  - `Textarea` (用于 JD 文本)。
  - `Input type="file"` (用于 JD 截图)，**必须** `accept="image/*"`。
- **Server Actions (M9, M10)**：
  - `createServiceAction` (M9)：处理 `match`。
  - `customizeResumeAction` (M10)：处理 `customize`。
  - `generateInterviewTipsAction` (M10)：处理 `interview`。
- **API 路由 (M2, M6)**：
  - `GET /api/task-status` (M2 成果)：被“轮询”模式（Mode B, C）调用。
  - `GET /api/sse-stream` (M6 成果)：被“流式”模式（Mode A, C）调用。

#### 4. 状态管理 (Hooks)

- **`useTaskPolling`** (M8 成果)：复用 M8 已构建的 Hook。
- **`useSseStream` (新建)**：AI IDE **必须**创建一个新的 Hook（例如 `useSseStream`），用于封装 `EventSource` 逻辑，处理 `onopen`, `onmessage (token, end, error)` 事件。
- **`useWorkbenchState` (新建)**：AI IDE **必须**使用 `Zustand` (或 `React Context`，`Zustand` 更推荐) 创建一个轻量级 store，用于**跨组件**管理状态，例如：
  - `currentServiceId: string | null`
  - `isSidebarOpen: boolean` (用于移动端 `Drawer`)
  - `currentTaskStatus: string` (例如 `PENDING_OCR`)

---
