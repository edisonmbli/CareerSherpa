# Detailed Resume Schema Design Deep Dive

**Last Updated**: 2026-01-14
**Context**: This document explains the architectural decision behind the "Schema Mismatch" between `lib/prompts/schemas.ts` and `lib/llm/zod-schemas.ts`.

## 1. The Core Problem
We support two tiers of users with vastly different Model Capabilities:
-   **Free Tier**: Uses `Gemini-Flash` (High speed, lower reasoning). It often struggles with deeply nested JSON (recursion depth > 3) or malformed objects in complex trees.
-   **Paid Tier**: Uses `DeepSeek-Chat/Reasoner` (High intelligence). It can handle complex, 5-level nested structures perfectly.

We need a way to serve **Maximum Detail** to Paid users without crashing the experience for Free users.

## 2. The Architecture: "Single Prompt, Dual Validator"

Instead of maintaining two separate System Prompts (which is operationally expensive and hard to sync instructions), we use a **Single "Best Case" Prompt** but **Filter the Output** at runtime based on the user's tier.

### Component 1: The Prompt (User-Facing Contract)
*   **File**: `lib/prompts/schemas.ts` -> `DETAILED_RESUME_SCHEMA`
*   **Behavior**: This schema is injected into the System Prompt for **BOTH** Free and Paid users.
*   **Instruction**: The LLM is *always* instructed to generate the "Deep" structure (Nested Projects `projects[]`, Metrics `metrics[]`, etc.).
*   **Philosophy**: "Ask for the moon." We always ask the model to try its best to generate the richest data possible.

### Component 2: The Runtime Switch (The Brain)
*   **File**: `lib/llm/service.ts`
*   **Logic**:
    ```typescript
    // lib/llm/service.ts
    
    // Default to the "Safe" schema
    let schema = getTaskSchema(templateId) 
    
    // If identifying Paid User + Detailed Resume Task -> Upgrade to Deep Schema
    if (String(templateId) === 'detailed_resume_summary' && (options.tier === 'paid')) {
      schema = detailedResumeDeepSchema // <--- Runtime Switch
    }
    ```

### Component 3: The Validators (The Gatekeepers)
This is where the divergence happens to handle model capabilities.

#### A. Free Tier Validator (The Safety Net)
*   **Schema**: `detailedResumeV4Schema` (in `lib/llm/zod-schemas.ts`)
*   **Structure**: Flattened (Max 3 levels).
*   **Behavior**:
    -   It technically *allows* the LLM to output nested objects, but Zod will **strip or ignore** fields that aren't defined in this schema.
    -   Specifically, it defines `experiences` as having flat `highlights` and `metrics`, but **does not define** a nested `projects` array.
    -   **Result**: Even if Gemini manages to generate a `projects` array, Zod silently drops it during parsing, returning a clean, flat object that is safe for the UI and efficient to store.
    -   **Why?**: Stability. It prevents UI crashes caused by malformed deep objects often produced by smaller models.

#### B. Paid Tier Validator (The Passthrough)
*   **Schema**: `detailedResumeDeepSchema` (in `lib/llm/zod-schemas.ts`)
*   **Structure**: Deep (5+ levels).
*   **Behavior**:
    -   Fully explicitly defines the nested `projects` array, `task`, `actions`, `results`, and `metrics` objects.
    -   **Result**: The rich data generated by the model is preserved exactly as is.

## 3. Summary of Data Flow

| Stage | Free User (Gemini) | Paid User (DeepSeek) |
| :--- | :--- | :--- |
| **1. System Prompt** | Asks for **Deep Nested JSON** (Projects, Tasks, Actions) | Asks for **Deep Nested JSON** (Projects, Tasks, Actions) |
| **2. LLM Output** | Generates Deep JSON (but might be malformed/hallucinated) | Generates Deep JSON (High Quality) |
| **3. Validator** | `detailedResumeV4Schema` | `detailedResumeDeepSchema` |
| **4. Validation Effect** | **STRIPS** nested `projects` to ensure safety. Keeps top-level `highlights`. | **PRESERVES** full nested structure. |
| **5. Database Save** | Saves Flattened JSON | Saves Deep JSON |
| **6. UI Rendering** | `AssetPreview` renders normalized flat list. | `AssetPreview` renders nested Project Cards. |

## 4. Why not two Prompts?
Maintaining two 2000+ token system prompts is error-prone. If we update the "Extraction Rules" (e.g., "Extract numbers as metrics"), we'd have to update both. By sharing the prompt, we ensure **Instruction Consistency** while using the Validator to enforce **Structural Safety**.
