### 1）清理原型代码 (Code Cleanup)

以下是基于 prototype 和我们已确定的新架构（文档 2 & 3）所建议的清理清单：

#### 建议保留 (Keep)

这些是新架构需要复用的“基因”：

- **`app/[locale]/**`(i18n 路由结构)/page.tsx, edisonmbli/careersherpa/CareerSherpa-60fb007b2bb2b8fd5f68c9501c983bb4367c1879/app/[locale]/workbench/page.tsx]：保留`page.tsx`和`layout.tsx`作为骨架，但**清空\*\*`workbench/page.tsx`/workbench/page.tsx] 的内部逻辑。
- **`lib/i18n/`** (i18n 字典)
- **`lib/api/auth-wrapper.ts`** (M2 的 Auth 封装基础)
- **`lib/prompts/templates.ts`** (M4 LLM 抽象层需要复用)
- **`components/ui/`** (`shadcn/ui` 组件库)
- **`lib/utils.ts`** (Tailwind `cn()` 函数)
- **`middleware.ts`** (i18n 中间件)
- **`i18n-config.ts`**

#### 建议删除 (Delete)

这些是**旧架构的“定时炸弹”**，与我们的新蓝图（异步、QStash、资产/服务分离）完全冲突：

- **`lib/llm/llm-scheduler.ts`**：**(必须删除)** 这是旧的本地内存队列，是 M6 (QStash 调度器) 要替换的核心。
- **`lib/actions/service.ts`**：**(必须删除)** 这是旧的“阻塞式” Action，M7 和 M8 将新建 `upload...Action` 和 `createServiceAction`。
- **`lib/services/service-orchestrator.ts`**：(必须删除) 旧的编排逻辑。
- **`lib/actions/upload.ts`**：(必须删除) 旧的上传逻辑。
- **`components/workbench/`**：(必须删除) 旧的 UI 组件，M7 和 M8 将基于 M3 (设计系统) 重建。
- **`lib/dal.ts`**, **`lib/dal/task.ts`**, **`lib/dal/vector-store.ts`**：(见下文)

---

### 2）DAL 重置 (DAL Reset)

**DAL 代码也必须重置。**

**原因**：旧的 DAL 代码（例如 `lib/dal.ts`, `lib/dal/task.ts`）是为**旧的 `schema.prisma`** 服务的。既然 `schema.prisma` 已经被我们**颠覆性重构**（文档 2.4），那么旧的 DAL 代码现在是**完全无效**的。

**建议的操作**：

1.  **删除**旧的 DAL 文件，例如：
    - `rm lib/dal.ts`
    - `rm lib/dal/task.ts`
    - `rm lib/dal/vector-store.ts`
2.  **保留** `lib/prisma.ts`（Prisma 客户端实例）。
3.  AI IDE 将在 M2（金币系统）中**新建** `lib/dal/quotas.ts`，在 M7（资产流）中**新建** `lib/dal/resumes.ts` 等。

---

### 3）数据库重置 (Database Reset)

当前的现状（新 schema 已就位、旧数据可清理） 是执行 `prisma migrate reset` 的**完美场景**。

以下是 M1 阶段的详细步骤，由你（项目 Owner）来执行：

#### 步骤 1：安全检查与备份

- **动作**：打开你的 `.env` 文件，确认 `DATABASE_URL` 指向的是你的**开发或预览数据库**，*绝不是*生产数据库。
- **说明**：你已确认数据可清理，此步骤是最后一次确认。

#### 步骤 2：清理过时的迁移文件

- **动作**：在你的项目根目录执行以下命令，删除所有旧的迁移历史。
  ```bash
  rm -rf prisma/migrations
  ```
- **说明**：这将为你提供一个“干净的”迁移历史，为新架构腾出空间。

#### 步骤 3：(关键) 确保 `pgvector` 扩展已启用

- **动作**：
  1.  登录你的 **Neon** 数据库控制台。
  2.  导航到 `SQL Editor`。
  3.  执行以下命令：
      ```sql
      CREATE EXTENSION IF NOT EXISTS vector;
      ```
- **说明**：`prisma migrate reset` **不会**为你启用 `pgvector` 扩展。我们的新 schema（文档 2.4） 中的 `KnowledgeEntry` 表依赖 `Unsupported("vector")`。如果此扩展未启用，下一步将失败。

#### 步骤 4：执行重置命令

- **动作**：在项目根目录执行 `prisma migrate reset`。
  ```bash
  pnpm dlx prisma migrate reset
  ```
- **说明**：
  - Prisma 会连接到你的数据库。
  - 它会\*\*彻底删除（DROP）\*\*所有旧的表和数据。
  <!-- end list -->
  2.  **APPLY** `prisma/schema.prisma` 中的**新架构**（即我们文档 2.4 的内容）。
  3.  它会**自动**在 `prisma/migrations` 目录中创建一个新的、干净的初始迁移文件。

#### 步骤 5：重新生成 Prisma Client

- **动作**：
  ```bash
  pnpm dlx prisma generate
  ```
- **说明**：这将更新 `@prisma/client`，使其包含所有新模型（如 `Quota`, `PaymentWaitlist`, `Job`, `Match` 等）。

---

你遇到的情况是**完全正常且符合预期**的，这是 `migrate reset` 后的标准状态！

`prisma migrate reset` 这个命令的目的就是：

1.  **Drop Database**：删除数据库里的所有表（所以你看到库是空的，这是对的）。
2.  **Reset History**：清除迁移历史。

它**不会**自动帮你创建新的迁移文件 或应用新的 schema。它只是把数据库“恢复出厂设置”，为你提供了一块“干净的画布”。

**是的，你完全正确。** 你需要执行一个迁移（migrate）动作，来\*\*“初始化”\*\*这个干净的数据库，把我们新 `schema.prisma` 里的所有新表（`Quota`, `Service`, `Job`...）创建起来。

---

### M1 - 数据库重置（第 2 阶段：初始化）

#### 步骤 1：创建你的第一个“重构”迁移文件

这是最关键的一步。我们将使用 `prisma migrate dev`，这个命令会：

1.  对比你的（新的）`schema.prisma` 文件和（空的）数据库。
2.  发现你需要创建*所有*新表。
3.  **自动创建 `prisma/migrations` 文件夹** 以及第一个迁移。
4.  \*\*自动将这个迁移应用（apply）\*\*到你的数据库。

在你的项目根目录运行：

```bash
pnpm dlx prisma migrate dev --name init-refactor
```

- `--name init-refactor`：这是给你的第一个迁移文件命一个有意义的名字，例如 `prisma/migrations/20251105_init_refactor`。

#### 步骤 2：重新生成 Prisma Client

迁移完成后，你需要让 Prisma 客户端“知道”所有新表（如 `Quota`, `PaymentWaitlist`）的存在。

```bash
pnpm dlx prisma generate
```

#### 步骤 3：验证（可选但强烈推荐）

你可以通过两种方式验证 M1 是否成功：

1.  **（推荐）** 在项目根目录运行：`pnpm dlx prisma studio`，在浏览器中打开，你**应该能看到**所有新表（`Quota`, `Service`, `Job`...）都已创建。
2.  或者，登录 Neon 控制台，你也应该能看到所有新表。

---

**M1 总结：**

在你执行完 `prisma migrate dev` 和 `prisma generate` 之后，M1 就**真正完成**了。

此时，我们的状态是：

- **代码库**：旧的、冲突的代码已被清理。
- **数据库**：已重置，并 100% 同步了新的 `schema.prisma` 架构。
- **Prisma Client**：已更新，认识所有新模型。

我们已经拥有了最完美、最干净的起点。

---

## 备注

执行时遇到 drift 问题，处理方式为：

1. 手动创建基线迁移文件 - prisma/migrations/0001_baseline/migration.sql
2. 执行迁移，应用基线到当前库 - pnpm dlx prisma migrate deploy
