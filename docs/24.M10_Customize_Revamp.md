# M10 简历定制重构方案 (M10 Resume Customization Revamp)

> **文档状态**: RFC (Request for Comments) - Approved
> **最后更新**: 2025-12-04
> **责任人**: AI IDE

## 1. 背景与目标 (Context & Goals)

### 1.1 现状问题

目前的“简历定制”功能仅处于 Demo 阶段，存在核心缺陷：

- **非结构化**: 依赖 Markdown 生成，格式不稳定，无法支持精细化的二次编辑。
- **交互单一**: 仅支持文本展示，缺乏“所见即所得”的编辑体验。
- **深度不足**: 简单的 Prompt 生成，缺乏对 JD 的深度拆解和针对性优化。

### 1.2 重构目标

打造一个**生产级**的简历定制工具，核心特征包括：

1.  **结构化数据流**: 从 Markdown 转向严格的 JSON Schema，确保数据的一致性和可编辑性。
2.  **深度推理 (CoT)**: 引入 **DeepSeek Reasoner (R1)**，利用思维链能力进行“先思考策略、再执行修改”。
3.  **所见即所得 (WYSIWYG)**: 提供左侧表单编辑、右侧实时预览的交互体验。
4.  **多模板支持**: 数据与视图分离，支持一键切换简历模板（标准、专业、创意等）。
5.  **移动端适配**: 桌面端提供完整体验，移动端提供核心内容编辑能力。

---

## 2. 用户体验设计 (UX/UI Design)

### 2.1 核心流程 (User Flow)

1.  **Trigger**: 用户在 `Workbench` 完成 Step 1 (Match) 后，点击“定制简历”。
2.  **Processing**: 系统扣除金币，进入异步队列（提示：AI 正在深度思考优化策略...）。
3.  **Completion**: 任务完成，进入 Step 2 编辑器页面。
4.  **Editing**: 用户查看 AI 的优化建议，并在编辑器中微调内容、选择模板。
5.  **Export**: 用户满意后，导出 PDF 用于投递，或进入 Step 3 (Interview)。

### 2.2 界面布局 (Layout)

#### A. 桌面端 (Desktop)

采用 **三栏式** 或 **左侧悬浮编辑器 + 右侧预览** 的布局：

- **顶部工具栏 (Toolbar)**:
  - **AI 建议**: 折叠/展开 AI 的 `optimizeSuggestion` (Markdown 渲染)。
  - **模板切换**: 下拉选择不同风格的模板。
  - **导出**: “导出 PDF” 按钮。
  - **模块管理**: 调整章节顺序、显隐 (DnD)。
- **左侧/悬浮编辑区 (Editor Sidebar)**:
  - 基于选中模块动态渲染表单。
  - 支持富文本输入（仅限换行、Bullet Points，不支持复杂 HTML）。
- **右侧预览区 (Live Preview)**:
  - A4 纸张比例渲染。
  - 点击简历上的模块，自动激活左侧对应的编辑表单。
- **支持左右侧同步滚动能力**
  - 确保用户在编辑左侧表单时，右侧预览区能实时更新、且实时同步滚动到对应模块。

#### B. 移动端 (Mobile)

- **默认视图**: 简历预览图 (Image/Canvas) + “编辑内容”按钮。
- **编辑视图**: 唤起全屏 Drawer，仅展示表单列表（基本信息、经历列表），不支持复杂的排版/拖拽操作。
- **降级策略**: 引导用户在桌面端进行精细排版和导出。

---

## 3. 详细设计 (Detailed Design)

### Part 1: 数据模型 (Data Model)

**文件**: `prisma/schema.prisma`

```prisma
// 1. ServiceStep 枚举扩展
enum ServiceStep {
  // ... (保留现有)
  CUSTOMIZE   // [新增] 简历定制环节
}

// 2. CustomizedResume 模型重构
// 移除旧的 markdown 字段，替换为结构化 JSON 字段
model CustomizedResume {
  id              String          @id @default(cuid())
  serviceId       String          @unique @map("service_id")

  // --- 新增/修改字段 ---

  // AI 的优化建议 (Markdown 文本)
  optimizeSuggestion String?  @db.Text @map("optimize_suggestion")

  // 1. 原始 AI 生成的结构化数据 (备份用，Read-only)
  customizedResumeJson Json?  @map("customized_resume_json")

  // 2. 用户编辑后的结构化数据 (编辑器的主数据源, Source of Truth)
  editedResumeJson     Json?  @map("edited_resume_json")

  // 3. UI 布局配置 (存放章节排序、显隐状态)
  // 结构: { order: string[], hidden: string[] }
  sectionConfig        Json?  @map("section_config")

  // 状态与元数据
  status          AsyncTaskStatus @default(PENDING)
  degradeReason   String?         @map("degrade_reason")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // --- 关联与时间戳 (保留不变) ---
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("customized_resumes")
  @@schema("public")
}
```

**文件**: `lib/types/resume-schema.ts` (新建)

```typescript
import { z } from 'zod'

// ==========================================
// 1. 原子数据结构 (Data Structures)
// ==========================================

// 基础信息 (固定置顶，通常不参与普通排序，但内容可编辑)
export const basicInfoSchema = z.object({
  name: z.string().describe('姓名'),
  mobile: z.string().optional().describe('手机号'),
  email: z.string().optional().describe('邮箱'),
  wechat: z.string().optional().describe('微信号'),
  qq: z.string().optional().describe('QQ号'),
  photoUrl: z.string().optional().describe('头像URL'),
  summary: z.string().optional().describe('个人总结/职业摘要'),
})

// 通用列表项 (用于教育、工作、项目)
// description 字段统一约定：使用纯文本，换行符 \n 代表新的 bullet point
export const educationSchema = z.object({
  id: z.string().describe('UUID'),
  school: z.string().describe('学校名称'),
  major: z.string().optional().describe('专业'),
  degree: z.string().optional().describe('学历'),
  startDate: z.string().optional().describe('开始时间'),
  endDate: z.string().optional().describe('结束时间'),
  description: z.string().optional().describe('在校经历描述'),
})

export const workExperienceSchema = z.object({
  id: z.string(),
  company: z.string().describe('公司名称'),
  position: z.string().describe('职位'),
  industry: z.string().optional().describe('行业'), // 针对匹配分析很有用
  startDate: z.string().optional(),
  endDate: z.string().optional(),
  description: z.string().describe('工作内容描述'), // 重点：包含 \n 的纯文本
})

export const projectExperienceSchema = z.object({
  id: z.string(),
  projectName: z.string().describe('项目名称'),
  role: z.string().optional().describe('担任角色'),
  startDate: z.string().optional(),
  endDate: z.string().optional(),
  description: z.string().describe('项目详情描述'), // 重点：包含 \n 的纯文本
})

// 自定义板块 (用于无法归类的额外信息)
export const customSectionItemSchema = z.object({
  id: z.string(),
  title: z.string().describe('小标题'),
  description: z.string().describe('描述内容'),
})

// ==========================================
// 2. 完整简历数据 (Resume Data)
// ==========================================

export const resumeDataSchema = z.object({
  basics: basicInfoSchema,

  // 列表型板块
  educations: z.array(educationSchema).default([]),
  workExperiences: z.array(workExperienceSchema).default([]),
  projectExperiences: z.array(projectExperienceSchema).default([]),

  // 文本型板块 (前端解析换行符渲染为列表)
  skills: z.string().optional().describe('技能特长'),
  certificates: z.string().optional().describe('证书奖项'),
  hobbies: z.string().optional().describe('兴趣爱好'),

  // 扩展板块
  customSections: z
    .array(customSectionItemSchema)
    .default([])
    .describe('其他自定义板块'),
})

// ==========================================
// 3. 布局配置 (Layout Config)
// ==========================================

// 用于控制 ResumeEditor 的章节顺序和显隐
export const sectionConfigSchema = z.object({
  // 排序数组，存储板块 Key，例如 ["basics", "workExperiences", "educations", "skills", ...]
  order: z
    .array(z.string())
    .default([
      'basics',
      'summary',
      'workExperiences',
      'projectExperiences',
      'educations',
      'skills',
      'certificates',
      'hobbies',
      'customSections',
    ]),
  // 隐藏的板块 Key 列表
  hidden: z.array(z.string()).default([]),
})

// ==========================================
// 4. LLM 交互结构 (AI Response)
// ==========================================

export const llmResumeResponseSchema = z.object({
  optimizeSuggestion: z.string().describe('简历修改建议(Markdown)'),
  resumeData: resumeDataSchema.describe('完整的简历数据JSON'),
})

// ==========================================
// 5. TypeScript 类型导出
// ==========================================

export type ResumeData = z.infer<typeof resumeDataSchema>
export type SectionConfig = z.infer<typeof sectionConfigSchema>
export type LLMResumeResponse = z.infer<typeof llmResumeResponseSchema>

// 辅助类型
export type WorkExperience = z.infer<typeof workExperienceSchema>
export type Education = z.infer<typeof educationSchema>
export type ProjectExperience = z.infer<typeof projectExperienceSchema>
```

### Part 2: 后端与 AI (Backend & AI)

**1. 任务路由 (Task Router)**

- **文件**: `lib/llm/task-router.ts`
- **变更**: `resume_customize` 任务在 `paid` 模式下必须路由至 `DEEPSEEK_REASONER` (或同等推理模型)，以利用 CoT 能力。

**2. Worker 策略 (Worker Strategy)**

- **文件**: `lib/worker/strategies/customize.ts` (新建)
- **逻辑**:
  - `prepareVars`: 并行获取 Service Context (Summaries) 和 RAG Context (Resume Writing Tips)。
  - `execute`: 调用 LLM，传入 Prompt。
  - `writeResults`:
    - 校验 LLM 输出 (Zod Parse)。
    - 保存 `optimizeSuggestion` 和 `customizedResumeJson`。
    - 初始化 `editedResumeJson` (深拷贝自 customized) 和 default `sectionConfig`。

**3. Prompt 工程**

- **文件**: `lib/llm/prompts/customize.ts`
- **策略**: 使用 CoT (Chain of Thought)。
- **结构**:
  - Role: 资深简历顾问 + 招聘专家。
  - Task: 基于 Candidate Profile 和 JD，重写简历。
  - Constraints: 严格遵循 JSON Schema，事实性内容不瞎编，润色为主。
  - Output: JSON Only.

### Part 3: 前端架构 (Frontend Architecture)

**1. 状态管理 (State Management)**

- **库**: `zustand`
- **文件**: `store/resume-store.ts`
- **State**:
  - `resumeData`: 当前编辑的数据。
  - `originalData`: AI 生成的原始数据 (用于 Diff 或重置)。
  - `sectionConfig`: 排序和显隐。
  - `ui`: { activeSectionId, isSidebarOpen, ... }
- **Actions**: `updateSection`, `reorderSection`, `toggleSection`, `resetSection`.

**2. 核心组件 (Core Components)**

- `StepCustomize`: 容器组件，负责 Fetch Data -> Init Store。
- `ResumeEditorLayout`: 布局容器。
  - Left/Float: `EditorSidebar` (表单编辑区)。
  - Center: `ResumePreview` (渲染区)。
  - Right/Top: `Toolbar` (模板切换、导出、AI 建议查看)。
- `ResumePreview`:
  - 负责将 `resumeData` 渲染为 HTML。
  - 支持 `scale` 缩放。
  - 包含 `SortableList` (dnd-kit) 用于模块拖拽 (仅在编辑模式可见)。

**3. 移动端适配 (Mobile Strategy)**

- **View**: 默认展示预览图。
- **Edit**: 点击 "编辑" 进入纯表单模式 (Drawer/Modal)，不支持复杂的拖拽排版，仅支持内容修改。

---

## 4. 执行计划 (Execution Plan)

### Phase 1: 基础建设 (Foundation)

- [ ] **DB**: 修改 `prisma/schema.prisma`，执行 `prisma migrate dev`。
- [ ] **Types**: 创建 `lib/types/resume-schema.ts` (Zod definitions)。
- [ ] **Mock**: 创建一个 Mock 数据生成器，用于前端开发（无需等待后端 Worker 完成）。

### Phase 2: 后端 Worker 实现 (Backend)

- [ ] **Prompt**: 编写 `lib/llm/prompts/customize.ts` (含 CoT 和 JSON Schema)。
- [ ] **Strategy**: 实现 `lib/worker/strategies/customize.ts`。
- [ ] **Router**: 更新 `lib/llm/task-router.ts`，配置 DeepSeek Reasoner。
- [ ] **Test**: 编写单元测试或脚本，验证 Worker 能正确跑通流程并落库。

### Phase 3: 前端核心逻辑 (Frontend Core)

- [ ] **Store**: 实现 `store/resume-store.ts` (Zustand)。
- [ ] **Actions**: 实现 `updateCustomizedResumeAction` (用于保存用户修改)。
- [ ] **Container**: 改造 `app/[locale]/workbench/[serviceId]/page.tsx`，根据 Step 渲染 `StepCustomize` 组件。

### Phase 4: 编辑器 UI 开发 (Editor UI)

- [ ] **Deps**: 安装依赖 `pnpm add react-to-print @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities`。
- [ ] **Layout**: 实现 `ResumeEditorLayout` (Sidebar + Preview)。
- [ ] **Forms**: 开发各板块的表单组件 (`BasicInfoForm`, `ExperienceForm` 等)。
- [ ] **Preview**: 开发默认简历模板 (`TemplateStandard`)。
- [ ] **DnD**: 集成 `dnd-kit` 实现板块拖拽排序。

### Phase 5: 完善与集成 (Polish)

- [ ] **Export**: 实现 PDF 导出功能 (`react-to-print`)。
- [ ] **Loading**: 优化 Worker 处理期间的 Loading 状态展示 (Step 2 进度条)。
- [ ] **Mobile**: 适配移动端样式和交互。
- [ ] **E2E**: 完整测试 Match -> Customize 流程。

---
