# StepperProgress 与 CTA 渲染重构蓝图

## 目标

- 以 `ExecutionStatus` 为单一事实来源，驱动顶部 Stepper 与底部 CTA 的渲染。
- 保障桌面端与移动端一致的行为与引导路径，避免状态错乱、阶段停滞。

## 根因分析

- UI 状态来源分散：顶部 Stepper 由 `tabValue` 主导，底部 CTA 由局部条件主导，整体没有统一的阶段驱动。
- 后端 `ExecutionStatus` 已覆盖 `MATCH/CUSTOMIZE/INTERVIEW` 的 Pending/Completed/Failed，但前端并未以该枚举为核心映射；部分阶段（如 Interview）未写入 `Service.currentStatus`，也缺少 SSE 事件驱动。
- 结果：
  - Stepper 当前步显示与真实阶段不一致（例如仍停在 Step 1）。
  - CTA 在阶段完成后不会自动切换到下一任务（例如定制简历完成后，没有提示生成面试 Tips）。

## 可行性评估：ExecutionStatus 驱动

- 可行点：
  - Prisma `Service.currentStatus: ExecutionStatus` 枚举完整（prisma/schema.prisma:276-294）。
  - 后端在匹配与定制阶段已写入 `ExecutionStatus`（lib/worker/strategies/summary.ts、customize.ts）。
  - 前端已读取 `initialService.currentStatus` 并做部分映射（components/app/ServiceDisplay.tsx:68-90）。
- 潜在坑：
  - Interview 阶段未写 `ExecutionStatus.INTERVIEW_*`（lib/worker/strategies/common_tasks.ts），导致仅靠 `ExecutionStatus` 无法准确驱动 Step 3。
  - SSE 事件对 Interview 未发布“开始/结束”状态，`useWorkbenchStore` 无法感知（lib/stores/workbench.store.ts:203-236 映射表中不含 interview 事件来源）。
  - `tabValue` 作为 UI 当前视图仍需保留，但不能决定 Stepper 当前步；否则会与阶段驱动冲突。

## 现状逻辑梳理

- 数据入口：`app/[locale]/workbench/[serviceId]/page.tsx` —— 服务端传入 `initialService`（page.tsx:27-35）。
- 视图容器：`components/app/ServiceDisplay.tsx`
  - 状态初始化与映射：`initialService.currentStatus` → `WorkbenchStatus`（ServiceDisplay.tsx:68-90）。
  - 当前步计算：基于 `tabValue`（ServiceDisplay.tsx:329-335，已在本次重构改为状态驱动）。
  - Stepper 解锁：match 完成后解锁 Step 2，customize 完成后解锁 Step 3（ServiceDisplay.tsx:336-345）。
  - CTA：
    - 匹配失败时显示 Retry（ServiceDisplay.tsx:700-736）。
    - 定制阶段：显示“开始定制”或进度面板（ServiceDisplay.tsx:739-787）。
    - 面试阶段：仅在 Tab 为 `interview` 时显示按钮（ServiceDisplay.tsx:846-849 与固定底栏 881-889）。
- Stepper 组件：`components/workbench/StepperProgress.tsx` 接收 `currentStep`, `maxUnlockedStep` 并渲染（StepperProgress.tsx:15-21, 28-36）。

## 代码质量问题（基于 Next/React Best Practice）

- 状态来源不统一：`tabValue` 与多处条件同时决定 UI，缺乏状态机或集中映射。
- 条件分散且重复：同一阶段的判断在多个位置出现（进度面板、CTA、Stepper）。
- SSE 驱动缺口：Interview 无事件，导致 UI 无法正确进入 Step 3 的“生成中”态。
- 命名与职责：`currentStep` 被 `tabValue` 绑定，违反“视图选择 ≠ 阶段推进”的职责分离。
- 可维护性不足：硬编码枚举与条件未封装，后续状态扩展成本高。

## 目标方案与差距

- 目标：以 `ExecutionStatus` + 子任务状态（customize/interview）为核心，集中映射到 UI。
- 差距：
  - Interview 缺少 `updateServiceExecutionStatus(INTERVIEW_*)` 与 SSE 发布。
  - 前端缺少统一的“阶段推导”函数，导致 Stepper/CTA 分别各管一套逻辑。

## 重构计划（分步落地）

1. UI 映射集中化（前端）

   - 新增推导函数 `deriveStage(service, storeStatus, customizeStatus, interviewStatus)`：
     - 输出：`currentStep`, `maxUnlockedStep`, `cta`（label, enabled, actionKey）, `statusMessage`, `progress`。
     - 统一被 `ServiceDisplay` 使用，替换分散条件。
   - 当前提交已将 `currentStep` 改为状态驱动（components/app/ServiceDisplay.tsx:329-335 → 変更）。
   - 当前提交已在任何 Tab 下显示“生成面试 Tips”CTA，当 `customizeStatus===COMPLETED` 且 `interviewStatus!==COMPLETED`（ServiceDisplay.tsx:866-909 → 変更）。

2. 事件与状态补齐（后端）

   - 在 `InterviewStrategy`：
     - 开始时写入 `ExecutionStatus.INTERVIEW_PENDING`，并发布 SSE `status: INTERVIEW_PENDING`。
     - 完成时写入 `ExecutionStatus.INTERVIEW_COMPLETED`；失败写 `INTERVIEW_FAILED`；均发布相应 SSE 事件。
   - `useSseStream`：允许在 Interview 任务通道订阅（当前仅 match 通道），需支持基于 `taskId: interview_${serviceId}` 的订阅切换或并行订阅；或统一从 `service.executionSessionId` 推导当前活跃任务。

3. 视图行为优化（前端）

   - Stepper：`currentStep` 始终来源于阶段推导；`tabValue` 仅决定内容区域。
   - CTA：根据阶段推导统一渲染：
     - Step 1 完成 → 显示“开始定制简历”。
     - Step 2 完成 → 显示“生成面试 Tips”。
     - 失败 → 显示 Retry（按失败类型切换为 OCR/Summary/Match）。

4. 可测试性

   - 为 `deriveStage` 编写单元测试，覆盖典型组合：
     - OCR → Summary → Match → Customize → Interview 的全链路。
     - 各阶段 Failed 的回退与 CTA 显示。

5. 迁移风险与回滚
   - 分阶段提交：先前端映射与 CTA，后后端 Interview 状态与 SSE；每步独立可回滚。
   - UI 保持兼容：`tabValue` 行为不变，用户仍可手动切换。

## 近期已落地的变更（本次提交）

- 状态驱动 Stepper 当前步（components/app/ServiceDisplay.tsx:329-335 已更新）。
- 定制完成后，底部 CTA 在任意 Tab 下显示“生成面试 Tips”，点击自动切换至 Interview 并触发生成（ServiceDisplay.tsx:866-909 已更新）。

## 下一步实施项（后端 + 前端）

- 后端：在 `lib/worker/strategies/common_tasks.ts` 写入/发布 `INTERVIEW_*` 状态；在 `updateServiceExecutionStatus` 记录 `executionSessionId`，并保证前端可订阅到正确通道。
- 前端：
  - 引入集中推导函数 `deriveStage(...)` 并替换分散条件。
  - 扩展 `useSseStream` 支持 Interview 通道或以 `service.currentStatus` 为通道路由依据。
  - 完善 `StatusConsole` 在 Interview 期间的文案与进度呈现。
  - **修复问题（基于用户反馈）**：
    - 修复 `CUSTOMIZE_COMPLETED` 状态下 CTA 按钮重复（同时显示“开始定制”与“生成面试 Tips”）的问题。
    - 修正 `StepperProgress` 逻辑：`CUSTOMIZE_COMPLETED` 时 Step 3 应保持锁定（icon 与连线置灰），直到点击“生成面试 Tips”进入 Interview 流程。
    - 修正 Tab 访问权限：`CUSTOMIZE_COMPLETED` 时不可直接点击 Step 3 Tab，必须通过 CTA 触发解锁。
