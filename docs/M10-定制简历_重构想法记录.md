# 关于本轮重构，我的原始想法

希望对项目中 M10 的“简历定制”功能，作完整的重构，提升其服务质量

目前该功能还处于非常粗糙的 demo 版本，我实际体验了下，觉得之前的思路不可行，需要推倒原来的想法，重构出一个可用、好用的简历定制工具，真正帮助求职者

可是我现在脑海中只有零星片段想法，我尽量详细表达，请你作为 Nextjs+AI 应用的独立开发专家，接下来通过多轮对话交互，帮忙梳理出一份详细可落地的重构文档，指导 AI IDE 作执行

## 现状描述

1）前置步骤「匹配度分析」已完成开发、达到 production 可用程度了（参考截图-1）；当匹配度分析服务完成后，系统数据表会存有以下重要信息：

- resume_summary_json: 求职简历核心信息提取，用户级别
- detailed_resume_summary_json: 详细履历核心信息提取，用户级别
- job_summary_json: 岗位信息提取，服务级别
- match_summary_json: 岗位匹配度分析总结，服务级别

2）当前实现的「简历定制化」工能，demo 体验下来不可行（参考截图-2），主要体现在：

- markdown 格式对于大部分普通用户来说，理解和交互成本太高
- markdown 格式过于灵活，不是稳定的信息结构，会直接影响关联的简历美化、导出能力（过度灵活带来诸多不确定性，规则难以全覆盖，实现成本高、维护性差）

## 新方案构想

### 流程设计

0. 前置条件是，该服务已经完成了「Step 1 - 匹配度分析」

1. 用户点击“定制化简历”按钮，根据账号 quota 提交任务至对应的 qstash 队列（当前 Service 的 current_step 变更为“CUSTOMIZE”、current_status 变更为 “CUSTOMIZE_PENDING”）

-> 此时前端页面切换至 Step-2 tab，提示“服务已提交队列”

2. 该任务在队列中轮候至 ACTIVE，调起对应的 batch worker，调用 llm for resume_customize （llm 工作期间，当前 Service 的 current_status 变更为 “CUSTOMIZE_WORKING”）

-> 此时前端页面提示“正在执行简历定制化”

3. 如果 worker 执行失败，需记录错误原因至数据库表中对应位置，付费服务需走金币返还（当前 Service 的 current_status 变更为 “CUSTOMIZE_FAILED”）

4. llm 执行成功后，依次输出如下内容、并写入数据库 customized_resumes 表的对应字段 （当前 Service 的 current_status 变更为 “CUSTOMIZE_COMPLETED”）

- optimize_suggestion：简历定制的要点说明，用于 UI 中展示，让用户心里有数改了什么
- customized_resume_json：定制好的简历，使用固定的 json 结构，是用户下一步在页面中二次编辑的基础

-> 此时前端页面展示完成态，用户可在此基础上，进行「二次编辑｜调整结构｜调整样式｜选择模板｜保存改动｜导出 PDF」等操作；如果在此过程中用户二次编辑并选择保存，完整 json 应写入 edited_resume_json 字段，后续加载优先以此字段为准

### UI/UX 体验

llm 任务完成、进入完成态后，Step-2 页面就是用户需要深入工作的地方

UI/UX 可大概参考市面上常见的简历助手应用（参考截图-3），但请注意我们不是要照抄，而是借鉴并提供以下基本能力，但需要针对本项目重新设计出合适的视觉风格与交互方式（融入至项目现有的设计系统）

桌面端/移动端兼而有之，分别应用于不同场景，以下我先用桌面端进行预期描述，具体重构方案需要覆盖移动端

#### 顶部 MenuBar

1. AI 修改建议

- 默认收起；点击展开 optimize_suggestion
- 文案提示用户，optimize_suggestion 已自动应用到定制化简历中

2. 模块管理

- 默认收起，点击展开模块管理的菜单
- 支持启用/禁用预定义章节（llm 生成的 edited_resume_json，其中有内容的章节将自动启用；用户可选择手工禁用、重新启用）
- 支持自定义章节（包含 tile 和 desc 两部分）
- 支持拖拽调整章节次序

3. 排版美化：

- 默认收起，点击展开排版美化的菜单
- 支持选取模板，一键套用；选中模板后，视觉效果立即生效至 ResumeEditor（所见即所得）
- 在模板的基础上，还支持对一些页面设计元素的微调

4. 导出 PDF/Markdown：

- 点击导出 pdf（所见即所得）
- 也可以选择导出 markdown

#### 中间 ResumeEditor

1. 是一个所见即所得的简历编辑器
2. 页面加载时，默认从数据表加载定制好的简历信息（优先级：用户编辑过的 edited_resume_json > 其次 llm 生成的 customized_resume_json），预填至页面内对应章节
3. 基础信息默认在最上方（不受章节次序拖拽影响）；点击基础信息部分，弹出专属的维护组价，可填入/更新姓名(必填)、电话(选填)、邮箱(选填)、QQ(选填)、微信(选填)、照片(选填)；照片大小不超过 512kb
4. 其余已启用的章节信息，可以在页面对应位置内直接编辑
5. 提供自动保存能力，定期或在指定环节，自动保存用户编辑过的定制化简历，存入至 edited_resume_json

### 底部 CTA 按钮

1. “面试 Tips”按钮，旁边有预计扣减金币数量，点击后进入到 Step-3
2. 只有在 current_step=CUSTOMIZE & current_status=CUSTOMIZE_COMPLETED，该按钮才可以点击

### 要点关注

1）customized_resume_json（llm 生成）和 edited_resume_json（用户二次编辑）提供了结构化的信息底座，是定制化简历可以稳定加载、编辑的基础；
因此需要明确具体的信息结构，确保在 prompt schema 和 ResumeEditor 都按同一份约定而工作，包括但不限于以下：

- 基本信息：name、mobile、email、wechat、qq
- 教育经历：学校、专业、学历、开始时间、结束时间；【数组支持多段教育经历】
- 职业摘要：摘要描述
- 专业特长：特长描述
- 工作经历：公司、职位、行业、开始时间、结束时间、详细工作内容描述；【数组支持多段工作经历】
- 项目经历：项目名称、职位、开始时间、结束时间、详细项目说明描述；【数组支持多段项目经历】
- 兴趣爱好：爱好描述
- 技能证书：技能证书描述
- 自定义：自定义的标题、自定义的描述

\*以上对于描述类型的字段，可考虑定义为 string type，但其内容需支持 bullet points；前端界面对于 list 内容需做视觉表达的强化

2）涉及对 schema.prisma 的 customized_resumes 数据表更新，包括以下几个字段：

- optimize_suggestion
- customized_resume_json
- edited_resume_json

3）重构后的 resume_customize 任务，依赖于模型的 Chain-of-Thougts 能力，因此付费模型需使用推理能力更强的 deepseek-reasoner

4）prompt 质量很关键，需要重点优化：

- 作为资深的职场教练，站在用户的角度，为其输出定制化的求职简历，提高简历通过筛选的概率
- 需要深谙求职者心理，对于成熟度较高、原简历描述比较充分的，则尽量不作结构性破坏、以润色的方式给予一针见血的调整；对于比较初级、或原简历明显欠缺针对岗位的有效内容的，则以补充的角度切入定制出合适且真实的内容
- 也要逆向思考，站在 HR/猎头的视角去想：什么样的简历更能命中该岗位的简历筛选？从而在简历定制出释出对应的“魔法”改造
- 使用 CoT，让模型一步步思考，先消化理解 inputs（含 resume_summary_json/detailed_summary_json、job_summary_json、match_summary_json 以及 RAG 片段知识），然后推演出简历定制建议 optimize_suggestion，最后才生成完整的定制化简历 customized_resume_json
- llm 输出的结果需严格遵循约定的 schema，以便下游 ResumeEditor 可稳定使用
- 一定要基于用户上传的 resume_summary_json 以及 detailed_summary_json，作真实有效的信息提取和撰写，不能盲目构造事实；对于没有合适内容的章节也不要强行硬写，因为用户在二次编辑时会自行斟酌、调整

5）简历的美化模板，是基于同一份定制简历（edited_resume_json/customized_resume_json），给予不同的视觉呈现，以便在投递不同的行业/公司/岗位时可灵活切换；前期提供 3 ～ 5 个模板即可，主要考虑的人群包括：

- 产品经理，偏重逻辑和简洁清爽的视觉审美
- 内容运营，偏重专业排版的编辑感
- 数据/研发，简洁、高效，突出技术能力
- 设计，讲究美感，简历本身就有美的高级感

* 底层的定制户简历是结构化的 json 信息、次序由模块管理控制，那么在排版美化这里，更多是对于稳定的简历元素作视觉上的排版组合以及设计风格点缀，让同一份内容可以定制出不同的“感觉”

以上洋洋洒洒写了好多，因为我脑海中虽然有大概的重构方向，但还处于一个比较混乱的状态。需要请你帮忙一步步细化出结构清晰、细节到位的重构说明文档。我们不用一步到位，你可以先消化理解，如果有不确定的地方、或需要我进一步明确细节的地方，可以先提出讨论。经过多轮的沟通对齐后，再迭代输出重构文档的对应章节部分。

# 与 AI 沟通后的方向/细节对齐

这一步非常关键。你的直觉非常敏锐，从 Markdown 转向 **结构化 JSON + 模块化 UI** 是简历产品走向成熟的必经之路。

Markdown 虽然灵活，但对于简历这种强排版、高结构化要求的文档来说，确实是一个“伪需求”——用户要的是“填空”和“一键换装”，而不是“写代码”。

我已经完全消化了你的构思。为了确保接下来的重构文档（Document）能够精准指导 AI IDE（如 Cursor/Windsurf/Trae）执行，我需要先与你对齐架构设计中的几个核心关键点。

以下是我对你新方案的**理解总结**以及需要**进一步确认的 5 个技术决策点**。

---

### 一、 方案理解复述 (Alignment)

我们将彻底抛弃原本的文本流生成模式，转为**“异步数据生成 + 前端结构化渲染”**模式：

1.  **数据流变**：`Resume (Markdown)` -> `Resume (Strict JSON Schema)`。
2.  **执行流变**：`Sync Stream` (在线等) -> `Async Queue` (提交后轮询/通知)。
3.  **交互流变**：`Text Editor` -> `Form + Visual Editor` (所见即所得，数据与样式分离)。
4.  **智能流变**：`Single Prompt` -> `CoT (Reasoning)` (先思考策略，再生成 JSON)。

---

### 二、 核心决策点讨论 (Clarification)

请针对以下 5 点给出你的倾向或确认，这将直接决定数据结构和组件选型：

#### 1. JSON 数据结构的“原子性” (Data Granularity)

在 `customized_resume_json` 中，具体的长文本字段（如 `工作经历-详细描述`），我们是存储为**纯文本字符串**，还是**HTML 片段**？

- **选项 A：纯文本 (String with \n)**
  - 优点：LLM 极其稳定，不容易出错。
  - 缺点：前端渲染时，bullet points (项目符号) 只能靠换行符模拟，样式控制较弱。
  - _我的建议_：**选项 A**。让 LLM 输出带 `\n` 或 `- ` 的纯文本，前端渲染组件负责将其解析为 `<ul><li>` 列表，这样最稳健，也方便后续切模版。

#### 2. 编辑器技术选型 (Editor Tech Stack)

你提到的“所见即所得 (WYSIWYG)”编辑器，在技术实现上有两种路径：

- **路径 A：表单+预览分离 (Form + Preview)**
  - 左侧/悬浮层是输入表单（Input/Textarea），右侧/底层是渲染好的简历。修改表单，右侧实时更新。
  - _优点_：移动端适配极其容易（只展示表单即可）。
- **路径 B：内联编辑 (Inline Edit)**
  - 直接点击简历上的文字进行修改（类似 Notion 或 Word）。
  - _优点_：桌面端体验极佳。
  - _缺点_：实现复杂度高，且在移动端很难操作。
- _我的建议_：考虑到你需要“移动端场景”，我建议采用 **“点击模块 -> 弹出/侧边栏表单编辑 -> 实时渲染预览”** 的模式。这种模式在技术上最可控，且能完美复用同一套数据流适配 Mobile/Desktop。你是否接受？

#### 3. 模板渲染与 PDF 导出方案

- **渲染**：既然要支持多模板（清爽、专业、技术、设计），建议使用 React 组件来写模板。即 `<TemplateA data={resumeJson} />`, `<TemplateB data={resumeJson} />`。
- **导出**：
  - **方案**：使用 `react-to-print` 或浏览器原生 `window.print()`。
  - **原理**：前端直接利用 CSS `@media print` 规则，将 React 组件渲染为 PDF。
  - **优点**：所见即所得，服务器无压力，开发速度快。
  - **确认**：是否同意采用前端渲染导出方案？（不需要后端生成 PDF）

#### 4. 移动端的“降级”策略

你提到方案需覆盖移动端。鉴于简历排版的复杂性，建议在移动端做如下处理：

- **查看模式**：可查看生成的简历预览图或简化版 HTML。
- **编辑模式**：**仅支持基于表单的数据修改**（改错别字、改手机号），**不支持**拖拽排序、不支持模板切换、不支持复杂的样式微调。
- **确认**：是否同意移动端仅保留核心“内容编辑”能力，将“排版/美化/导出”引导至桌面端？

#### 5. 状态管理 (State Management)

Step-2 页面交互极重（拖拽、编辑、切换模板）。

- 我们将引入 `Zustand` 作为前端状态管理库，专门用于管理 `resumeStore`（包含 currentJson, originalJson, history 等）。这比 React Context 性能更好，且能避免不必要的渲染。

---

### 三、 接下来我会为你输出的文档结构

确认以上细节后，我将为你梳理出一份包含以下章节的**《M10 简历定制重构实施方案》**：

1.  **数据库架构设计 (Database Schema)**

    - 定义 `CustomizedResume` 表的精确字段。
    - 定义 JSON Schema 的 TypeScript 接口定义 (Zod Schema)，供前后端共用。

2.  **后端 Worker 与 LLM 策略 (Backend & AI)**

    - QStash 队列与 Worker 的交互流程。
    - DeepSeek Reasoner 的 Prompt 结构（System Prompt, User Prompt, Output Schema）。
    - 错误处理与重试机制。

3.  **前端架构与组件设计 (Frontend Architecture)**

    - Step-2 页面状态机（Pending -> Working -> Completed）。
    - `ResumeEditor` 的组件拆分（Toolbar, Canvas, SidebarConfig）。
    - 使用 `dnd-kit` 实现模块拖拽排序。

4.  **模板系统设计 (Template System)**
    - 如何设计一个“模板基类”，使得不同模板都能读取同一份 JSON 数据。

---

**我的回复：**

1. JSON 数据结构的“原子性” (Data Granularity) - 同意采用选项 A：纯文本 (String with \n)
2. 编辑器技术选型 (Editor Tech Stack) - 采用 “点击模块 -> 侧边栏表单编辑 -> 实时渲染预览” 的模式
3. 模板渲染与 PDF 导出方案 - 同意 React 组件来写模板以及前端渲染导出方案
4. 移动端的“降级”策略 - 同意移动端仅保留核心“内容编辑”能力，但“排版/美化/导出”需要有明确的桌面端能力引导
5. 状态管理 (State Management) - 同意引入 Zustand 作为前端状态管理库

另外需要补充的是，项目当前已经有能正常运作的 QStash 队列与 Worker 的交互流程（支持 batch 和 stream 模式，本次 CUSTOMIZE 任务走 bacth），也已经有完整的 Prompt template 系统，当前不需要再重复造轮子了，请消化理解 github 上的存量代码：https://github.com/edisonmbli/CareerSherpa.git，尽量复用现有的基础设施
