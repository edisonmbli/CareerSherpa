# Logging 规范与统一标准

## 覆盖范围

- 服务端（Next.js RSC / API Routes / Server Actions / DAL / Worker 共享逻辑）
- Worker 进程（任务执行、队列、策略）
- 浏览器端 UI（交互、SSE 调试、用户态错误）
- LLM 与 RAG 调试输出（结构化与文件落盘）
- Sentry 统一采集（生产环境）

## 统一入口

### 服务端与 Worker

- 统一使用 [logger.ts](file:///Users/edisonmbli/Projects/CareerShaper/lib/logger.ts) 提供的函数
  - logInfo(payload)
  - logDebug(payload)
  - logError(payload)

### 浏览器端 UI

- 统一使用 [sse-debug-logger.ts](file:///Users/edisonmbli/Projects/CareerShaper/lib/ui/sse-debug-logger.ts)
  - uiLog.info / uiLog.warn / uiLog.error / uiLog.debug
  - sseLog.connection / sseLog.event / sseLog.stateChange

### LLM/调试文件

- 统一使用 [debug.ts](file:///Users/edisonmbli/Projects/CareerShaper/lib/llm/debug.ts)
  - logDebugData(phase, { input?, output?, meta?, latencyMs? })
  - 统一输出到 tmp/debug-logs 与 perf timeline

## 开关与启用方式

### Next.js（.env.local）

- LOG_INFO=true 开启服务端 info 日志
- LOG_DEBUG=true 开启服务端 debug 日志与 logDebugData
- LLM_DEBUG=true 允许 LLM 链路调试输出
- NEXT_PUBLIC_LOG_DEBUG=true 开启 UI 日志
- NEXT_PUBLIC_SSE_DEBUG=true 开启 SSE 日志

### Worker（worker/.env）

- LOG_INFO=true
- LOG_DEBUG=true
- LLM_DEBUG=true

## 结构化日志标准

所有日志都必须携带结构化字段，便于索引与排障：

- reqId：请求/任务主键（taskId/serviceId/requestId）
- route：模块或路径标识（如 api/sse-stream、dal/services）
- phase：当前阶段（如 fetch_start / parse_failed / enqueue）
- serviceId / userKey / taskId：关联业务上下文
- durationMs / latencyMs：耗时指标
- tokens / cost：LLM 相关指标
- error：错误对象或错误描述

建议在日志中补充业务必要元信息：

- modelId / provider / tier / queue
- status / code / isTrial
- stage / traceId

## 行为规范

- 禁止在业务代码中直接使用 console.\*，仅允许在以下场景：
  - lib/logger.ts 内部（统一出口）
  - lib/ui/sse-debug-logger.ts 内部（UI 调试出口）
  - tests 与 vitest.config.ts 等测试/配置文件
- 服务端与 Worker 使用 logInfo/logDebug/logError，不要在业务层重复封装 console
- UI 交互错误使用 uiLog，SSE 相关使用 sseLog
- 文件调试输出统一走 logDebugData，避免直接 fs.writeFile
- 生产环境输出必须安全，不记录敏感信息与个人隐私字段
- error 必须结构化传入，避免丢失栈与上下文

## Sentry 规范

- 生产环境由 logger 自动上报到 Sentry
- logError 会 captureException
- logInfo/logDebug 会 captureMessage

## 常见示例

### 服务端

```ts
logInfo({
  reqId: serviceId,
  route: 'workbench/page',
  phase: 'service_fetch',
  serviceId,
  userKey: userId,
  durationMs: Date.now() - startedAt,
})
```

### UI

```ts
uiLog.error('resume_auto_save_failed', { error: errorMessage })
```

### LLM 调试文件

```ts
logDebugData('resume_summary_output', {
  output: JSON.stringify(result),
  meta: { serviceId, taskId },
  latencyMs,
})
```

## 迭代要求

- 新增模块时必须复用统一入口，不新增其他日志工具
- 新增日志字段必须保持结构化与稳定命名
- 对关键链路必须保证 reqId / route / phase 具备可追踪性
- 当新增 SSE 或 UI 调试需求时，优先扩展 uiLog/sseLog 的 action/分类
