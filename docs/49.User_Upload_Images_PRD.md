# User Upload Images - Vercel éƒ¨ç½²æ–¹æ¡ˆ

## é—®é¢˜èƒŒæ™¯

å½“å‰æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­ï¼Œç”¨æˆ·ä¸Šä¼ çš„ JD æˆªå›¾å­˜å‚¨åœ¨ `/public/uploads/` ç›®å½•ï¼Œæ•°æ®åº“ `jobs.image_url` è®°å½•çš„æ˜¯ `/uploads/xxxxx` è·¯å¾„ã€‚

**Vercel çš„é™åˆ¶**ï¼š
- âŒ **æ— æŒä¹…åŒ–æ–‡ä»¶ç³»ç»Ÿ**ï¼šServerless å‡½æ•°çš„ `/tmp` ç›®å½•æ˜¯ä¸´æ—¶çš„ï¼Œå‡½æ•°æ‰§è¡Œå®Œå³æ¸…é™¤
- âŒ **æ— æ³•å†™å…¥ `/public`**ï¼šæ„å»ºæ—¶é™æ€èµ„æºå·²æ‰“åŒ…ï¼Œè¿è¡Œæ—¶æ— æ³•ä¿®æ”¹
- âŒ **æ— åŸç”Ÿ UGC å­˜å‚¨**ï¼šå¿…é¡»ä½¿ç”¨å¤–éƒ¨å¯¹è±¡å­˜å‚¨æœåŠ¡

---

## è§£å†³æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æˆæœ¬ |
|------|------|------|------|
| **Vercel Blob** | å®˜æ–¹é›†æˆï¼Œé›¶é…ç½® | ä»…æ”¯æŒ Vercel | $0.02/GB/æœˆ |
| **Cloudflare R2** | S3 å…¼å®¹ï¼Œå…å‡ºç«™æµé‡ | éœ€è¦å•ç‹¬é…ç½® | $0.015/GB/æœˆ |
| **AWS S3** | æˆç†Ÿç¨³å®šï¼Œç”Ÿæ€ä¸°å¯Œ | é…ç½®å¤æ‚ï¼Œæœ‰å‡ºç«™è´¹ | $0.023/GB/æœˆ |
| **Supabase Storage** | ä¸ Supabase DB é›†æˆ | æ€§èƒ½ä¸€èˆ¬ | $0.021/GB/æœˆ |
| **Base64 å­˜ DB** | æ— éœ€å¤–éƒ¨æœåŠ¡ | æ•°æ®åº“è†¨èƒ€ï¼Œæ…¢ | N/A |

---

## æ¨èæ–¹æ¡ˆï¼šVercel Blob

### ä¸ºä»€ä¹ˆé€‰æ‹© Vercel Blob

1. **é›¶é…ç½®é›†æˆ**ï¼šä¸ Next.js å®˜æ–¹æ·±åº¦é›†æˆ
2. **è¾¹ç¼˜ç¼“å­˜**ï¼šè‡ªåŠ¨ CDN åˆ†å‘ï¼Œå…¨çƒè®¿é—®å¿«
3. **ç®€å• API**ï¼š`@vercel/blob` SDK æç®€æ˜“ç”¨
4. **å®‰å…¨**ï¼šæ”¯æŒç§æœ‰/å…¬å¼€è®¿é—®æ§åˆ¶
5. **è®¡è´¹é€æ˜**ï¼šæŒ‰å­˜å‚¨é‡å’Œå¸¦å®½è®¡è´¹ï¼Œå…è´¹é¢åº¦è¶³å¤Ÿ MVP

### å…è´¹é¢åº¦

- å­˜å‚¨ï¼š500 MB
- å¸¦å®½ï¼š1 GB/æœˆ
- ä¸Šä¼ æ¬¡æ•°ï¼šæ— é™åˆ¶

---

## å®æ–½æ–¹æ¡ˆ

### Phase 1: å®‰è£…ä¾èµ–

```bash
pnpm add @vercel/blob
```

### Phase 2: ç¯å¢ƒå˜é‡

```env
# .env.local (å¼€å‘) å’Œ Vercel Dashboard (ç”Ÿäº§)
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_xxxxx
```

### Phase 3: ä¿®æ”¹ä¸Šä¼ é€»è¾‘

**å½“å‰ä»£ç ** (`lib/actions/upload.actions.ts` æˆ–ç±»ä¼¼æ–‡ä»¶)ï¼š

```typescript
// ğŸ”´ æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ - ä¸é€‚ç”¨äº Vercel
const filePath = `/uploads/${filename}`
await fs.writeFile(`./public${filePath}`, buffer)
return filePath
```

**æ”¹ä¸º Vercel Blob**ï¼š

```typescript
import { put } from '@vercel/blob'

export async function uploadJobImage(file: File, userId: string) {
  const filename = `jd/${userId}/${Date.now()}-${file.name}`
  
  const blob = await put(filename, file, {
    access: 'public',  // æˆ– 'private' éœ€è¦ç­¾å URL
    addRandomSuffix: true,
  })
  
  // è¿”å› CDN URL
  return blob.url  // https://xxxxx.public.blob.vercel-storage.com/jd/...
}
```

### Phase 4: ä¿®æ”¹è¯»å–é€»è¾‘

**å½“å‰ä»£ç ** (`lib/worker/strategies/ocr.ts`)ï¼š

```typescript
// ğŸ”´ æœ¬åœ°æ–‡ä»¶è¯»å–
if (imageOrUrl.startsWith('/uploads/')) {
  const filePath = path.join(process.cwd(), 'public', imageOrUrl)
  const buffer = await fs.readFile(filePath)
  // ...
}
```

**æ”¹ä¸º URL Fetch**ï¼š

```typescript
// âœ… æ”¯æŒå®Œæ•´ URLï¼ˆVercel Blob è¿”å›çš„ CDN URLï¼‰
if (imageOrUrl.startsWith('http')) {
  const response = await fetch(imageOrUrl)
  const buffer = Buffer.from(await response.arrayBuffer())
  const base64 = buffer.toString('base64')
  // ...
}
```

### Phase 5: æ•°æ®åº“è¿ç§»

`jobs.image_url` å­—æ®µå†…å®¹å˜æ›´ï¼š

| ç¯å¢ƒ | æ—§æ ¼å¼ | æ–°æ ¼å¼ |
|------|--------|--------|
| æœ¬åœ°å¼€å‘ | `/uploads/xxx.png` | ä¿æŒä¸å˜ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰ |
| Vercel ç”Ÿäº§ | N/A | `https://xxx.blob.vercel-storage.com/...` |

**æ— éœ€æ•°æ®åº“ Schema ä¿®æ”¹**ï¼Œå­—æ®µç±»å‹ `String` å…¼å®¹ä¸¤ç§æ ¼å¼ã€‚

---

## å…¼å®¹æ€§ç­–ç•¥

ä¸ºäº†æœ¬åœ°å¼€å‘å’Œ Vercel ç”Ÿäº§ç¯å¢ƒéƒ½èƒ½å·¥ä½œï¼š

```typescript
// lib/utils/image-storage.ts

import { put } from '@vercel/blob'
import fs from 'fs/promises'
import path from 'path'

const IS_VERCEL = process.env.VERCEL === '1'

export async function saveImage(file: Buffer, filename: string): Promise<string> {
  if (IS_VERCEL) {
    // ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ Vercel Blob
    const blob = await put(filename, file, { access: 'public' })
    return blob.url
  } else {
    // æœ¬åœ°å¼€å‘ï¼šä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿ
    const filePath = `/uploads/${filename}`
    await fs.writeFile(path.join(process.cwd(), 'public', filePath), file)
    return filePath
  }
}

export async function readImage(imageUrl: string): Promise<Buffer> {
  if (imageUrl.startsWith('http')) {
    // å®Œæ•´ URLï¼ˆVercel Blobï¼‰
    const res = await fetch(imageUrl)
    return Buffer.from(await res.arrayBuffer())
  } else {
    // æœ¬åœ°è·¯å¾„
    const filePath = path.join(process.cwd(), 'public', imageUrl)
    return fs.readFile(filePath)
  }
}
```

---

## æ–‡ä»¶æ”¹åŠ¨æ¸…å•

| æ“ä½œ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| NEW | `lib/utils/image-storage.ts` | ç»Ÿä¸€å­˜å‚¨æŠ½è±¡å±‚ |
| MODIFY | ä¸Šä¼  Action | æ”¹ç”¨ `saveImage()` |
| MODIFY | `ocr.ts` | æ”¹ç”¨ `readImage()` |
| ADD | `.env.local` | `BLOB_READ_WRITE_TOKEN` |

### Phase 6: ä¼˜åŒ–ç­–ç•¥ (Limits & Retention)

#### 1. ä¸Šä¼ é™åˆ¶ (1MB Limit)

ä¸ºäº†èŠ‚çœå¸¦å®½å’Œå­˜å‚¨ç©ºé—´ï¼Œå¼ºåˆ¶é™åˆ¶ä¸Šä¼ å›¾ç‰‡å¤§å°ã€‚

- **å‰ç«¯é™åˆ¶** (UX): åœ¨æ–‡ä»¶é€‰æ‹©æ—¶æ‹¦æˆª
  ```typescript
  // component/ui/file-upload.tsx
  const maxSize = 1 * 1024 * 1024 // 1MB
  if (file.size > maxSize) {
    toast.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 1MB')
    return
  }
  ```
- **åç«¯é™åˆ¶** (Security): åœ¨ API Route ä¸­äºŒæ¬¡æ ¡éªŒ
- **è‡ªåŠ¨å‹ç¼©**: å¦‚æœç”¨æˆ·ä¸Šä¼ çš„å›¾ç¨å¤§ï¼ˆå¦‚ 2MBï¼‰ï¼Œå¯ä»¥åœ¨å‰ç«¯æˆ–åç«¯å…ˆç”¨ `sharp`/`canvas` å‹ç¼©åˆ° <1MB å†ä¸Šä¼ ï¼Œä½“éªŒæ›´å¥½ã€‚

#### 2. è‡ªåŠ¨æ¸…ç† (7-Day Retention)

å›¾ç‰‡è¢« OCR/LLM è¯†åˆ«åï¼ŒåŸå›¾ä¸å†å…·æœ‰é•¿æœŸä»·å€¼ã€‚ä½¿ç”¨ **Vercel Cron** å®šæœŸæ¸…ç†ã€‚

**æ­¥éª¤**ï¼š

1. **é…ç½® Cron Job**:
   åœ¨ `vercel.json` ä¸­é…ç½®ï¼š
   ```json
   {
     "crons": [
       {
         "path": "/api/cron/cleanup-images",
         "schedule": "0 0 * * *" // æ¯å¤© UTC 0ç‚¹ (åŒ—äº¬æ—¶é—´ 8:00)
       }
     ]
   }
   ```

2. **åˆ›å»ºæ¸…ç† API**:
   `app/api/cron/cleanup-images/route.ts`:
   ```typescript
   import { list, del } from '@vercel/blob'
   
   export async function GET(req: Request) {
     // éªŒè¯æ˜¯å¦ä¸º Vercel Cron è°ƒç”¨
     if (req.headers.get('Authorization') !== `Bearer ${process.env.CRON_SECRET}`) {
       return new Response('Unauthorized', { status: 401 })
     }
   
     const { blobs } = await list()
     const now = Date.now()
     const ONE_WEEK = 7 * 24 * 60 * 60 * 1000
     
     const toDelete = blobs
       .filter(blob => (now - blob.uploadedAt.getTime()) > ONE_WEEK)
       .map(blob => blob.url)
       
     if (toDelete.length > 0) {
       await del(toDelete)
       console.log(`Deleted ${toDelete.length} old images`)
     }
     
     return Response.json({ deleted: toDelete.length })
   }
   ```

---

## éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

- [ ] å®‰è£… `@vercel/blob`
- [ ] Vercel Dashboard åˆ›å»º Blob Store
- [ ] è·å– `BLOB_READ_WRITE_TOKEN` å¹¶é…ç½®åˆ° Vercel ç¯å¢ƒå˜é‡
- [ ] åˆ›å»º `image-storage.ts` æŠ½è±¡å±‚
- [ ] ä¿®æ”¹ä¸Šä¼ é€»è¾‘
- [ ] ä¿®æ”¹ `ocr.ts` å›¾ç‰‡è¯»å–é€»è¾‘
- [ ] æœ¬åœ°æµ‹è¯• + Vercel Preview éƒ¨ç½²æµ‹è¯•

---

## å‚è€ƒé“¾æ¥

- [Vercel Blob å®˜æ–¹æ–‡æ¡£](https://vercel.com/docs/storage/vercel-blob)
- [Next.js æ–‡ä»¶ä¸Šä¼ ç¤ºä¾‹](https://github.com/vercel/examples/tree/main/storage/blob-starter)
