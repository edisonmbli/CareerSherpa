# Requirements

## 业务场景
求职是一个漫长的过程，一般来说，会经历如下核心过程
- 复盘“来时路”，整理一份详尽的「个人详细履历」，完整记录个人的项目经验、亮点技能 等等
- 提炼成一份「个人通用简历」，上传至各大求职网站，通过丰富、到位的关键词吸引互动
- 从求职平台，会持续看到一些猎头/HR 发布的工作机会
- 对于感兴趣的岗位，需要精心准备「求职定制化」工作，包括：工作匹配度分析、言简意赅的求职意向表达、定制化简历、有针对性的自我介绍和面试问题准备

/*本项目要解决的就是最后一步，通过大模型的能力，帮用户完成最后一公里「求职定制化」的相关工作，提效、提质*/

## 用户体验地图
1. 访问 Web APP 地址：www.careershaper.com
2. 游客身份登录，落地到首页 Landing Page，看到功能介绍，点击立即试用
3. 快速注册账号（绑定社交账号 or 邮箱），获赠8 枚（env 参数可配置）体验金币 -> quotas + 8
4. 登录态 将跳过 landing page，直接落地到工作台页 Workbench Page
5. 被引导录入个人情况，上传 个人通用简历（必选）+ 个人详细履历（可选），触发 LLM 按制定格式提炼、落表，让系统了解自己
  - 金币分别扣减 1 个 -> quota - 1
6. 创建「求职定制化」服务，涉及 3 个步骤：
  - Step 1 match，上传 意向求职岗位，执行匹配度分析（必选） - 输出分数、匹配度分析结论、精简的求职意向表达 -> quota - 1
  - Step 2 customize，简历定制化（可选） - 输出定制化的简历；用户可自行作二次编辑、存档 -> quota - 1
  - Step 3 interview，面试定向准备（可选） - 输出定制化的自我介绍、面试前准备清单 -> quota - 1
7. 对应真实的求职进展，每一轮求职定制化服务，可以选择走完完整的 3 个 Step，或只选择其中的部分（match为必经，customize/interview 为可选）
8. 对应多职位并行沟通的真实场景，用户可以灵活地并行创建多轮求职定制化服务
9. 边栏可方便查看历史创建过的求职服务
  - 可以再次打开查看服务信息，或继续推进到 next step
  - 服务过程中每个 Step 产出的内容，可再次打开，并支持用户作二次编辑、保存
  - 定制化简历还可以预览 pdf 效果、并支持导出
10. 边栏可查看账号当前可用金币数量；用户认可网站功能，可付费购买更多的金币 -> quota + N
11. 用户 Profile页，可查看金币的购买、消费历史

# Solutions

## 核心概念和关键架构设计点
1. 用户成功注册后，每个账号都对应一个 user_id
2. 每个账号支持上传一份个人通用简历pdf（resume_id）和一份个人详细简历pdf（detailed_resume_id）；上传后触发 LLM 按格式提炼、落表
3. 用户每启动一轮新的求职定制化服务，将创建 一个对应的service_id，过程中用户可上传一个目标岗位信息，支持图片或纯文字（job_id）
4. 以 service_id为服务单元，响应用户的互动请求，按需启动 match / customize / interview这几个 LLM 任务，产出的服务内容分别按match_id、customize_id、interview_id落表记录
5. match / customize / interview 任务涉及到 RAG 知识库的内容提取
6. LLM 供应商对 API并行调用数量有限额，因此结合队列设计，控制好对大模型的并发控制量
7. 每个涉及到 LLM 调用的任务，都会触发金币扣减
  - 当 quotas 扣至 0 或以下，后续操作默认进入免费低速队列
  - 购买金币后，quotas > 0的情况下，后续操作都会进入付费高速队列

## 基础建设

### 1）Neon Auth
1. Neon Auth 提供编辑的用户注册/登录能力，启用后，它将自动管理好用户信息，并实时更新信息至neon_auth。users_sync表
2. 应用侧管理 users_sync 的 user_id，拓展本项目的业务逻辑
3. 当前 prototype 已实现 neon auth 的基础集成，以及认证包装器的架构
4. 但还需要补充 profile 管理的能力

### 2）RAG
1. 当前 prototype 已启用 neon 的 pgvector
2. 但还未落地任何 RAG 相关的能力和流程，需补齐
3. match / customize / interview 这 3 个任务将需要求职面试相关的干货知识补充，我将搜集并整理网上的高质量资料，清洗后入库，然后可用于 LLM 的 prompt + RAG 调用

### 3）LLM 调度器
1. 当前 prototype 已实现内容版的队列管理，但有以下问题：
  - 不适用于生产环境，因为后续部署到 vercel，基于队列但长时间运行的 llm 调用，将被 timeout截断
  - 当前的 type + tier 队列设计过于复杂，且为完全贴合业务场景，因此代码中也产生了不必要且混乱的胶水粘贴逻辑
2. 需要作彻底的重构优化
  - 使用Upstash QStash 和 Vercel KV (基于 Redis)构建队列
  - 简化队列逻辑，让其紧密绑定真正的 LLM 模型：
    【付费】
    1) 队列-1：deepseek-chat，5 个并发
    2) 队列-2：deepseek-reasoner，5 个并发
    3) 队列-3：glm-4.1v-thinking-flash，3 个并发
    【免费】
    4) 队列-4：glm-4.5-flash，2 个并发
    5) 队列-5：glm-4.1v-thinking-flash，2 个并发
3. 任务与队列的对应关系
| Task              | Desc             | 付费 (quotas > 0)                       | 免费 (quotas <= 0)                      |
| :---------------- | :--------------- | :-------------------------------------- | :-------------------------------------- |
| resume            | 抽取、提炼简历信息 | 队列-1: deepseek-chat                   | 队列-4: glm-4.5-flash                   |
| detialed_resume   | 抽取、提炼详历信息 | 队列-2: deepseek-reasoner               | 队列-4: glm-4.5-flash                   |
| job               | 抽取、提炼岗位信息 | 队列-3: glm-4.1v-thinking-flash<br>队列-1: deepseek-chat | 队列-3: glm-4.1v-thinking-flash<br>队列-4: glm-4.5-flash |
| match             | 匹配度分析       | 队列-2: deepseek-reasoner               | 队列-4: glm-4.5-flash                   |
| customize         | 简历定制化       | 队列-1: deepseek-chat                   | 队列-4: glm-4.5-flash                   |
| interview         | 面试定向准备     | 队列-1: deepseek-chat                   | 队列-4: glm-4.5-flash                   |
        

### 4）商业化策略
1. 用金币的概念对应 LLM 调用次数
2. 每个涉及到付费模型（deepseek-chat、deepseek-reasoner）的用户操作，按任务复杂度作对应的金币数量扣减
| 用户操作         | 涉及 Tasks      | Desc                       | 扣减金币数量 |
| :--------------- | :-------------- | :------------------------- | :----------- |
| 上传通用简历     | resume          | 抽取、提炼简历信息         | 1            |
| 上传详细履历     | detialed_resume | 抽取、提炼详历信息         | 1            |
| 创建求职服务     | job + match     | 抽取、提炼岗位信息 + 匹配度分析 | 2            |
| 帮我改简历       | customize       | 简历定制化                 | 2            |
| 生成面试Tips     | interview       | 面试定向准备               | 2            |
        
3. 每次用户操作前，检查 quotas 并作原子化金币扣减；如服务失败（e.g. 大模型不稳定），则原子化返还等量金币
4. 平摊下来，涉及到 LLM 调用的每个任务，input 为 10000 tokens、output 为 10000 tokens；参考 deekseek api 单价，每个 llm 任务的成本约为 0.05 元/次
5. 因此按 0.5 元/次计价每个 llm 任务，即每个服务金币的定价
6. 对外销售时以 10 个金币为单位，即 5 元可购得 10 个 llm 任务调用

## 核心用户操作

### 1）上传个人通用简历
- 这是创建任何求职定制服务前的必要前置项
- 用户上传个人通用简历（当前版本仅支持 pdf），系统解析提取文字，并交由 LLM 按格式提炼出关键信息，resume_summary_json存入数据表
- 每个 user id 仅支持上传一份个人通用简历
- 可支持重新上传、覆盖已有简历，这样会触发 LLM 调用，因此也会扣除相应的服务金币

### 2）上传个人详细简历
- 这是创建任何求职定制服务前的可选前置项
- 因为给到 LLM 的上下文越丰富越好，因此需要在 profile page 合适的地方，引导用户尽量总结好自己的详细过往经历后上传；理想情况下给出一些提示示例，给到用户参考
- 用户上传个人详细履历（当前版本仅支持 pdf），系统解析提取文字，并交由 LLM 按格式提炼出关键信息，detailed_resume_summary_json存入数据表
- 每个 user id 仅支持上传一份个人详细履历
- 可支持重新上传、覆盖已有简历，这样会触发 LLM 调用，因此也会扣除相应的服务金币

### 3）创建求职服务
- 创建求职服务，严格上可分为两个主要步骤：
  - 用户上传岗位信息（当前版本支持截图 or 粘贴文字），系统解析出文字信息，并交由 LLM 按格式提炼出关键信息，job_summary_json存入数据表
  - 系统结合用户个人信息（resume id、detailed resume id）+ 岗位信息（job_id），根据问题背景调取 RAG 知识片段，组建 prompt 提交至 LLM 进行分析，最后展示结果
- 该任务较为复杂、且路径长，因此在前端需要作相应的用户体验处理：
  - job 开始提取、提取进度、完成提取，前端及时给到当前progress display
  - 一旦进入 LLM 分析匹配度阶段，采用 stream 模式，把 LLM 返回的结果及时地展示到前端 component
- 匹配度分析结果 match_summary_json写入数据表

### 4）帮我改简历
customize 和上面的 match 类似，本质上也是结合用户个人通用简历 resume id、匹配度分析结果 match id、以及从 RAG 调取的简历撰写知识，融合进 prompt 调用 LLM ，整理结果给到用户；在这个基础上，还需要完成简历定制化的下游工作，包括：
- 调用 LLM 分析出简历定制化方向，并基于用户上传的个人通用简历，针对当前岗位作出定制化的修饰/优化，生成新版简历，以markdown 格式写入数据表（customized_resume_id）
- 提供界面供用户查看，并作进一步的二次编辑修改（左边 markdown，右边实时预览pdf效果，联动展示），修改后的新版本可落数据表保存
- 预览ok 的定制化简历，可一键导出至本地 pdf 文件，可见即所得

### 5）生成面试 Tips
- 结合定制化个人简历（customized_resume_id）、匹配度分析结果（match_id）、以及从 RAG 调取的面试准备知识，融合进 prompt 调用 LLM ，整理结果给到用户
- 采用 stream 模式，把 LLM 返回的结果及时地展示到前端 component

## 数据表设计
1. 基于 prisma + DAL 层，管理项目数据互动
2. 当前 prototype 已有 prisma.schema 设计，但不满足重构后的应用架构，需要配合底层重构
3. 现有的 migrations file 也不是最新的，趁这次数据表结构化重构，可以 reset 整个数据库，推倒重建

## 页面设计
我设想中的 【桌面端】页面架构是这样的：
1. 匿名用户，落地到 landing page，引导其注册账号
2. 注册成功后，跳转至 profile page
  - 引导上传个人通用简历、个人详细履历；可选择先跳过
  - 可查看金币相关信息
3. 个人信息补齐或跳过后，跳转至 workbench page，所有核心操作都在这里完成：
  - 中间是主要工作区域，可创建服务（先检查是否有个人通用简历信息，无则驳回并提示先上传，跳转至 profile 页）
  - 服务创建成功后，在这里可以顺次操作 match / customize / interview 等任务
  - 服务过程中，可以选择新建另外的定制化服务（保存当下，另建新 service；对应求职过程中的等候、受阻，同时看多个机会的场景）
  - 左边栏可以查看历史服务记录，点击后加载此service id，查看历史输出内容，or 继续推进 next step 任务（对应收到对方反馈，需要下一步求职跟进的场景）
  - 左边栏可以查看可用金币数量，点击后进入 profile page，这里可以看到更多的金币充值、消费过程
  - 右上方3 个按钮
    * 国际化语言切换
    * light/dark 模式切换
    * 个人头像，点击进入 profile page

/*当前版本主要保障桌面端的体验，【移动端】以最低成本的方式先适配、可用就行，后续再发力重点优化*/