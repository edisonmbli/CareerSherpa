# 67. 日志系统迁移指南 (Logging Migration Guide)

## 1. 背景与目标

为了统一管理 Next.js 主应用与 Hono Worker 后台服务的日志，并实现生产环境的异常监控，本项目引入了 **Sentry** 作为标准的日志与错误追踪平台。

**主要变更：**

- 引入 `@sentry/nextjs` (Frontend/API) 和 `@sentry/node` (Worker)。
- 改造 `lib/logger.ts`，使其自动将错误上报至 Sentry。
- 规范化日志记录方式，废弃散落在代码中的 `console.log/error`。

## 2. 架构概览

### Next.js 应用 (Vercel)

- **客户端**: 自动捕获 React 错误边界、未处理的 Promise Rejection。
- **服务端 (API/RSC)**: 通过 `sentry.server.config.ts` 和 `sentry.edge.config.ts` 自动捕获异常。
- **配置**: `next.config.ts` 已集成 Sentry Webpack 插件（用于上传 Source Maps）。

### Hono Worker (VPS)

- **运行时**: Node.js。
- **集成**: 在 `worker/src/index.ts` 中初始化 Sentry Node SDK。
- **错误捕获**: 全局 `onError` 中间件自动上报未捕获异常；关键业务逻辑通过 `logError` 手动上报。

## 3. 开发指南 (Best Practices)

### 3.1 如何记录日志

**推荐方式**：始终使用 `lib/logger.ts` 提供的工具函数。

```typescript
import { logInfo, logError } from '@/lib/logger'

// ✅ 正确：记录普通信息 (开发环境 Console，生产环境 Breadcrumb)
logInfo({
  reqId: 'req_123',
  route: 'api/test',
  message: 'Worker started processing',
  data: { jobId: '123' },
})

// ✅ 正确：记录错误 (自动上报 Sentry + Console)
try {
  await doSomething()
} catch (err) {
  logError({
    reqId: 'req_123',
    route: 'api/test',
    error: err, // 👈 务必传入原始 Error 对象，以保留堆栈信息
    phase: 'db_transaction',
    context: { userId: 'u_1' }, // 额外上下文
  })
}
```

**🚫 避免方式**：

- `console.log('here')`：提交代码前请删除。
- `console.error(err)`：生产环境无法收到报警，且缺乏上下文。
- `logError({ error: err.message })`：丢失堆栈信息，Sentry 只能看到字符串。

### 3.2 环境变量配置

请在 `.env.local` (本地) 和 Vercel/VPS 环境变量中配置以下项：

| 变量名                   | 描述                                                                | 必需       |
| ------------------------ | ------------------------------------------------------------------- | ---------- |
| `NEXT_PUBLIC_SENTRY_DSN` | Sentry DSN (用于客户端和 Next.js 服务端)                            | ✅         |
| `SENTRY_DSN`             | Sentry DSN (用于 Worker，如未设置则回退使用 NEXT_PUBLIC_SENTRY_DSN) | ❌ (可选)  |
| `SENTRY_AUTH_TOKEN`      | 用于构建时上传 Source Maps                                          | ✅ (CI/CD) |
| `SENTRY_ORG`             | Sentry 组织名                                                       | ✅ (CI/CD) |
| `SENTRY_PROJECT`         | Sentry 项目名                                                       | ✅ (CI/CD) |

### 3.3 本地开发调试

- 本地开发时，日志依然会输出到控制台（带颜色和格式化）。
- Sentry 默认在开发环境 (`NODE_ENV=development`) 不上传错误，除非在 `sentry.*.config.ts` 中手动开启 `debug: true`。
- 如果需要测试 Sentry 上报，可临时设置 `NODE_ENV=production` 或修改初始化配置。

## 4. 迁移检查清单

- [x] 安装 Sentry 依赖 (`@sentry/nextjs`, `@sentry/node`, `@sentry/profiling-node`)
- [x] 创建 Sentry 配置文件 (`sentry.client.config.ts`, `sentry.server.config.ts`, `sentry.edge.config.ts`)
- [x] 更新 `next.config.ts` 集成 Sentry
- [x] 改造 `lib/logger.ts` 支持 Error 对象及 Sentry 上报
- [x] 初始化 Worker 服务的 Sentry SDK
- [ ] **Action Required**: 开发者需申请 Sentry DSN 并填入 `.env.local`
- [ ] **Action Required**: 清理遗留的 `console.log` (建议使用全局搜索逐步替换)

## 4. Sentry Setup

本节用于 PRD 环境切换时的标准化操作，面向运维与研发共同执行。

### 4.1 申请与权限

1. 登录/注册 Sentry 账号，加入公司组织（Org）。
2. 新建项目：
   - 平台选择：**Next.js**（用于 App Router 前后端）与 **Node.js**（用于 Worker）。
   - 建议命名：`career-shaper-web`、`career-shaper-worker`。
3. 权限与访问：
   - 运维/平台组具备 Org 管理权限。
   - 开发组具备项目级别 `Write` 权限用于查看 issue 与 release。
4. 安全要求：
   - 统一开启组织级 2FA。
   - Auth Token 仅用于 CI/CD，避免下发到个人本地环境。

### 4.2 DSN 与环境准备

1. 获取 DSN：
   - 进入项目 Settings → Client Keys (DSN)，复制 DSN。
2. 配置环境变量：
   - `NEXT_PUBLIC_SENTRY_DSN` 写入 `.env.local`（本地）与生产环境变量（Web）。
   - `SENTRY_DSN` 写入 Worker 环境变量（如未设置则回退使用 `NEXT_PUBLIC_SENTRY_DSN`）。
3. 生产环境建议额外配置：
   - `SENTRY_ENVIRONMENT=production`
   - `SENTRY_RELEASE`（来自 CI/CD 构建号或 git commit）
   - `SENTRY_AUTH_TOKEN`、`SENTRY_ORG`、`SENTRY_PROJECT`（用于上传 Source Maps）

### 4.3 Next.js 侧接入

1. 安装依赖：
   - 已安装：`@sentry/nextjs`、`@sentry/node`、`@sentry/profiling-node`
2. 配置文件：
   - `sentry.client.config.ts`：浏览器端采集与采样策略。
   - `sentry.server.config.ts`：RSC/Route Handler/Server Actions 采集与采样策略。
   - `sentry.edge.config.ts`：Edge 运行时采集策略。
3. Next 配置：
   - `next.config.ts` 已接入 `withSentryConfig`，确保 Source Maps 自动上传。
4. 日志入口保持统一：
   - 服务端只使用 `logInfo/logDebug/logError`。
   - UI 只使用 `uiLog/sseLog`。

### 4.4 Worker 侧接入

1. Worker 运行时初始化：
   - 使用 `@sentry/node` 初始化（确保 `SENTRY_DSN` 存在）。
2. 统一字段规范：
   - 在 Worker 中上报必须包含 `reqId/route/phase/taskId/serviceId` 等结构化字段。
3. 运行环境：
   - Worker 的 `.env` 中开启 `LOG_INFO/LOG_DEBUG` 由运维控制。

### 4.5 Source Maps 与 Release 管理（生产必须）

1. CI/CD 中注入：
   - `SENTRY_AUTH_TOKEN`、`SENTRY_ORG`、`SENTRY_PROJECT`。
   - `SENTRY_RELEASE` 建议使用 `git rev-parse --short HEAD` 或构建流水号。
2. 发布流程：
   - 构建时上传 Source Maps。
   - 生产环境启用 `SENTRY_ENVIRONMENT=production`。
3. 回滚要求：
   - 每次发布固定 `SENTRY_RELEASE`，确保错误可回溯到版本。

### 4.6 生产环境使用建议

1. 采样策略：
   - 错误采样：`tracesSampleRate` 建议从 0.1 起步逐步调优。
   - 性能采样：按高峰期流量动态下调。
2. 隐私与脱敏：
   - 禁止上报敏感字段（用户简历/个人信息/密钥）。
   - 如需内容排障，使用结构化字段与 hash 标识替代原文。
3. 告警与看板：
   - 设置关键链路告警：SSE、Worker 任务失败率、DAL 错误率。
   - 建立面板：按 `route/phase/serviceId` 聚合问题。
4. 排障流程：
   - 先查 Sentry issue → 关联 release → 再回溯日志与请求链路。
   - 与统一日志系统互补，避免直接在业务代码中加入 console 日志。
