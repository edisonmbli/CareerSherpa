# M9 岗位匹配度分析 全链路重构方案

> **文档状态**: RFC (Request for Comments)  
> **最后更新**: 2025-01-06  
> **责任人**: AI IDE

---

## 一、背景与定位

### 1.1 M9 在产品链路中的角色

M9「岗位匹配度分析」是 CareerShaper 求职服务的**核心入口与承上启下关键节点**：

```mermaid
flowchart LR
    A[用户上传简历/履历] --> B[M9 匹配度分析]
    B --> C[M10 简历定制化]
    C --> D[M11 面试准备]
    B -.-> |serviceId| C
    B -.-> |job_match_summary| C
    B -.-> |job_match_summary| D
```

- **前置依赖**：用户需先完成简历/详历上传解析
- **核心产出**：
  - 创建唯一 `serviceId`，贯穿后续所有任务
  - 输出 `job_match_summary`，作为 M10/M11 的关键输入
  - 生成「敲门」私信话术，直接面向用户使用
- **执行链条**：OCR 识别（可选）→ JD 摘要提取 → 匹配度分析 → 结果呈现

### 1.2 现状评估

M9 经过初期开发与多轮小迭代后已"能用"，但与 M10 重构后的品质差距明显：

| 维度               | 当前状态   | 问题表现                                   |
| ------------------ | ---------- | ------------------------------------------ |
| **Prompt 质量**    | 及格线     | 缺乏深度行业洞察、CoT 不完整、话术机械化   |
| **Free Tier 支持** | 无         | 没有 `job_match_lite`，Free 用户体验受限   |
| **UI 质感**        | 可用但粗糙 | 颜色杂乱、信息层级不清、与 M10 风格不统一  |
| **任务进度体验**   | 不稳定     | 步骤串联卡顿、进度条无意义、流式吐字不连贯 |

### 1.3 重构目标

参照 M10 重构成功经验，将 M9 提升至同等品质基线：

1. **Prompt 2.0**：注入行业"隐性知识"，提升分析深度与话术转化率
2. **Free Tier 支持**：引入 `job_match_lite`，覆盖免费用户场景
3. **UI 质感统一**：与 M10 编辑器风格协调，打造专业感
4. **任务体验顺滑**：进度可预期、步骤流转顺畅、用户焦虑可控

---

## 二、问题深度诊断

### 2.1 Prompt 层面问题

参考 [docs/21.Prompt_Eng_job_match.md](file:///Users/edisonmbli/Projects/CareerShaper/docs/21.Prompt_Eng_job_match.md) 与 [docs/45.M10_Resume_Customize_Prompt_Optimize.md](file:///Users/edisonmbli/Projects/CareerShaper/docs/45.M10_Resume_Customize_Prompt_Optimize.md)：

| 问题               | 表现                                   | 根因               |
| ------------------ | -------------------------------------- | ------------------ |
| **JD 解析浅层化**  | 仅关键词匹配，忽略"硬指标"vs"废话"区分 | 缺乏 JD 解码逻辑   |
| **风险识别不足**   | 不识别"过度胜任"、"跳槽频繁"等隐性风险 | 缺乏 HR 视角思维链 |
| **话术机械化**     | H-V-C 结构生硬，缺乏"钩子策略"         | 未强制禁止废话开场 |
| **评估偏友善**     | 打分偏高，缺乏犀利反馈                 | 角色定位不清晰     |
| **第二人称不一致** | 有时用"候选人"而非"你"                 | 口吻指令不够明确   |

当前 Prompt（摘要）：

```typescript
// zh.ts L705-L777
systemPrompt: `你是一位拥有20年经验的**资深招聘专家和职业策略顾问**...`
userPrompt: `请基于以下材料进行专家级匹配度分析...`
```

**差距对比**：与 M10 的 `resume_customize` 相比，M9 的 Prompt 缺乏：

- 明确的"三层处理模型"（PRESERVE/REFINE/AUGMENT 在 M10 中表现优异）
- 结构化的思维链（Step 1-7）
- 输出格式的精确约束

### 2.2 UI/UX 层面问题

#### A. ResultCard 视觉问题

当前 [ResultCard.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/workbench/ResultCard.tsx) 设计存在以下问题：

| 问题                | 表现                                    | 影响           |
| ------------------- | --------------------------------------- | -------------- |
| **色彩过杂**        | 绿/黄/蓝等多色混用，缺乏主色调          | 视觉疲劳       |
| **信息层级不清**    | Expert Verdict 与 Highlights 权重不分明 | 用户抓不住重点 |
| **组件块边界模糊**  | 各 Section 视觉分隔弱                   | 阅读体验割裂   |
| **与 M10 风格断层** | M10 编辑器简洁克制，M9 花哨             | 全站质感不统一 |

参考用户上传截图：

- 第一张（M9 ResultCard）：灯光效果虽有创意，但整体"土气"
- 第二张（M10 Editor）：简洁专业的编辑界面

#### B. 任务状态管理问题

涉及组件：

- [ServiceDisplay.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/app/ServiceDisplay.tsx)
- [StepperProgress.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/workbench/StepperProgress.tsx)
- [StatusConsole.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/workbench/StatusConsole.tsx)
- [StreamPanel.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/workbench/StreamPanel.tsx)
- [BatchProgressPanel.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/workbench/BatchProgressPanel.tsx)

| 问题               | 表现                               | 用户感受     |
| ------------------ | ---------------------------------- | ------------ |
| **步骤串联不顺滑** | OCR→Summary→Match 切换时有视觉跳跃 | 焦虑、不可控 |
| **进度条无意义**   | 进度百分比与实际无关联             | 失去信任     |
| **流式输出问题**   | 文案重复、节奏不稳定、卡顿         | 体验粗糙     |
| **状态同步问题**   | SSE 与 store 状态偶有冲突          | 界面闪烁     |

---

## 三、重构策略

### 3.1 总体思路

参照 M10 成功模式：**分 Phase 迭代，每 Phase 有明确交付物和验收标准**

```mermaid
flowchart TB
    P1[Phase 1: Prompt 质量提升] --> P2[Phase 2: Free Tier 支持]
    P2 --> P3[Phase 3: UI 重构]
    P3 --> P4[Phase 4: 任务状态优化]
```

### 3.2 Phase 设计

#### Phase 1: Prompt 质量提升

**目标**：将 `job_match` Prompt 升级至与 `resume_customize` 同等深度

**核心改动**：

1. **角色升级**

   - Before: "资深招聘专家和职业策略顾问"
   - After: "**私人求职教练**"（更强调第二人称对话感）

2. **JD 解码思维链**

   ```
   Step 1: 识别硬指标（Deal Breakers）——学历、核心技能、行业年限
   Step 2: 识别核心痛点——这个岗位招进来究竟解决什么问题
   Step 3: 过滤"正确的废话"——笼统的沟通能力、抗压能力等
   ```

3. **风险识别增强**

   - 新增"过度胜任"(Over-qualified) 风险检测
   - 新增"跳槽频繁"风险提示
   - 新增"行业跨度大"风险评估

4. **话术革命**

   - 强制禁止废话开场："您好，我对贵司很感兴趣"
   - 引入钩子公式：**问题共鸣** + **价值证明** + **行动邀约**
   - 输出格式：保持 H/V/C 三段式结构（与现有 Schema 完全兼容）

5. **评分机制细化**
   - 85-100: 硬指标达标 + 核心痛点命中 + 稀缺人才
   - 60-84: 技能达标但缺行业经验 / 存在过度胜任风险
   - <60: 硬指标缺失（学历/核心技能）

> **Schema 兼容性说明**：现有 `jobMatchSchema` 使用 `{ H, V, C }` 结构，本次 Prompt 优化仅改善内容指导，**无需修改 Schema 或 ResultCard 渲染逻辑**

**参考样本**：[docs/llm_testing/match_summary.json](file:///Users/edisonmbli/Projects/CareerShaper/docs/llm_testing/match_summary.json)

**交付物**：

- 更新 `lib/prompts/zh.ts` 的 `job_match`
- 更新 `lib/prompts/en.ts` 的 `job_match`
- 输出质量对比测试报告

#### Phase 1.5: OCR、Free tier 架构重构

目前已完成的前置 setup 工作：

0）前期调研文档：docs/48.OCR_Gemini_Model_Research.md
1）百度 OCR 相关的参数 BAIDU_API_KEY、BAIDU_SECRET_KEY 已维护到.env.local，并已在百度 Console 把接口调通了
2）通用文字识别（高精度版）的 官方 API 文档，供参考查阅：https://cloud.baidu.com/doc/OCR/s/1k3h7y3db
3）Gemini 模型调用参数 GEMINI_API_KEY 已维护到.env.local
4）Gemini-3 模型用于图片理解的官方 API 文档，供参考查阅：https://ai.google.dev/gemini-api/docs/gemini-3#javascript、https://ai.google.dev/gemini-api/docs/image-understanding

##### 方案概述

**核心目标**：去除智谱模型依赖，构建稳定低成本的双通路架构

**双通路设计**：

| 通路     | OCR 任务                    | 文本任务               | 特点                 |
| -------- | --------------------------- | ---------------------- | -------------------- |
| **Paid** | 百度 OCR 高精度版（小模型） | DeepSeek-Chat/Reasoner | 低成本、稳定、高质量 |
| **Free** | Gemini-3-Flash（图片理解）  | Gemini-3-Flash         | 免费额度内零成本     |

**关键改动**：

1. **Paid tier OCR**：从 LLM 视觉模型切换为百度 OCR API

   - 同步调用，不再经过 QStash 队列
   - 需对上传图片进行压缩（满足 4MB 限制）
   - 输出纯文本写入 `jobs.original_text`

2. **Free tier 合并流程**：将 `ocr_extract` + `job_summary` 合并为 `job_vision_summary`

   - 单次 Gemini 多模态调用直接输出 JobSummary 结构
   - 减少一次 LLM 调用，降低延迟

3. **Free tier 全面切换至 Gemini-3-Flash**：

   - `job_summary`、`job_match`、`resume_customize`、`interview_prep` 均使用 Gemini

4. **Rate Limiting 增强**：
   - Free tier：每用户每天限制 50 次 Gemini 调用
   - Paid tier：维持现有逻辑（每 90 秒 15 次）

##### 实施文件清单

| 操作   | 文件                             | 说明                                              |
| ------ | -------------------------------- | ------------------------------------------------- |
| NEW    | `lib/services/baidu-ocr.ts`      | 百度 OCR API 封装（Token 管理 + 调用）            |
| NEW    | `lib/utils/image-compress.ts`    | 服务端图片压缩（sharp 库）                        |
| NEW    | `lib/llm/gemini-provider.ts`     | Gemini Provider（@google/generative-ai SDK）      |
| MODIFY | `lib/llm/providers.ts`           | 添加 GEMINI_3_FLASH ModelId 和 GeminiProvider     |
| MODIFY | `lib/llm/task-router.ts`         | 更新任务路由表（Paid OCR 走百度、Free 走 Gemini） |
| MODIFY | `lib/prompts/zh.ts`              | 添加 job_vision_summary 模板                      |
| MODIFY | `lib/prompts/en.ts`              | 添加 job_vision_summary 模板                      |
| MODIFY | `lib/worker/strategies/ocr.ts`   | 双通路 OCR 逻辑                                   |
| MODIFY | `lib/rateLimiter.ts`             | Daily rate limit for Free tier                    |
| MODIFY | `lib/actions/service.actions.ts` | 条件路由（Paid 直接调百度 / Free 入队 Gemini）    |

##### Paid tier 上传 JD 截图 的完整工作流

```mermaid
sequenceDiagram
    participant U as 用户
    participant SA as service.actions.ts
    participant Q as QStash Queue
    participant W as Worker (ocr.ts)
    participant B as Baidu OCR API
    participant DB as Database

    U->>SA: 上传 JD 截图
    Note over SA: 判断 hasQuota=true
    SA->>Q: 入队 ocr_extract
    SA-->>U: 返回 PENDING_OCR

    Q->>W: 消费任务
    Note over W: prepareVars()
    W->>DB: 读取图片 base64
    alt Baidu OCR Ready
        W->>B: 调用 Baidu OCR
        B-->>W: 返回文本
        Note over W: 使用 Baidu OCR 结果
    else Baidu Not Ready
        W->>W: 调用 LLM Vision OCR
    end

    Note over W: writeResults()
    W->>DB: 写入 original_text
    W->>Q: 入队 job_summary
```

**核心代码位置**：

| 阶段      | 文件                 | 行号     | 说明                                 |
| --------- | -------------------- | -------- | ------------------------------------ |
| 入队 OCR  | `service.actions.ts` | L140-195 | 入队 `ocr_extract` 任务              |
| 获取图片  | `ocr.ts`             | L29-80   | `prepareVars()` 读取图片             |
| Baidu OCR | `ocr.ts`             | L83-139  | `isBaiduOcrReady()` 检查 + API 调用  |
| 写入结果  | `ocr.ts`             | L173-280 | `writeResults()` 优先使用 Baidu 结果 |
| OCR API   | `baidu-ocr.ts`       | 全文件   | Token 管理 + API 封装                |
| 图片压缩  | `image-compress.ts`  | 全文件   | 满足 4MB 限制                        |

**延迟估算**：

| 阶段               | 延迟      |
| ------------------ | --------- |
| 队列调度（QStash） | ~0.5-1s   |
| 读取图片 + 压缩    | ~0.2-0.5s |
| **Baidu OCR API**  | **~1-3s** |
| 写入 DB + 入队     | ~0.1-0.2s |
| **总计**           | **~2-5s** |

#### Phase 2: Enhanced Reasoning Pipeline (Bad Cop / Good Cop)

**目标**：利用 Gemini Flash 的低成本优势，为 Paid 用户引入 "Pre-Match Audit" 环节，构建 "Reviewer -> Coach" 的双重分析架构，显著提升分析深度。

**架构设计**：

```mermaid
flowchart LR
    A[Job Summary] --> B{Tier?}
    B -- Free --> C[Job Match (Standard)]
    B -- Paid --> D[Pre-Match Audit (Bad Cop)]
    D --> E[Job Match (Good Cop + Context)]

    style D fill:#ffcccc,stroke:#333,stroke-width:2px
    style E fill:#ccffcc,stroke:#333,stroke-width:2px
```

**核心改动**：

1.  **新增 `pre_match_audit` Prompt (The Bad Cop)**

    - **角色**：严苛的简历审核员 (Gatekeeper)。
    - **任务**：寻找 Risk (硬伤)、Gap (差距) 和 "Deal Breakers"。
    - **模型**：Gemini-3-Flash (Fast & Cheap)。
    - **Fallback**：若调用失败/超时，自动跳过，不阻断流程。

2.  **升级 `job_match` Prompt (The Good Cop)**

    - **输入增强**：增加 `pre_match_risks` 变量。
    - **逻辑增强**：如果存在 Risk Context，则针对性制定 "化解策略" (Counter-Strategy)；否则执行标准分析。
    - **Prompt 设计**：使用 Worker 预处理将 Risk 封装为 `risk_context_block`，Prompt 仅需包含 `{{risk_context_block}}` 占位符，确保 Free Tier (空值) 兼容。

3.  **任务流重构 (`SummaryStrategy`)**

    - 在 `job_summary` 完成后进行路由分叉：
      - **Paid**: 入队 `pre_match_audit` (Batch)。
      - **Free**: 入队 `job_match` (Stream)。
    - `pre_match_audit` Worker 完成后，携带结果入队 `job_match`。

4.  **前端体验联动**
    - 复用 `MATCH_PENDING` 状态。
    - 当检测到 `hasQuota=true` 且处于 Match 阶段初期时，UI 显示 "AI 审计员正在进行红队测试..." (通过 Stream 消息或子步骤状态实现)。

**关键问题解决方案**：

- **Fallback 机制**：`PreMatchStrategy` 捕获所有 LLM 异常，一旦失败，记录日志并直接入队 `job_match` (Risk = null)，确保服务高可用。
- **Prompt 兼容**：Worker 负责变量清洗。Free Tier 传入空字符串，Prompt 表现为标准模式；Paid Tier 传入审计报告，Prompt 激活 "深度咨询模式"。

**交付物**：

- 新增 `pre_match_audit` Prompt
- 更新 `job_match` Prompt
- 新增 `PreMatchStrategy` Worker
- 更新 `SummaryStrategy` 路由逻辑
- 验证 Fallback 与 Free Tier 兼容性

##### 核心方案梳理

###### 1. 流程控制：如何“无感”插入中间层？

不修改前端的状态枚举（避免复杂的数据库迁移和前端重构），而是采用 **“状态复用 + 路由分叉”** 的策略。

- **后端路由分叉** (`SummaryStrategy`)：
  - 在 `Job Summary` 任务完成时，检查用户是否付费 (`wasPaid`)。
  - **Paid 用户**：静默插入 `pre_match_audit` 任务。此时前端状态依然保持为 `MATCH_PENDING`。
  - **Free 用户**：直接进入 `job_match` 任务。
- **前端感知**：
  - 虽然数据库状态没变，但我们可以利用 Server-Sent Events (SSE) 推送更细粒度的进度消息。
  - 当 `pre_match_audit` 开始运行时，推送一条 `status: "AUDITING"` 的消息。前端收到后，可以将 loading 文案从 "等待匹配..." 动态切换为 "AI 审计员正在进行红队测试..."。这样既不改 DB 结构，又给了付费用户尊贵的感知。

###### 2. Prompt 兼容：如何一套 Prompt 跑通两种场景？

不需要维护两套 Prompt，而是采用 **“条件式注入”**。

- **Worker 预处理**：在 `job_match` 的 Worker 中，检查上一步是否传来了 `audit_result`。
  - 如果有（Paid），构造一段文本：`\n【前置风险审计报告】\n${audit_result}\n`。
  - 如果没有（Free/Fallback），构造空字符串 `""`。
- **Prompt 设计**：
  - 在 System Prompt 中加入指令：_"如果输入中包含【前置风险审计报告】，请针对报告中的风险点制定化解策略；否则，请自行进行全面分析。"_
  - 这样模型会根据上下文自动适应，空参数完全不影响模型表现。

###### 3. Fallback 机制：免费模型挂了怎么办？

这是保证服务 SLA 的关键。我们将采用 **“快速失败，优雅降级”** 策略。

- **超时控制**：给 `pre_match_audit` 设置严格的超时（例如 60s）。Gemini Flash 很快，如果 60s 没回来，说明网络或服务有问题。
- **异常捕获**：在 `PreMatchStrategy` 中包裹 `try-catch`。
  - 一旦发生 Timeout 或 API Error，立即记录日志（不报错给用户）。
  - **立即执行 B 计划**：直接入队 `job_match`，并将 `audit_result` 设为空。
- **用户体验**：用户只会感觉“这次分析好像没经过深度审计步骤，直接出结果了”，而不会遇到“任务失败”的红屏报错。

##### 改动点回溯

已完成 Phase 2 的核心代码落地，实现了 **"Enhanced Reasoning Pipeline" (Bad Cop / Good Cop)** 架构。

###### ✅ 代码变更清单

1.  **架构定义与类型系统**

    - `lib/prompts/types.ts` & `lib/worker/types.ts`: 定义了 `PreMatchAuditVars`，并更新 `JobMatchVars` 支持 `pre_match_risks` 注入。
    - `lib/llm/zod-schemas.ts`: 定义了 `pre_match_audit` 的输出 Schema（Risk List + Severity）。
    - `lib/llm/task-router.ts`: 配置了 `pre_match_audit` 路由（Paid Tier -> Gemini-3-Flash -> Paid Batch Queue）。

2.  **Prompt 工程**

    - `lib/prompts/zh.ts` & `en.ts`:
      - **新增** `pre_match_audit` (The Bad Cop): 扮演严苛的 Gatekeeper，专门寻找 Deal Breakers。
      - **升级** `job_match` (The Good Cop): 增加了 `pre_match_risks` 上下文槽位。

3.  **Worker 策略与流程控制**
    - **新增** `lib/worker/strategies/pre_match.ts`:
      - 实现了审计逻辑。
      - **前端联动**：通过 SSE 推送 `status: "audit_start"`，让前端可以展示 "AI 审计员正在进行红队测试..."。
      - **Fallback 机制**：无论 LLM 成功与否，`writeResults` 都会确保入队 `job_match`。如果失败，`pre_match_risks` 为空（降级为标准模式）。
    - **修改** `lib/worker/strategies/summary.ts`:
      - 在 `enqueueMatchTask` 中实现了 **路由分叉**。
      - **Paid**: `Job Summary` -> `Pre-Match Audit` -> `Job Match`。
      - **Free**: `Job Summary` -> `Job Match`。

#### Phase 3: UI 重构实现高质感

**目标**：将 ResultCard 提升至与 M10 编辑器同等质感

**核心改动**：

1. **色彩体系统一**

   - 主色调：蓝色系（与 M10 一致）
   - 强调色：翡翠绿（高分）、琥珀色（中分）、珊瑚红（低分）
   - 移除过多渐变，采用扁平化设计

2. **信息层级重构**

   ```
   ┌─────────────────────────────────────┐
   │ Score Badge + Company/Job          │ ← 顶部固定
   ├─────────────────────────────────────┤
   │ Expert Verdict                     │ ← 核心结论，突出显示
   ├─────────────────────────────────────┤
   │ Strengths (折叠)                   │ ← 可展开详情
   ├─────────────────────────────────────┤
   │ Weaknesses (折叠)                  │ ← 可展开详情
   ├─────────────────────────────────────┤
   │ Smart Pitch                        │ ← 话术区，一键复制
   └─────────────────────────────────────┘
   ```

3. **组件样式优化**

   - 移除 LampDesk 装饰（与 M10 风格冲突）
   - 采用 subtle border 替代 gradient 背景
   - 统一 Timeline 样式（点+线）

4. **交互增强**
   - Highlights/Weaknesses 默认折叠，点击展开
   - Smart Pitch 增加"预览模式"与"复制模式"切换
   - 添加"查看原始 JSON"调试入口（仅 dev 环境）

**交付物**：

- 重构后的 `ResultCard.tsx`
- 统一的色彩/间距 Token 文档
- 视觉对比 Before/After 截图

#### Phase 4: 任务状态管理优化

**目标**：实现顺滑的多步骤任务体验

**核心改动**：

1. **步骤可视化增强**

   - 在 StepperProgress 中显示子步骤（OCR → Summary → Match）
   - 当前步骤高亮 + 脉冲动画
   - 已完成步骤显示 ✓

2. **进度条语义化 + 时间模拟**

   参考 M10 的 [workbench-stage.ts](file:///Users/edisonmbli/Projects/CareerShaper/lib/utils/workbench-stage.ts#L324-L340) 实现，为 M9 各阶段引入时间模拟进度：

   | 阶段    | 进度范围 | 预估时长 | 更新频率 |
   | ------- | -------- | -------- | -------- |
   | OCR     | 0-30%    | 60s      | 每 3s    |
   | Summary | 30-50%   | 60s      | 每 3s    |
   | Match   | 50-100%  | 120s     | 每 3s    |

   **模拟逻辑**：

   ```
   进入 xxx_PENDING 状态 → 启动定时器 (startedAt = now)
   每 3s: progress = 阶段起点 + (elapsed / 预估时长) * 阶段跨度 → 最高阶段封顶值的95%
   收到 xxx_COMPLETED → 立即跳到阶段封顶值
   ```

3. **StreamPanel 优化**

   - 修复文案重复问题
   - 平滑打字机效果（requestAnimationFrame 节流）
   - 添加"跳过动画"选项

4. **状态同步加固**
   - 确保 SSE 事件与 store 状态一致
   - 添加状态过渡动画（fade in/out）
   - 防止界面闪烁

**交付物**：

- 优化后的状态管理组件
- 进度时间模拟配置（扩展 `workbench-stage.ts`）
- 用户体验对比视频/GIF

---

## 四、执行计划

### Phase 1: Prompt 质量提升

- [ ] 分析当前 Prompt 输出样本，记录问题
- [ ] 设计新版 Prompt（System + User）
- [ ] 实现 zh.ts 更新
- [ ] 实现 en.ts 更新
- [ ] 本地测试验证
- [ ] 输出质量对比报告

### Phase 2: Free Tier 支持

- [ ] 设计 job_match_lite Prompt
- [ ] 添加类型定义
- [ ] 实现 Prompt（zh + en）
- [ ] 更新 Task Router
- [ ] 更新 Zod Schema 映射
- [ ] Free 路径 E2E 测试

### Phase 3: UI 重构

- [ ] 审计当前 ResultCard 问题清单
- [ ] 设计新版视觉规范
- [ ] 重构 ResultCard 组件
- [ ] 统一色彩/间距 Token
- [ ] 响应式适配验证
- [ ] Before/After 截图对比

### Phase 4: 任务状态优化

- [ ] 审计当前状态管理问题
- [ ] 设计进度语义化映射
- [ ] 优化 StepperProgress 子步骤显示
- [ ] 修复 StreamPanel 打字机问题
- [ ] 加固状态同步逻辑
- [ ] 用户体验对比演示

---

## 五、验收标准

### Phase 1 验收

- [ ] 新 Prompt 输出包含"过度胜任"风险识别
- [ ] 话术无废话开场（验证禁止词过滤）
- [ ] 评分分布合理（不再普遍偏高）
- [ ] 第二人称"你"一致使用

### Phase 2 验收

- [ ] Free 用户可正常触发 job_match_lite
- [ ] 输出结构与 Standard 版兼容
- [ ] GLM Flash 执行无超时

### Phase 3 验收

- [ ] ResultCard 色彩与 M10 编辑器风格统一
- [ ] 信息层级清晰，一眼抓住重点
- [ ] 移动端适配无溢出

### Phase 4 验收

- [ ] 进度条百分比与实际步骤相关联
- [ ] 步骤切换无视觉跳跃
- [ ] 流式输出无文案重复
- [ ] 整体任务执行"感觉顺滑"

---

## 六、风险与回滚

| 风险                         | 缓解措施                   |
| ---------------------------- | -------------------------- |
| 新 Prompt 导致输出格式不稳定 | 保留旧版 Prompt 作为回滚点 |
| UI 重构影响既有功能          | 分支开发，灰度验证         |
| 状态管理改动引入 regression  | 增加关键路径 E2E 测试      |

---

## 附录：参考文件

### 历史文档

- [docs/16.Execution_Details_M9.md](file:///Users/edisonmbli/Projects/CareerShaper/docs/16.Execution_Details_M9.md)
- [docs/19.Workbench_UI_Revamp_Drafts.md](file:///Users/edisonmbli/Projects/CareerShaper/docs/19.Workbench_UI_Revamp_Drafts.md)
- [docs/20.Workbench_UI_Revamp_Details.md](file:///Users/edisonmbli/Projects/CareerShaper/docs/20.Workbench_UI_Revamp_Details.md)
- [docs/21.Prompt_Eng_job_match.md](file:///Users/edisonmbli/Projects/CareerShaper/docs/21.Prompt_Eng_job_match.md)
- [docs/45.M10_Resume_Customize_Prompt_Optimize.md](file:///Users/edisonmbli/Projects/CareerShaper/docs/45.M10_Resume_Customize_Prompt_Optimize.md)

### 核心代码

- [lib/prompts/zh.ts](file:///Users/edisonmbli/Projects/CareerShaper/lib/prompts/zh.ts) - Prompt 定义
- [lib/prompts/en.ts](file:///Users/edisonmbli/Projects/CareerShaper/lib/prompts/en.ts) - 英文 Prompt
- [components/workbench/ResultCard.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/workbench/ResultCard.tsx) - 结果卡片
- [components/app/ServiceDisplay.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/app/ServiceDisplay.tsx) - 服务主容器
- [components/workbench/StepperProgress.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/workbench/StepperProgress.tsx) - 步骤导航
- [components/workbench/StatusConsole.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/workbench/StatusConsole.tsx) - 状态控制台
- [components/workbench/StreamPanel.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/workbench/StreamPanel.tsx) - 流式面板

### 截图参考

- M9 当前效果：![M9 ResultCard](images/m9_current_resultcard.png)
- M10 目标风格：![M10 Editor](images/m10_target_style.png)
