# PRD & 技术方案：多语言(i18n)及主题(Theme)体验优化

## 1. 现状问题与架构分析

用户痛点：当前 Web App 的**中英文切换**和**亮暗色主题切换**行为不一致，经常出现“跳变”（Flickering/Hydration Mismatch），无论新老用户体验都不完美。

用户的原始诉求希望统一使用 Local Storage 来作为唯一凭证，但从资深架构师的视角来看，在 Next.js Server-Side Rendering (SSR) 的 App Router 架构下，**完全依赖 Local Storage 并非最佳实践**。

### 为什么 Local Storage 对 i18n 是个坑？

- **Theme (主题)**：依靠 Local Storage 是**业界标准**。因为可以利用一段极短的 `inline script`（`next-themes` 所做的事），在浏览器渲染 DOM 之前读取 `localStorage` 并给 `<html>` 标签增加 `.dark` class，这样完全没有跳变。
- **i18n (多语言)**：依靠 Local Storage 是**反模式**。因为服务端在生成 HTML 时，是无法读取客户端的 Local Storage 的！如果以 Local Storage 为准：服务端会渲染出一次英文页面，发送给浏览器 -> 浏览器下载并执行 JS -> 发现 Local Storage 里是中文 -> 强行触发 React 全局重绘。这就导致了严重的“跳变页面”体验。
- **i18n 的业界标准**：是 **URL 路径（如 `/zh/dashboard`） + HTTP Cookie + `Accept-Language` 请求头**。服务端在一开始接到请求时，就能读取 Cookie 和 Request Path，直接渲染出完美的中文 HTML 返回给前端，零跳变！

---

## 2. 优化方案重塑 (The New Proposal)

综合以上架构限制，并结合您的业务诉求（自动推测、记录偏好、二次访问生效），以下是建议的最终产品及技术方案：

### (A) Theme (主题: Light / Dark) —— 坚持 Local Storage

1. **新用户/无记录**：`next-themes` 会自动读取系统设置 `window.matchMedia('(prefers-color-scheme: dark)')`。
2. **手动切换**：UI 触发切换后，立刻存入 `localStorage`，键名为 `theme`。
3. **二次访问**：`next-themes` 会在页面首屏渲染前读取 `localStorage`，无感应用。

### (B) i18n (多语言: zh / en) —— 坚持 Cookie + URL Path

1. **新用户/无记录**：当访问根路径 `/` 时，`middleware.ts` 拦截，通过读取请求的 `Accept-Language` 猜测（比如浏览器是中文操作系统），如果猜不到则 fall back 到 `en`。
2. **中间件跳转**：猜出语言后，中间件通过 302 重定向到对应语言的 URL（如 `/zh` 或 `/en`）。
3. **手动切换**：当用户在右上角点击切换语言，触发一个操作：
   - 更新 HTTP Cookie `lang=zh`（有效期设置长一点，如 1 年）。
   - 将当前页面 URL 从 `/en/...` 替换为 `/zh/...`。
4. **二次访问**：用户下次再打开 `https://domain.com/`：
   - `middleware.ts` 检测到带有 `lang=zh` 的 Cookie。
   - 直接将其重定向到 `/zh`。
   - 由于服务端一开始就知道是 `zh`，SSR 生成中文，完美防止跳变。

### (C) 登录用户的云端同步 (可选进阶)

如果想追求极致体验：无论用户在手机还是电脑端，只要登录了帐号，语言和主题偏好应该跟随。

- 在用户表中（或者一个 Preference 表）增加 `theme` 和 `locale` 字段。
- 当用户登录成功后，从 DB 取出设置，覆盖到当前浏览器的 Cookie (针对 i18n) 和 Local Storage (针对 theme)。
- 这个改动稍大，若当前只需修复客户端跳变，可暂时不实现。

---

## User Review Required

> [!CAUTION]
> **请确认架构分歧**：您最初的想法是全部采用 LocalStorage。我强烈建议 i18n 采用 Cookie + URL，Theme 采用 LocalStorage。这样才能在 Next.js 中 100% 解决您提到的“跳变”问题。您是否同意此架构调整？

---

## 3. Proposed Changes (详细技术实现计划)

### Component 1: i18n Middleware & Types

目前项目中已有 `middleware.ts` 和 `i18n-config.ts`，我们需要加强 Cookie 设置逻辑和一致性校验。

#### [MODIFY] middleware.ts

- 确保 `getLocale` 严格遵循：`Cookie -> Accept-Language -> Default`。
- 如果请求带有 locale prefix（如 `/zh/dashboard`），**同时需要检查 Cookie 是否与 URL 匹配。如果 Cookie 不存在或者不匹配，应当把当前 URL 上的合法 locale 种入 Cookie 中（通过注入 `Set-Cookie` header 给 Response）。**
- 这一步是使得用户通过外链分享进入（如带了 `/zh/r/xxx`）时，也能把用户的默认偏好种下来的关键。

### Component 2: 语言和主题切换器组件 (Header)

目前 Header 右上角的切换器组件需要梳理交互。

#### [MODIFY] components/app/ThemeToggle.tsx (或相应的组件)

- 检查 `<ThemeProvider>` 和其 `next-themes` 的配置。确保 `attribute="class"` 生效，且未发生 hydration mismatch。
- 如果有跳变，一般是在 Client Component mount 之前渲染了错误状态，需要确保 button 不会在未加载时渲染错的 icon（可以利用 react-use 的 `useMounted`，或者 `next-themes` 提供的 `resolvedTheme` 进行 Skeleton 占位）。

#### [MODIFY] components/app/LocaleSwitcher.tsx (或相应的语言切换组件)

- 修改语言切换逻辑：
  - 调用 Next.js `js-cookie` 或者 Server Action 来设置 `lang` Cookie。
  - 使用 `useRouter` 或者是原生 `window.location.href` 跳转到新的 locale path 上。
  - **切记不能只改 route 不改 cookie，或者只改 local storage。**

### Component 3: 杂项梳理与清理

#### [MODIFY] app/layout.tsx

- 检查 `ThemeProvider` 是否包裹在最优层级。
- 确认 `suppressHydrationWarning` 是否添加在 `<html>` 标签上（这对于 `next-themes` 防止开发环境报错至关重要）。

---

## 4. Verification Plan

### Automated Tests

无需复杂单元测试，主要测试中间件：

- 模拟 HTTP 访问 `/`，带/不带 Request Cookie 和 Accept-Language。

### Manual Verification

1. 重置清空浏览器缓存、Cookie 和 Local Storage。
2. 访问 `/`，观察如果系统语言是中文，是否自动重定向到 `/zh` 且没有英文的闪烁跳变。
3. 手动切换 Dark 模式，刷新页面，看到的是否立刻是黑暗模式无“白光一闪”。
4. 手动从 `zh` 切换到 `en`，新开一个 tab 访问 `/`，是否自动去了 `/en`。
5. 关闭浏览器重新打开，配置是否保留。

# Walkthrough: Theme & i18n 偏好持久化

## 问题根因

| 功能           | 旧实现                              | 问题                                                   |
| -------------- | ----------------------------------- | ------------------------------------------------------ |
| **Theme**      | 直接操作 `html.classList`，无持久化 | 刷新后恢复默认，无法记忆                               |
| **i18n**       | `router.push` 切换 URL，不写 Cookie | 下次访问 `/`，中间件不知道用户偏好，重新推断，导致跳变 |
| **middleware** | 只读 Cookie，从不写 Cookie          | 新用户首次访问无法"种下"偏好，形成永久推断循环         |

---

## 变更清单

### 1. [components/app/ThemeProvider.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/app/ThemeProvider.tsx) [NEW]

- 新建 `next-themes` 的 [ThemeProvider](file:///Users/edisonmbli/Projects/CareerShaper/components/app/ThemeProvider.tsx#6-25) 客户端包装组件
- `defaultTheme="system"` → 新用户自动继承 OS 明暗设置
- `attribute="class"` → 通过 `<html class="dark">` 驱动 CSS

### 2. [components/app/ThemeToggle.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/app/ThemeToggle.tsx) [MODIFY]

- 旧：手动 `classList.add/remove('dark')`，无持久化，存在 SSR 不一致
- 新：`useTheme()` hook，`setTheme()` 自动写入 `localStorage`
- 增加 `mounted` 守卫：SSR 时渲染透明占位 icon，等客户端 mount 后才渲染真实状态，**彻底消除 Hydration Mismatch**

### 3. [components/app/I18nToggleCompact.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/app/I18nToggleCompact.tsx) [MODIFY]

- 在 `router.push` 之前，额外写入：
  ```js
  document.cookie = `lang=${nextLocale}; path=/; max-age=31536000; SameSite=Lax`
  ```
- 1年有效期 Cookie，供 middleware 在下次访问 `/` 时读取

### 4. [components/app/I18nToggle.tsx](file:///Users/edisonmbli/Projects/CareerShaper/components/app/I18nToggle.tsx) [MODIFY]

- 同上，`go()` 函数也在路由跳转前写入 `lang` cookie

### 5. [middleware.ts](file:///Users/edisonmbli/Projects/CareerShaper/middleware.ts) [MODIFY]

- **场景 A（无 locale 前缀的请求，如首次访问 `/`）**：推断 locale 后，在 302 重定向响应中注入 `Set-Cookie: lang=xxx`，新用户首次访问即"种草"偏好。
- **场景 B（有 locale 前缀的请求，如 `/zh/r/xxx` 分享链接）**：无 cookie 或 cookie 不匹配时，以 URL locale 为准更新 cookie，令用户下次访问 `/` 也能正确落地。

### 6. [app/layout.tsx](file:///Users/edisonmbli/Projects/CareerShaper/app/layout.tsx) [MODIFY]

- 引入 [ThemeProvider](file:///Users/edisonmbli/Projects/CareerShaper/components/app/ThemeProvider.tsx#6-25) 并包裹所有子内容
- `<html>` 增加 `suppressHydrationWarning` 属性，防止 next-themes 注入 class 时 React 报 hydration 警告

---

## 新用户完整行为流程

```
首次访问 / (无 Cookie, 无 localStorage)
        │
        ▼
  middleware 执行 getLocale()
  → 读 Cookie: 空
  → 读 Accept-Language: 若是 zh-CN, 推断为 zh
  → 302 重定向到 /zh
  → 同时 Set-Cookie: lang=zh  ← 关键新增
        │
        ▼
  浏览器访问 /zh 页面
  → next-themes 读取 localStorage: 空
  → 读取系统 prefers-color-scheme
  → 若系统是暗色则 html.class = 'dark'  ← 无跳变
        │
        ▼
  ✅ 用户看到正确语言 + 正确主题，完全无跳变
```

## 老用户二次访问

```
再次访问 /  (Cookie: lang=zh, localStorage: theme=dark)
        │
        ▼
  middleware 读 Cookie → zh → 302 /zh  (无需推断)
  next-themes 读 localStorage → dark → html.class='dark' (首屏前生效)
        │
        ▼
  ✅ 立刻呈现记忆中的语言 + 主题，零跳变
```

## 验证

- `pnpm tsc --noEmit`: ✅ 0 errors
