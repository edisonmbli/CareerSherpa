# M9 Progress UI & Error Handling Enhancement Plan

## 1. 现状分析 (Current Status Analysis)

### 1.1 Status Console (进度控制台)

- **Current Behavior**:
  - 进度条依赖于 `lib/utils/workbench-stage.ts` 中的硬编码逻辑（如 `OCR_PENDING` 固定为 33%，`SUMMARY_PENDING` 固定为 66%）。
  - 缺乏时间维度的模拟，导致在长耗时任务（如 OCR 或 Summary）期间，进度条长时间静止，用户感知为“卡死”。
  - 状态文案更新不及时，无法反馈细粒度的队列状态（排队中 vs 执行中）。
- **Code Refs**:
  - `components/workbench/StatusConsole.tsx`: 渲染逻辑简单，仅透传 `progress`。
  - `lib/utils/workbench-stage.ts`: `deriveGlobalStatusMessage` 函数中包含大量硬编码的进度值。

### 1.2 StreamPanel (流式面板)

- **Current Behavior**:
  - 仅 `Match` 阶段支持真正的 SSE 流式输出。
  - `OCR` 和 `Job Summary` 阶段为 Batch 模式（轮询或等待 SSE 的 `_result` 事件），面板显示 "Waiting for..." 或静态结果。
  - 阶段切换时（如 Summary -> Match），面板内容会先清空或显示占位符，导致视觉跳变。
  - 存在 Typewriter (打字机) 特效 (`StreamPanel.tsx` L66-71)，在 SSE 高速推送时可能导致渲染卡顿或内容“吞字”。
- **Code Refs**:
  - `components/workbench/StreamPanel.tsx`: `mode` 切换逻辑复杂，Typewriter 逻辑可能多余。
  - `lib/stores/workbench.store.ts`: `appendStreamToken` 仅针对 Match 优化，且 `startTask` 会重置 `streamingResponse`。

### 1.3 Error Handling (异常处理)

- **Current Behavior**:
  - `getServiceErrorMessage` (`lib/utils/service-error-handler.ts`) 在 default 分支直接透传 `errorCode`。
  - 前端 UI（`NewServiceForm`, `ServiceDisplay`）直接展示后端返回的原始错误信息（可能包含堆栈或内部代码），暴露系统细节。
  - Rate Limit 等检查虽然在后端有逻辑，但前端缺乏即时的友好反馈。
- **Code Refs**:
  - `lib/utils/service-error-handler.ts`: Default case leaks `errorCode`.

## 2. 问题清单 (Problem List)

| 模块               | 问题描述                                     | 代码定位                                                      |
| ------------------ | -------------------------------------------- | ------------------------------------------------------------- |
| **Status Console** | 进度条数值硬编码，无动态时间模拟             | `lib/utils/workbench-stage.ts#L396-442`                       |
| **Status Console** | 缺乏 Paid/Free 通道区分的进度策略            | `lib/utils/workbench-stage.ts` (需新增策略)                   |
| **StreamPanel**    | Job Summary / Pre-Match 非流式，用户等待焦虑 | `lib/actions/service.actions.ts` (Batch 模式)                 |
| **StreamPanel**    | 阶段切换时内容闪烁/丢失                      | `lib/stores/workbench.store.ts#L167` (startTask 重置 buffer)  |
| **StreamPanel**    | 打字机特效在 SSE 高速推送时卡顿/吞字         | `components/workbench/StreamPanel.tsx#L66`                    |
| **StreamPanel**    | 流信息内容重复 (JSON 结构重复出现)           | `lib/stores/workbench.store.ts` (append 逻辑) 或 SSE 重连机制 |
| **Error Handling** | 错误信息泄露内部实现细节                     | `lib/utils/service-error-handler.ts#L47`                      |
| **Error Handling** | Rate Limit 缺乏即时友好反馈与引导            | `components/app/NewServiceForm.tsx` & `ServiceDisplay.tsx`    |

## 3. 实施方案 (Implementation Plan)

### Phase 1: 进度模拟引擎升级 (Status Console Enhancement)

**目标**: 实现基于时间的平滑进度条，支持 Paid/Free 不同策略。

1.  **Refactor `workbench.store.ts`**:
    - 扩展 `progressSimulation` 支持所有状态（不仅是 Customize/Interview）。
    - 引入 `ProgressStrategy` 配置接口（预估时长、起止百分比）。
2.  **Update `workbench-stage.ts`**:
    - 废弃硬编码的 `fallbacks` 进度值。
    - 实现 `deriveProgressStrategy(tier, status)`，根据 Paid/Free 通道和当前状态返回对应的进度策略。
    - 参考用户提供的时长表配置策略参数。
3.  **UI Integration**:
    - `ServiceDisplay.tsx` 在侦听到状态变化时，调用 Store 的 `startProgressSimulation` 并传入对应策略的时长。

### Phase 2: 全链路流式化与体验优化 (StreamPanel Enhancement)

**目标**: 解决流式卡顿、内容重复问题，实现平滑的打字机效果。

1.  **Fix Content Duplication (`workbench.store.ts`)**:
    - **Strict Append Protocol**: 审查 `appendStreamToken` 逻辑。确保前端仅做 append 操作，除非遇到明确的 `reset` 指令。
    - **Debug SSE**: 排查 SSE 是否因网络抖动触发重连，导致历史消息被重复推送且未被正确去重（`lastEventId` 机制）。
2.  **Optimize Typewriter Effect (`StreamPanel.tsx`)**:
    - **Adaptive Pacing (自适应步长)**: 替代固定的 `step`。根据缓冲区积压量动态调整打字速度（积压越多，步长越大），确保视觉流畅且不阻塞。
    - **Performance**: 确保打字机逻辑在 `requestAnimationFrame` 中高效执行，避免 React 频繁重渲染导致掉帧。
3.  **Unified Stream Buffer**:
    - 改造 Store，实现 `streamBuffer` 统一缓冲区。
    - 确保阶段切换（如 Summary -> Match）时，保留上一阶段内容，直到新流产生，避免视觉闪烁。
4.  **Backend Stream Support**:
    - 将 `job_summary` 和 `pre_match_audit` 升级为 Stream 模式（或模拟 Stream 日志）。

### Phase 3: 异常处理与引导 (Error Handling & Guidance)

**目标**: 拦截系统错误，提供“人话”反馈与行动引导。

1.  **Rate Limit & Quota Interception**:
    - **Immediate Feedback**: 在 Action 返回 `rate_limited` 或 `daily_limit` 时，前端需立即识别。
    - **Actionable UI**: 不仅展示错误 Toast，而是弹出模态框或醒目提示，告知用户具体原因（如“访问过于频繁”），并提供“充值”或“稍后重试”的按钮引导。（⚠️ 这个逻辑当前应该已实现？需要先 double check）
2.  **Secure Error Mapping (`service-error-handler.ts`)**:
    - 建立白名单机制，仅透传预定义的 `PublicError`。
    - 屏蔽所有 Stack Trace 和未知 Error Code，统一映射为友好的兜底文案。
    - 在开发环境 (`NODE_ENV === 'development'`) 保留详细错误以便调试。

## 4. 下一步行动 (Next Steps)

- [ ] 确认 Worker 侧对 Job Summary 流式输出的支持情况。
- [ ] 开始 Phase 1 代码重构：`workbench.store.ts` 和 `workbench-stage.ts`。
