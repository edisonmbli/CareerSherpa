# Feature: 定制简历分享 (Customized Resume Sharing)

## 1. 背景与目标

目前用户的定制简历仅限个人在 Workbench 中查看和编辑。为了增强简历的流通性和平台的获客能力，我们需要实现“定制简历分享”功能。

**核心目标：**

1.  **用户价值**：提供在线简历链接，方便用户在求职平台、邮件中直接分享，绕过文件格式限制。
2.  **平台价值**：通过分享的简历页面植入“钩子” (Hooks)，将查看简历的潜在用户转化为 CareerShaper 的注册用户。

## 2. 产品需求

### 2.1 简历分享设置 (Workbench - 编辑页)

在定制简历编辑页面 (Step 2) 增加“分享”入口。

- **入口位置**：顶部工具栏（导出按钮旁）。
- **功能点**：
  - **开启/关闭分享**：开关控制。关闭后，原链接立即失效 (404 或 提示已关闭)。
  - **有效期设置**：
    - 7天 (默认)
    - 30天
    - 永久
  - **续期/延期**：
    - 在链接未过期（或已过期）时，可重新选择有效期进行“续期”。
    - 续期操作仅更新 `expireAt`，保持 `shareKey` 不变（确保已发出的链接不失效）。
  - **复制链接**：生成短链接，如 `domain.com/r/AbCd123`。
  - **状态展示**：如果已分享，显示“分享中”状态及过期时间。

### 2.2 公开简历页 (Public View)

当访客访问分享链接时：

- **鉴权逻辑**：
  - 检查链接是否存在且启用 (`isEnabled: true`)。
  - 检查是否过期 (`expireAt > now`)。
  - 如果无效/过期 -> 展示 404 或“链接已失效”页面。
  - 如果有效 -> 展示简历内容。
- **页面布局与设计**：
  - **核心区域**：展示定制简历内容 (Read-only)。
    - 复用现有的渲染逻辑，但移除所有编辑交互 (Hover 边框、点击编辑、拖拽等)。
    - 保持样式与用户编辑的一致 (字体、间距、模板)。
  - **导流 Hook (Watermark Style)**：
    - **设计原则**：低调、优雅、不抢戏，类似高级水印或页脚签名。需使用 `frontend-design` 和 `refactoring-ui-design` 技能确保视觉统一且高级。
    - **位置**：
      - 顶部：极简 Banner (可关闭)。
      - 底部：固定页脚或文末签名 "Powered by CareerShaper AI"。
    - **交互**：点击跳转至 Landing Page。
    - **i18n**：文案需支持国际化。
  - **移动端适配**：确保在手机上查看体验良好。

### 2.3 数据埋点 (Analytics)

记录分享页面的访问来源和转化情况。

- **View Event**: 访客打开分享链接。
  - `event_name`: `RESUME_SHARE_VIEW`
  - `payload`:
    ```json
    {
      "shareId": "...",
      "templateId": "...",
      "source": "web",
      "referrer": "document.referrer", // 记录来源 (e.g. linkedin.com, gmail)
      "utm_source": "query.utm_source", // 支持 URL 参数追踪
      "utm_medium": "query.utm_medium"
    }
    ```
- **Conversion Event**: 访客点击导流按钮。
  - `event_name`: `RESUME_SHARE_CONVERT`
  - `payload`: `{ shareId, target: 'landing_page' }`

## 3. 技术方案

### 3.1 数据库 Schema 变更 (已完成)

新增 `ResumeShare` 模型，用于存储分享配置。

```prisma
model ResumeShare {
  id                 String           @id @default(cuid())
  customizedResumeId String           @unique @map("customized_resume_id") // 一对一，每个定制简历只有一个激活的分享配置
  shareKey           String           @unique @map("share_key")             // 短码，用于 URL
  isEnabled          Boolean          @default(true) @map("is_enabled")
  expireAt           DateTime?        @map("expire_at")

  // 访问统计 (可选，先做简单的计数，详细的走 AnalyticsEvent)
  viewCount          Int              @default(0) @map("view_count")

  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @default(now()) @updatedAt @map("updated_at")

  customizedResume   CustomizedResume @relation(fields: [customizedResumeId], references: [id], onDelete: Cascade)

  @@map("resume_shares")
  @@schema("public")
}
```

### 3.2 路由设计

- **分享页路由**: `/app/[locale]/r/[shareKey]/page.tsx`
  - 使用 `shareKey` 查找对应的 `ResumeShare` -> `CustomizedResume` -> `Service` (获取用户信息等)。
  - 这是一个 Server Component，负责鉴权和数据获取。
  - **注意**：此页面为公开访问，不通过 `stackServerApp.getUser()` 强制鉴权，而是基于 `shareKey` 的有效性。

### 3.3 前端改造

1.  **ResumeStore**:
    - 增加 `readOnly` 状态。
    - 在 `InteractiveSection` 中，如果 `readOnly === true`，禁用点击事件、Hover 样式和编辑按钮。
2.  **ResumePreview**:
    - 支持从 Props 传入 `readOnly` 标志，并传递给 Store 或 Context。
3.  **PublicResumePage**:
    - 初始化 Store 时设置 `readOnly: true`。
    - 渲染 `ResumePreview`。
4.  **UI Components**:
    - 使用 `frontend-design` 技能开发高品质的 `ShareDialog` 和 `HookBanner`。

### 3.4 后端/Action

- `generateShareLink(serviceId, options)`: 创建或更新 `ResumeShare` 记录。支持更新 `expireAt` 实现续期。
- `getSharedResume(shareKey)`: 获取简历数据 (需忽略 `userId` 校验，改为校验 `shareKey`)。
- `disableShareLink(serviceId)`: 设置 `isEnabled = false`。

### 3.5 关于 Profile 页权限的说明

目前 `/profile` 页面通过 `stackServerApp.getUser()` 强制要求用户登录，并基于 Session 获取当前用户信息。因此：

- 它是**私有**的个人中心 (Dashboard)，天然支持多用户（每个用户只能看到自己的）。
- 它不具备“公开访问”属性，因此不存在 ID 遍历或越权访问的问题。
- 本次“简历分享”功能是填补“公开访问”这一场景的空白。

## 4. 任务拆解 (Checklist)

- [x] **Database**: 更新 `schema.prisma` 并生成 Client (User 已完成 Migration)。
- [ ] **DAL**: 实现 `ResumeShare` 的 CRUD 和 `getSharedResume` 方法。
- [ ] **Store**: 更新 `resume-store.ts` 支持 `readOnly` 模式。
- [ ] **Components**:
  - [ ] 改造 `InteractiveSection` 支持 `readOnly`。
  - [ ] (Frontend-Design) 开发 `ShareResumeDialog` 组件 (含续期交互)。
  - [ ] (Frontend-Design) 开发优雅的导流 Banner/Footer 组件。
- [ ] **Page**: 实现 `/r/[shareKey]` 页面及鉴权逻辑。
- [ ] **Analytics**: 埋点接入 (含 Referrer/UTM)。
