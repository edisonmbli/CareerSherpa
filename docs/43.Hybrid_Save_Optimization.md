# Hybrid Save Optimization

> 日期：2026-01-01  
> 状态：✅ 已完成

## 概述

将简历编辑器的保存机制从"自动保存"重构为"混合优化保存"架构，实现：
- 本地脏状态追踪
- 15秒空闲后静默后台保存
- 可见的手动保存按钮
- 页面离开时静默保存
- 增量更新（只发送改变的字段）

---

## 架构图

```
用户编辑 → isDirty=true → 保存按钮出现
       ↓
15s 无操作 → 静默后台保存 → isDirty=false → 按钮隐藏
       ↓
用户点击保存 → 立即保存 + 反馈动效
       ↓
关闭/刷新页面 → 尝试静默保存
```

---

## 代码改动

### 新增文件

| 文件 | 用途 |
|------|------|
| `hooks/use-auto-save.ts` | 15秒空闲自动保存 + 错误重试退避 |
| `hooks/use-exit-protection.ts` | 页面关闭时静默保存 |
| `components/ui/SaveIndicator.tsx` | 保存按钮/状态组件 |

### 修改文件

| 文件 | 改动 |
|------|------|
| `store/resume-store.ts` | 添加 `isDirty`, `dirtyFields`, `markDirty()`, `manualSave()` |
| `components/resume/editor/ResumeToolbar.tsx` | 添加 SaveIndicator |
| `components/workbench/StepCustomize.tsx` | 添加退出保护 + 移动端 FAB |
| `lib/dal/services.ts` | 所有字段改为可选，支持增量更新 |
| `lib/actions/resume.actions.ts` | resumeData 改为可选，按需验证 |

---

## 关键设计决策

### 1. 脏状态追踪

```typescript
// store/resume-store.ts
isDirty: boolean
dirtyFields: Array<'resumeData' | 'sectionConfig' | 'styleConfig'>
lastLocalChangeAt: number | null
```

所有数据变更 action 调用 `markDirty(field)` 而不是直接 `save()`。

### 2. 增量更新

**之前**：每次保存都发送全部 3 个 JSON 字段（~15KB）

**之后**：只发送 `dirtyFields` 中记录的字段

```typescript
// 只修改颜色时的 payload
{ serviceId: "xxx", opsJson: { styleConfig, currentTemplate } }
// 约 0.5KB，减少 97%
```

### 3. 错误重试退避

```typescript
// hooks/use-auto-save.ts
MIN_RETRY_DELAY = 15000   // 15秒
MAX_RETRY_DELAY = 360000  // 6分钟
MAX_CONSECUTIVE_ERRORS = 5

// 15s → 30s → 60s → 120s → 240s → 停止
```

### 4. UI 状态机

| 状态 | 桌面端 | 移动端 |
|------|--------|--------|
| Hidden | 不渲染 | 不渲染 |
| Dirty | Ghost 按钮 "保存" | 蓝色圆形 FAB |
| Success | 灰色文字 "✓ 已保存" (2s) | 绿色圆形 FAB (2s) |

---

## 性能提升

| 操作 | 优化前 | 优化后 | 减少 |
|------|--------|--------|------|
| 修改姓名 | ~15KB | ~2KB | **-87%** |
| 更换颜色 | ~15KB | ~0.5KB | **-97%** |
| 数据库写入 | 3 字段 | 1 字段 | **-67%** |

---

## 验证方法

1. 打开浏览器 Network 面板
2. 修改姓名 → 检查请求 payload 只包含 `resumeData`
3. 更换颜色 → 检查请求 payload 只包含 `opsJson`
4. 观察 "已保存" 提示 2 秒后自动消失

---

## 相关文件

- [resume-store.ts](../store/resume-store.ts) - Zustand store
- [use-auto-save.ts](../hooks/use-auto-save.ts) - 自动保存 hook
- [use-exit-protection.ts](../hooks/use-exit-protection.ts) - 退出保护 hook
- [SaveIndicator.tsx](../components/ui/SaveIndicator.tsx) - UI 组件
- [services.ts](../lib/dal/services.ts) - DAL 层
- [resume.actions.ts](../lib/actions/resume.actions.ts) - Server Action
