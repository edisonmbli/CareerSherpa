# 文档 3：项目重构执行规划

**目标**：将“解决方案文档（文档 2）”中定义的宏大蓝图，拆解为一系列**依赖清晰**、**任务原子化**（AI IDE 友好）、**职责明确**的执行里程碑。

**核心原则**：

- M0-M1 (环境/DB)
- M2 (Auth/Quota)
- M3 (Design System)
- M4 (LLM Abstraction)
- M5 (RAG System)
- M6 (Scheduler)
- M7: Analytics 基建
- M8: 资产流
- M9: 核心服务流
- M10: 辅助流与支付替身
- M11: 收尾与上线

---

### M0：环境与密钥就绪 (The "Ground Zero")

- **目标**：为重构工作准备好所有外部依赖和 API 密钥。

| 职责                         | 任务                                                                             | 描述                                                                                                  |
| :--------------------------- | :------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------- |
| **项目 Owner 任务**          | 1. 核心服务开通 (关键\!)                                                         | - **Neon** (DB)、**Neon Auth** (Auth)、**Upstash** (QStash + Redis)、**LLM 供应商** (DeepSeek, GLM)。 |
| **项目 Owner 任务**          | 1. 仓库清理与安装                                                                | - 清理原型代码（`llm-scheduler.ts` 等）、安装依赖、配置 Vercel 环境变量。                             |
| **Definition of Done (DoD)** | - `pnpm dev` 成功。<br>- **所有**外部 API 密钥均已在 Vercel 环境变量中配置完毕。 |

---

### M1：数据库与 DAL 重置 (The "Blueprint")

- **目标**：**彻底重置**数据库，应用“文档 2.4”中的新 `schema.prisma`。

| 职责                         | 任务                                                                   | 描述                                                         |
| :--------------------------- | :--------------------------------------------------------------------- | :----------------------------------------------------------- |
| **项目 Owner 任务**          | 1. 替换 Schema                                                         | - **粘贴** 文档 2.4 中的新 Schema 内容。                     |
| **项目 Owner 任务**          | 2. 数据库重置 (关键\!)                                                 | - 执行 `pnpm dlx prisma migrate reset`（**清空所有数据**）。 |
| **项目 Owner 任务**          | 3. 启用 pgvector                                                       | - 确保 `pgvector` 扩展在 Neon DB 中已启用。                  |
| **Definition of Done (DoD)** | - `prisma migrate reset` 成功完成。<br>- `pgvector` 已在数据库中启用。 |

---

### M2：认证与金币系统 (The "Business Foundation")

- **目标**：构建“金币”系统 (2.2.4)，并**显式**集成认证（Auth） 与业务逻辑。
- **依赖**：M1 (新的 `Quota` 表, `users_sync` 表)。

| 职责                         | 任务                                                                                                                        | 描述                                                                                                                |
| :--------------------------- | :-------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------ |
| **AI IDE 任务**              | **1. 实现 Auth 封装**                                                                                                       | - 创建 `lib/auth/wrapper.ts`（可复用原型 `auth-wrapper.ts`），提供 `withAuth` 中间件，用于保护所有 Server Actions。 |
| **AI IDE 任务**              | 2. 实现原子化 DAL                                                                                                           | - 在 `lib/dal/quotas.ts` 中，使用 `prisma.$transaction` 实现 `deductQuota` 和 `addQuota` 函数 (2.2.4)。             |
| **AI IDE 任务**              | 3. 实现 `getOrCreateQuota`                                                                                                  | - 在 `lib/dal/quotas.ts` 中，实现“延迟初始化”逻辑 (2.1.4)，为首次操作的用户创建金币记录。                           |
| **AI IDE 任务**              | 4. 实现 QStash 状态轮询 API                                                                                                 | - 创建 `GET /api/task-status` 路由 (2.3.0)。                                                                        |
| **Definition of Done (DoD)** | - `withAuth` 中间件能成功保护一个测试 Action。<br>- `deductQuota` / `addQuota` / `getOrCreateQuota` 通过单元测试 (Vitest)。 |

---

### M3：设计系统与 UI 基建 (The "Design DNA")

- **目标**：将「Solution Spec 2.6」 的规范代码化，**在所有 UI 页面构建前**，统一视觉，**需包含明、暗主题**。
- **依赖**：M0。

| 职责                         | 任务                                                                                                                                                                                                                                              | 描述                                                                                                                                      |
| :--------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------- |
| **AI IDE 任务**              | **1. `tailwind.config.ts` 校准**                                                                                                                                                                                                                  | - 按照「2.6.3」 和「2.6.4」 规范，配置 `shadcn/ui` 主题色、字体。                                                                         |
| **AI IDE 任务**              | 2. `globals.css` 校准                                                                                                                                                                                                                             | - 按照「2.6.4」 规范，设置基础 `body` 的 `line-height` 和 `text-foreground`。                                                             |
| **AI IDE 任务**              | 3. 创建“设计系统测试页”                                                                                                                                                                                                                           | - 创建一个 `(dev)/design-system` 路由。<br>- 在此页面上展示所有规范元素（H1/H2/Body、色彩、Buttons、Cards、Alerts），确保视觉 100% 达标。 |
| **AI IDE 任务**              | 4. 实现 i18nToggle 组件                                                                                                                                                                                                                           | - 创建 components/i18n-toggle.tsx 切换器（例如一个 Button 显示“EN/中”）                                                                   |
| **Definition of Done (DoD)** | - `/design-system` 测试页能完美复现「文档 2.6」 中定义的所有视觉规范。 <br> - 在 /design-system 测试页 上，必须演示：1. 该组件能正确获取当前 locale。2.页面上的所有静态文本均来自 getDictionary。3.点击切换器能正确刷新路由并加载另一种语言的字典 |

---

### M4：AI 基建 - LLM 抽象层

- **目标**：构建一个**与供应商解耦**的 LLM 调用服务，复用原型（Prototype）中的 `LangChain` 思想和 `prompts`。
- **依赖**：M0 (LLM API 密钥)。

| 职责                         | 任务                                                                                                                                                                                                          | 描述                                                                                                                                                                                                                                                                         |
| :--------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **AI IDE 任务**              | **1. 创建 LLM Provider**                                                                                                                                                                                      | - 更新 `lib/llm/provider.ts`。<br>- 使用 `LangChain`（或自定义封装）来包装 `DeepSeek` 和 `GLM` 的 `invoke` 和 `stream` 方法。<br>- prototype 已覆盖 text、vision 任务用到的模型，需要增加 zhipu 的 embedding-3 用于 RAG 向量模型 (在 llm/embeddings.ts 中有类似实，考虑统一) |
| **AI IDE 任务**              | **2. 创建 Prompt 模板**                                                                                                                                                                                       | - 已有中、英文 prompt 模板： `lib/prompts/zh.ts`、`lib/prompts/zh.ts`。<br>- **复用原型**：评估并合理复用现有模板。<br>- 如有需要，对 prompt 系统的架构作合理调整，以便后续灵活、高效调用。e.g. 中英文是否需要分文件夹存放？                                                 |
| **AI IDE 任务**              | **3. 创建 LLM Service**                                                                                                                                                                                       | - 创建 `lib/llm/service.ts`。<br>- 封装一个 `runLlmTask(taskName, context)` 函数，它负责：1. 从 locale 对应的 prompt 模板文件获取 Prompt -\> 2. 调用 `provider.ts` 执行。                                                                                                    |
| **Definition of Done (DoD)** | - `lib/llm/service.ts` 可以通过单元测试，成功调用 `DeepSeek` 和 `GLM` 并返回结果。<br>- lib/llm/service.ts 中的 runLlmTask 必须接受 locale: 'en' \| 'zh' 参数，并根据 locale 动态加载对应语言的 Prompt 模板。 |

---

### M5：AI 基建 - RAG 系统

- **目标**：将 RAG 作为**独立的 AI 基础模块** 一次性构建完成，服务于后续所有业务。
- **依赖**：M1 (pgvector)、M4 (Embedding 模型调用)。

| 职责                         | 任务                                                                                                          | 描述                                                                                                                                                                                                                                                                                                                 |
| :--------------------------- | :------------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **项目 Owner 任务**          | **1. 提供“求职宝典”**                                                                                         | - **(关键)** 提供一份**完整**的“求职宝典”原始文档（Markdown, PDF 等）。必须提供“求职宝典”的中英双语版本。                                                                                                                                                                                                            |
| **AI IDE 任务**              | **1. RAG 入库脚本**                                                                                           | - 实现 2.2.2 中的“离线入库”脚本（`scripts/ingest-rag-docs.ts`）。<br>- 脚本功能：读取文档 -\> 分块 (Chunking) -\> 调用 M4 的 LLM 抽象层获取 Embedding -\> 存入 `KnowledgeEntry` 表。<br>- ingest-rag-docs.ts 脚本在解析文档时，必须为其打上 lang: 'en' 或 lang: 'zh' 标记，并存入 KnowledgeEntry 表 的新 lang 字段。 |
| **AI IDE 任务**              | **2. RAG 检索器**                                                                                             | - 实现 2.2.2 中的“在线检索”模块（`lib/rag/retriever.ts`）。<br>- 封装一个 `queryRag(queryText, category)` 函数，用于从 `pgvector` 检索 Top-K 文本块。<br>- queryRag 函数必须接受 locale 参数，并在 pgvector 查询时严格 WHERE lang = locale。                                                                         |
| **AI IDE 任务**              | **3. (Owner 配合) 执行入库**                                                                                  | - AI IDE 运行 `ingest-rag-docs.ts` 脚本，将“求职宝典” 完整导入数据库。                                                                                                                                                                                                                                               |
| **Definition of Done (DoD)** | - `KnowledgeEntry` 表 中已填入向量化数据。<br>- `queryRag("面试技巧")` 函数能通过单元测试，返回相关的文本块。 |

---

### M6：异步基建 - LLM 调度器 (The "Plumbing")

- **目标**：**新建**基于 `Upstash QStash` + `Upstash Redis` 的调度器 (2.2.3)，验证“背压”(2.3.0) 和“并发锁”(2.2.3) 机制。
- **依赖**：M0 (Upstash API)、**M4 (LLM 抽象层)**。
- 需用到@upstash/qstash 包、@upstash/redis 包

| 职责                         | 任务                                                                                                                                                                                                      | 描述                                                                                                          |
| :--------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------ |
| **AI IDE 任务**              | 1. 实现 Redis 并发锁                                                                                                                                                                                      | - `lib/redis/lock.ts` (2.2.3)。                                                                               |
| **AI IDE 任务**              | 2. 实现 Redis 背压计数器                                                                                                                                                                                  | - `lib/redis/counter.ts` (2.3.0)。                                                                            |
| **AI IDE 任务**              | 3. 创建 QStash 生产者                                                                                                                                                                                     | - `lib/queue/producer.ts` (2.2.3)。                                                                           |
| **AI IDE 任务**              | 4. 创建一个“测试 Worker”                                                                                                                                                                                  | - `api/worker/test-worker`。<br>- 此 Worker 必须调用 **M4 的 `lib/llm/service.ts`** (并发锁/计数器逻辑不变)。 |
| **Definition of Done (DoD)** | - E2E 测试：推送 3 个 text 任务 (并发 1)、2 个 vision 任务 (并发 2)。<br>- 验收：本地日志显示 3 个 text 任务 **LLM 调用**串行执行，2 个 vision 任务 **LLM 调用**并行执行，队列之间不冲突，KV 计数器归零。 |

---

### M7: Analytics 基建 (The "Nervous System")

- **目标**：构建 MVP 阶段的“数据所有权”地基 (2.2.6)。
- **依赖**：M1 (DB), M2 (User ID)。

| 职责                         | 任务                                                                                                 | 描述                                                                                               |
| :--------------------------- | :--------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------- |
| **项目 Owner 任务**          | 1. 确认 MVP 指标                                                                                     | - 确认 2.2.6 中定义的“MVP 核心事件”列表（`USER_SIGNED_UP`, `TASK_CREATED` 等）。                   |
| **AI IDE 任务**              | **1. `AnalyticsEvent` 表**                                                                           | - 将 2.4 中的 `AnalyticsEvent` 模型添加到 `schema.prisma`，并执行 `prisma migrate dev`。           |
| **AI IDE 任务**              | **2. `trackEvent` 服务**                                                                             | - 创建 `lib/analytics.ts` 模块，并实现 `trackEvent(userId, eventName, payload)` 异步函数 (2.2.6)。 |
| **Definition of Done (DoD)** | - `trackEvent` 函数通过单元测试。<br>- 调用 `trackEvent` 后，`AnalyticsEvent` 表中能正确查到新纪录。 |

---

### M8：资产流实现 (The "First Usable Feature")

- **目标**：构建 `Profile Page` (2.5) 并实现 `Resume` / `DetailedResume` 的异步上传 (2.3)。
- **依赖**：M2 (Auth/Quota), M3 (Design System), M4 (LLM Service), M6 (Scheduler), M7 (Analytics)。

| 职责                         | 任务                                                                                                                                                                                                                                                                                    | 描述                                                                                                                                           |
| :--------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------- |
| **AI IDE 任务**              | 1. 构建 Profile 页面 UI                                                                                                                                                                                                                                                                 | - 创建 `app/[locale]/profile/page.tsx`，**必须**使用 **M3** 的设计规范 (2.5)。                                                                 |
| **AI IDE 任务**              | 2. 实现 `uploadResumeAction`                                                                                                                                                                                                                                                            | - (核心) 实现 2.3 中的 `uploadResumeAction` (Server Action)。<br>- **(串联)** 调用 M2 (Quota) -\> M6 (Pressure Check) -\> M6 (QStash Push)。   |
| **AI IDE 任务**              | 3. 实现 `resume-worker`                                                                                                                                                                                                                                                                 | - `api/worker/resume`。<br>- **(串联)** M6 (Lock) -\> **M4 (LLM Service)** -\> M2 (DAL update, Quota Reversal) -\> M6 (Unlock, Decr Counter)。 |
| **AI IDE 任务**              | 4. 实现前端轮询                                                                                                                                                                                                                                                                         | - 在 `Profile Page` 实现 2.3.0 的轮询逻辑 (调用 M2 的 `task-status` API)。                                                                     |
| **AI IDE 任务**              | 5. 重复                                                                                                                                                                                                                                                                                 | - 重复 2, 3, 4，实现 `DetailedResume` 流程。                                                                                                   |
| **AI IDE 任务**              | 6. 注入 Analytics                                                                                                                                                                                                                                                                       | - 在 `uploadResumeAction` 和 `uploadDetailedResumeAction` 成功后，**必须**调用 `trackEvent(userId, 'ASSET_UPLOADED', ...)`                     |
| **Definition of Done (DoD)** | - E2E 测试：新用户登录，上传 `resume.pdf`，前端显示“降级提示”(Toast) 和“解析中”(Polling)。<br>- 轮询结束，`Card` 状态变为 `COMPLETED`。`Quota` 余额正确。<br>- Profile Page 和 Workbench Page 的所有 UI 文本（标签、按钮、描述）严禁硬编码。必须 100% 通过 getDictionary(locale) 加载。 |

---

### M9：核心服务流实现 (The "Core Loop")

- **目标**：实现高频的 `createService` 流程 (2.3)，包括图片/文本处理和 SSE 流式 (FR-3.7)。
- **依赖**：M3 (Design System), M4 (LLM Service), **M5 (RAG System)**, M6 (Scheduler), M7 (Analytics), M8 (Resume 资产)。

| 职责                         | 任务                                                                                                                                                                                                                                                                                                                                               | 描述                                                                                                                                                                                                                        |
| :--------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **AI IDE 任务**              | 1. Workbench 页面 UI                                                                                                                                                                                                                                                                                                                               | - 创建 `app/[locale]/workbench/page.tsx`，实现 2.5 的“两列布局”，**必须**使用 **M3** 规范。                                                                                                                                 |
| **AI IDE 任务**              | 2. 实现 `createServiceAction`                                                                                                                                                                                                                                                                                                                      | - 实现 2.3 中的 `createServiceAction`。<br>- (关键) 必须包含 `Resume` 存在性检查 (FR-2.2) 和“文本 vs 图片” 处理。                                                                                                           |
| **AI IDE 任务**              | 3. 实现 `job-worker` (OCR)                                                                                                                                                                                                                                                                                                                         | - `api/worker/job` (调用 **M4** 的视觉 LLM)。                                                                                                                                                                               |
| **AI IDE 任务**              | 4. 实现 `match-worker` (SSE)**(串联)**                                                                                                                                                                                                                                                                                                             | - `api/worker/match`。<br>- 1. M6 (Lock) -\> 2. **M5 (RAG Retriever)** -\> 3. **M4 (LLM Stream)** -\> 4. SSE (FR-3.7) -\> 5. M6 (Unlock, Decr Counter)。                                                                    |
| **AI IDE 任务**              | 5. 实现 SSE 客户端                                                                                                                                                                                                                                                                                                                                 | - 在 `Workbench` 实现 2.3 (Case B) 的 SSE 接收。                                                                                                                                                                            |
| **AI IDE 任务**              | 6. 注入 Analytics                                                                                                                                                                                                                                                                                                                                  | - 在 `createServiceAction` 中，**必须**调用 `trackEvent(userId, 'TASK_CREATED', ...)` 并传入 `isFree` 状态。<br>- 在 `match-worker` 成功或失败时，**必须**调用 `trackEvent(userId, 'TASK_COMPLETED' \| 'TASK_FAILED', ...)` |
| **Definition of Done (DoD)** | - E2E 测试 (文本)：用户粘贴 JD，`match` 结果**流式**返回。<br>- E2E 测试 (图片)：用户上传截图，前端显示“解析中”，然后自动开始**流式**返回 `match` 结果。<br>- **RAG 生效**：返回的结果中包含“求职宝典” 中的知识点。 <br>- Profile Page 和 Workbench Page 的所有 UI 文本（标签、按钮、描述）严禁硬编码。必须 100% 通过 getDictionary(locale) 加载。 |

---

### M10：辅助流与商业化 (The "Extras")

- **目标**：完成 Step 2/3 (`customize`, `interview`) (2.3)，并闭环“金币购买”流程 (2.2.4)。
- **依赖**：M9。

| 职责                         | 任务                                                                                                                                                   | 描述                                                                                                                                                                                                                                                                                                  |
| :--------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **项目 Owner 任务**          | 无                                                                                                                                                     | - 无                                                                                                                                                                                                                                                                                                  |
| **AI IDE 任务**              | 1. 实现 `customize` 流程                                                                                                                               | - (串联) `customizeResumeAction` + `api/worker/customize` (调用 **M4**+**M5**) + 前端轮询 (2.3)。                                                                                                                                                                                                     |
| **AI IDE 任务**              | 2. 实现 `interview` 流程                                                                                                                               | - (串联) `generateInterviewTipsAction` + `api/worker/interview` (调用 **M4**+**M5**，SSE) (2.3)。                                                                                                                                                                                                     |
| **AI IDE 任务**              | 3. 实现 Markdown 编辑器                                                                                                                                | - (FR-6.2) 和“导出 PDF” (FR-6.3)。                                                                                                                                                                                                                                                                    |
| **AI IDE 任务**              | 4. 实现支付意愿收集                                                                                                                                    | 1. **数据库**：在 `schema.prisma` 中添加 `PaymentWaitlist` 模型，并执行 `prisma migrate dev`。 <br>2. **后端**：创建 `joinPaymentWaitlistAction` (Server Action)，用于接收邮箱并写入 `PaymentWaitlist` 表。 <br>3. **前端**：修改 `Profile Page` (Tab 2) 的 UI，实现“即将上线”表单 (遵从 M3 设计规范) |
| **AI IDE 任务**              | 5. 注入 Analytics                                                                                                                                      | - 在 `customize` 和 `interview` 的 Actions 和 Workers 中，注入 `TASK_CREATED`, `TASK_COMPLETED`, `TASK_FAILED` 事件。<br>- 在 `joinPaymentWaitlistAction` 成功后，**必须**调用 `trackEvent(userId, 'WAITLIST_JOINED')`                                                                                |
| **Definition of Done (DoD)** | - E2E 测试：用户可以完整跑通 `Match` -\> `Customize` -\> `Interview` 三步。<br>- E2E 测试：用户在 Profile 页提交邮箱，PaymentWaitlist 表中出现新纪录。 |

---

### M11：收尾与 MVP 上线 (The "Go-Live")

- **目标**：完成所有收尾工作，打磨 UI/UX 细节，准备 MVP 正式发布。
- **依赖**：M10。

| 职责                         | 任务                                                                                         | 描述                                                                                                                                                                                   |
| :--------------------------- | :------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **项目 Owner 任务**          | 1. 最终验收                                                                                  | - (Owner) 对 M0-M9 的所有功能进行完整的 E2E 回归测试。                                                                                                                                 |
| **项目 Owner 任务**          | 2. 部署公域 Analytics                                                                        | - (Owner) 为 Vercel 项目**启用 Vercel Analytics**（用于 PV/UV 和 Web Vitals）。                                                                                                        |
| **AI IDE 任务**              | 1. 页面打磨 (Landing)                                                                        | - 实现 2.5 中的 `Landing Page` (`/`)。                                                                                                                                                 |
| **AI IDE 任务**              | 2. SEO (On-Page) 实现                                                                        | - 为 Landing Page (M10.1) 和其他（未来可能有的）公共页面实现 generateMetadata 函数。<br>- title 和 description 必须能根据 [locale] 动态变化。                                          |
| **AI IDE 任务**              | 3. SEO (Structured Data) 实现                                                                | - 在 Landing Page 中添加 JSON-LD 脚本（SoftwareApplication 类型），以实现“GEO (Generative Engine Optimization)” 目标。                                                                 |
| **AI IDE 任务**              | 4. SEO (Technical) 实现                                                                      | - 创建 app/sitemap.ts 和 app/robots.ts 文件。<br>- sitemap.xml 必须能自动生成所有 i18n 版本的公共页面路径（例如 /en 和 /zh）。robots.txt 必须允许 Googlebot 抓取，并指向 sitemap.xml。 |
| **AI IDE 任务**              | 5. 响应式适配 (Mobile)                                                                       | - 按照 2.5 中的移动端适配方案（`Sidebar` 变 `Drawer`，`Editor` 变 `Tabs`），对所有页面进行适配 (FR-6.1)。                                                                              |
| **AI IDE 任务**              | 6. 辅助功能                                                                                  | - 实现 `i18n` 切换 (FR-6.4) 和“明暗主题”切换 (FR-6.5)。将 M3 中构建的 i18nToggle 组件，正式添加到 Sidebar (桌面端) 和 Drawer (移动端) 中。                                             |
| **Definition of Done (DoD)** | - 所有 M0-M9 的 DoD 均通过回归测试。<br>- 网站在桌面端和移动端上均表现良好。<br>- 准备上线！ |
