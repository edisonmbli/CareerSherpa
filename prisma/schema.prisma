generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["neon_auth", "public"]
}

model Resume {
  id                String          @id @default(cuid())
  title             String?
  lang              String?
  originalText      String?         @map("original_text")
  structuredJson    Json?           @map("structured_json")
  resumeSummaryJson Json?           @map("resume_summary_json")
  promptTokens      Int?            @map("prompt_tokens")
  completionTokens  Int?            @map("completion_tokens")
  totalTokens       Int?            @map("total_tokens")
  active            Boolean         @default(true)
  sourceType        String?         @map("source_type")
  contentType       String?         @map("content_type")
  charCount         Int?            @map("char_count")
  mediaBase64       String?         @map("media_base64")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  userId            String          @map("user_id")
  resume_versions   ResumeVersion[]
  user              users_sync      @relation(fields: [userId], references: [id])
  services          Service[]

  @@index([userId, active])
  @@map("resumes")
  @@schema("public")
}

model DetailedResume {
  id                  String     @id @default(cuid())
  title               String?
  lang                String?
  originalText        String?    @map("original_text")
  detailedSummaryJson Json?      @map("detailed_summary_json")
  promptTokens        Int?       @map("prompt_tokens")
  completionTokens    Int?       @map("completion_tokens")
  totalTokens         Int?       @map("total_tokens")
  sourceType          String?    @map("source_type")
  contentType         String?    @map("content_type")
  charCount           Int?       @map("char_count")
  mediaBase64         String?    @map("media_base64")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")
  userId              String     @map("user_id")
  user                users_sync @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("detailed_resumes")
  @@schema("public")
}

model JobDescription {
  id               String     @id @default(cuid())
  title            String?
  source           String?
  rawText          String?    @map("raw_text")
  parsedJson       Json?      @map("parsed_json")
  jobSummaryJson   Json?      @map("job_summary_json")
  promptTokens     Int?       @map("prompt_tokens")
  completionTokens Int?       @map("completion_tokens")
  totalTokens      Int?       @map("total_tokens")
  lang             String?
  sourceType       String?    @map("source_type")
  contentType      String?    @map("content_type")
  charCount        Int?       @map("char_count")
  mediaBase64      String?    @map("media_base64")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  userId           String     @map("user_id")
  user             users_sync @relation(fields: [userId], references: [id])
  services         Service[]

  @@index([userId, lang, createdAt])
  @@map("job_descriptions")
  @@schema("public")
}

model Service {
  id             String         @id @default(cuid())
  resumeId       String?        @map("resume_id")
  jobId          String         @map("job_id")
  status         ServiceStatus  @default(created)
  depth          ServiceDepth?
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  userId         String         @map("user_id")
  jobDescription JobDescription @relation(fields: [jobId], references: [id])
  resume         Resume?        @relation(fields: [resumeId], references: [id])
  user           users_sync     @relation(fields: [userId], references: [id])
  tasks          Task[]

  @@index([userId, createdAt])
  @@map("services")
  @@schema("public")
}

model Task {
  id               String       @id @default(cuid())
  serviceId        String       @map("service_id")
  kind             TaskKind
  status           TaskStatus   @default(pending)
  inputContextJson Json?        @map("input_context_json")
  contextRefs      Json?        @map("context_refs")
  startedAt        DateTime?    @map("started_at")
  finishedAt       DateTime?    @map("finished_at")
  meta             Json?
  createdAt        DateTime     @default(now()) @map("created_at")
  requestedBy      String       @map("requested_by")
  outputs          TaskOutput[]
  user             users_sync   @relation(fields: [requestedBy], references: [id])
  service          Service      @relation(fields: [serviceId], references: [id])

  @@index([serviceId, kind, status])
  @@map("tasks")
  @@schema("public")
}

model TaskOutput {
  id                 String   @id @default(cuid())
  taskId             String   @map("task_id")
  version            Int
  previousResponseId String?  @map("previous_response_id")
  outputJson         Json?    @map("output_json")
  outputText         String?  @map("output_text")
  model              String?
  provider           String?
  inputTokens        Int?     @map("input_tokens")
  outputTokens       Int?     @map("output_tokens")
  cost               Decimal? @db.Decimal(10, 6)
  createdAt          DateTime @default(now()) @map("created_at")
  task               Task     @relation(fields: [taskId], references: [id])

  @@unique([taskId, version])
  @@index([taskId, createdAt])
  @@map("task_outputs")
  @@schema("public")
}

model ResumeVersion {
  id           String   @id @default(cuid())
  resumeId     String   @map("resume_id")
  sourceTaskId String?  @map("source_task_id")
  version      Int
  contentText  String?  @map("content_text")
  diffJson     Json?    @map("diff_json")
  createdAt    DateTime @default(now()) @map("created_at")
  resume       Resume   @relation(fields: [resumeId], references: [id])

  @@unique([resumeId, version])
  @@map("resume_versions")
  @@schema("public")
}

model Quota {
  id           String     @id @default(cuid())
  initialGrant Int        @default(0) @map("initial_grant")
  purchased    Int        @default(0)
  used         Int        @default(0)
  updatedAt    DateTime   @updatedAt @map("updated_at")
  userId       String     @unique @map("user_id")
  remaining    Int        @default(0)
  user         users_sync @relation(fields: [userId], references: [id])

  @@map("quotas")
  @@schema("public")
}

model Payment {
  id               String        @id @default(cuid())
  stripeCheckoutId String?       @unique @map("stripe_checkout_id")
  amount           Decimal       @db.Decimal(10, 2)
  currency         String
  status           PaymentStatus @default(pending)
  createdAt        DateTime      @default(now()) @map("created_at")
  userId           String        @map("user_id")
  user             users_sync    @relation(fields: [userId], references: [id])

  @@map("payments")
  @@schema("public")
}

model TokenUsageLog {
  id           String     @id @default(cuid())
  serviceId    String?    @map("service_id")
  taskId       String?    @map("task_id")
  provider     String?
  model        String?
  inputTokens  Int?       @map("input_tokens")
  outputTokens Int?       @map("output_tokens")
  cost         Decimal?   @db.Decimal(10, 6)
  createdAt    DateTime   @default(now()) @map("created_at")
  userId       String     @map("user_id")
  user         users_sync @relation(fields: [userId], references: [id])

  @@map("token_usage_logs")
  @@schema("public")
}

model IdempotencyKey {
  key       String          @id
  userKey   String          @map("user_key")
  step      IdempotencyStep
  ttlMs     Int             @map("ttl_ms")
  createdAt DateTime        @default(now()) @map("created_at")

  @@map("idempotency_keys")
  @@schema("public")
}

model AuditLog {
  id         String     @id @default(cuid())
  action     String
  entityType String     @map("entity_type")
  entityId   String     @map("entity_id")
  metadata   Json?
  createdAt  DateTime   @default(now()) @map("created_at")
  userId     String     @map("user_id")
  user       users_sync @relation(fields: [userId], references: [id])

  @@map("audit_logs")
  @@schema("public")
}

model users {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerkUserId String   @unique @map("clerk_user_id")
  email       String   @unique
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  firstName   String?  @map("first_name")
  imageUrl    String?  @map("image_url")
  lastName    String?  @map("last_name")

  @@map("users")
  @@schema("public")
}

model users_sync {
  raw_json         Json
  id               String           @id @default(dbgenerated("(raw_json ->> 'id'::text)"))
  name             String?          @default(dbgenerated("(raw_json ->> 'display_name'::text)"))
  email            String?          @default(dbgenerated("(raw_json ->> 'primary_email'::text)"))
  created_at       DateTime?        @default(dbgenerated("to_timestamp((trunc((((raw_json ->> 'signed_up_at_millis'::text))::bigint)::double precision) / (1000)::double precision))")) @db.Timestamptz(6)
  updated_at       DateTime?        @db.Timestamptz(6)
  deleted_at       DateTime?        @db.Timestamptz(6)
  auditLogs        AuditLog[]
  detailedResumes  DetailedResume[]
  documents        Document[]
  jobDescriptions  JobDescription[]
  knowledgeEntries KnowledgeEntry[]

  payments         Payment[]
  quotas           Quota?
  resumes          Resume[]
  services         Service[]
  tasks            Task[]
  tokenUsageLogs   TokenUsageLog[]

  @@index([deleted_at])
  @@schema("neon_auth")
}



model Document {
  id         String                 @id @default(cuid())
  content    String
  embedding  Unsupported("vector")?
  sourceType DocumentSourceType     @map("source_type")
  sourceId   String                 @map("source_id")
  userId     String                 @map("user_id")
  metadata   Json?                  @default("{}")
  chunkIndex Int?                   @map("chunk_index")
  createdAt  DateTime               @default(now()) @map("created_at")
  updatedAt  DateTime               @updatedAt @map("updated_at")
  user       users_sync             @relation(fields: [userId], references: [id])

  @@index([userId, sourceType, sourceId])
  @@index([sourceType, sourceId])
  @@map("documents")
  @@schema("public")
}

model KnowledgeEntry {
  id        String                 @id @default(cuid())
  content   String
  embedding Unsupported("vector")?
  title     String?
  category  String?
  userId    String                 @map("user_id")
  metadata  Json?                  @default("{}")
  isPublic  Boolean                @default(false) @map("is_public")
  createdAt DateTime               @default(now()) @map("created_at")
  updatedAt DateTime               @updatedAt @map("updated_at")
  user      users_sync             @relation(fields: [userId], references: [id])

  @@index([userId, category])
  @@index([isPublic, category])
  @@map("knowledge_entries")
  @@schema("public")
}

enum ServiceStatus {
  created
  running
  done
  error

  @@schema("public")
}

enum ServiceDepth {
  pre
  a
  b
  c

  @@schema("public")
}

enum TaskKind {
  match
  customize
  interview
  extract
  resume
  job
  detailed

  @@schema("public")
}

enum TaskStatus {
  pending
  queued
  running
  done
  error

  @@schema("public")
}

enum PaymentStatus {
  pending
  succeeded
  refunded
  failed

  @@schema("public")
}

enum IdempotencyStep {
  match
  customize
  interview

  @@schema("public")
}



enum DocumentSourceType {
  resume
  job_description
  detailed_resume
  knowledge_base
  user_upload

  @@schema("public")
}
