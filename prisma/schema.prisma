// ================================================================= //
//  1. Generator & Datasource (From Prototype, Must Keep)
// ================================================================= //

generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["neon_auth", "public"] // Required for Neon Auth
}

// ================================================================= //
//  2. Authentication (From Prototype, Must Keep)
// ================================================================= //
//  This table is managed by Neon Auth. We ONLY REFERENCE it.
//  DO NOT MODIFY.
// ================================================================= //

model users_sync {
  id                   String           @id 
  raw_json             Json?            
  name                 String?          
  email                String?          
  created_at           DateTime?        
  deleted_at           DateTime?        
  updated_at           DateTime?        

  // --- NEW: Links to our business tables ---
  quota            Quota?
  resumes          Resume[]
  detailedResumes  DetailedResume[]
  services         Service[]
  paymentWaitlists PaymentWaitlist[]
  analyticsEvents  AnalyticsEvent[]



  @@map("users_sync")
  @@schema("neon_auth")
}

// ================================================================= //
//  3. NEW: Commercialization Models (Quotas & Payments)
//     (Replaces prototype 'Payment', adds 'Quota')
// ================================================================= //

// NEW: Tracks user's "coin" balance (Requirement 2.2.4)
model Quota {
  id        String     @id @default(cuid())
  // 1-to-1 link to the user
  userId    String     @unique @map("user_id")
  user      users_sync @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade, map: "quota_user_id_fkey")

  balance   Int        @default(0) // Coin balance

  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  @@map("quotas")
  @@schema("public")
}

// ================================================================= //
//  4. REFACTORED: Payment Model (PaymentWaitlist -> PaymentOrder)
//     (Replaces prototype 'PaymentWaitlist')
// ================================================================= //
model PaymentWaitlist {
  id        String     @id @default(cuid())
  userId    String     @unique @map("user_id") // 1-to-1 link
  user      users_sync @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  email     String     // The email to notify
  createdAt DateTime   @default(now()) @map("created_at")

  @@map("payment_waitlist")
  @@schema("public")
}

// ================================================================= //
//  5. REFACTORED: User Asset Models (Resume & DetailedResume)
//     (Replaces prototype 'Resume' & 'DetailedResume')
// ================================================================= //

// REFACTORED: Cleaned up prototype 'Resume'
// This is Asset 1 (General Resume)
model Resume {
  id                String           @id @default(cuid())
  // 1-to-1 link to the user
  userId            String           @unique @map("user_id")
  user              users_sync       @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade, map: "resume_user_id_fkey")

  originalText      String?          @map("original_text")
  resumeSummaryJson Json?            @map("resume_summary_json")

  // NEW: Status for async polling (Requirement 2.3.0)
  status            AsyncTaskStatus  @default(PENDING)

  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  // Link to all services that USED this resume
  services          Service[]

  // DROPPED (from prototype): title, lang, active, tokens, mediaBase64, etc. (too complex)
  // DROPPED (from prototype): ResumeVersion model (not in MVP scope)

  @@map("resumes")
  @@schema("public")
}

// REFACTORED: Cleaned up prototype 'DetailedResume'
// This is Asset 2 (Detailed History)
model DetailedResume {
  id                  String           @id @default(cuid())
  // 1-to-1 link to the user
  userId              String           @unique @map("user_id")
  user                users_sync       @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade, map: "detailed_resume_user_id_fkey")

  originalText        String?          @map("original_text")
  detailedSummaryJson Json?            @map("detailed_summary_json") // Renamed from prototype

  // NEW: Status for async polling (Requirement 2.3.0)
  status              AsyncTaskStatus  @default(PENDING)

  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")

  // Link to all services that USED this detailed resume
  services            Service[]

  @@map("detailed_resumes")
  @@schema("public")
}


// ================================================================= //
//  6. REFACTORED: Core Service Flow Models
//     (Replaces prototype 'Service' and DROPS 'ServiceTask')
// ================================================================= //

// REFACTORED: The "Hub" model, simplified from prototype 'Service'
// Represents one "Job Customization" request (FR-2.4)
model Service {
  id               String          @id @default(cuid())
  userId           String          @map("user_id")
  user             users_sync      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade, map: "service_user_id_fkey")

  // --- Links to the *exact* assets used for this Service ---
  resumeId         String          @map("resume_id")
  resume           Resume          @relation(fields: [resumeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  detailedResumeId String?         @map("detailed_resume_id")
  detailedResume   DetailedResume? @relation(fields: [detailedResumeId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  // --- Step Tracking (Replaces prototype 'ServiceStatus' and 'ServiceDepth') ---
  currentStep      ServiceStep     @default(MATCH) @map("current_step")

  // --- NEW: Decoupled 1-to-1 links to service outputs ---
  job              Job?
  match            Match?
  customizedResume CustomizedResume?
  interview        Interview?

  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  // DROPPED (from prototype): resultJson (now decoupled), status (use currentStep)
  // DROPPED (from prototype): ServiceTask model (handled by QStash + KV)

  @@index([userId, createdAt(sort: Desc)]) // For history list (FR-2.7)
  @@map("services")
  @@schema("public")
}

// --- NEW: Decoupled Service Output Models ---

// NEW: Stores the Job (JD) extraction result
model Job {
  id             String           @id @default(cuid())
  // 1-to-1 link to the Service
  serviceId      String           @unique @map("service_id")
  service        Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  originalText   String?          @map("original_text")
  originalImage  String?          @map("original_image") // URL or Base64 of screenshot
  jobSummaryJson Json?            @map("job_summary_json")

  // NEW: Status for async OCR polling (Requirement 2.3.3)
  status         AsyncTaskStatus  @default(PENDING)

  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  @@map("jobs")
  @@schema("public")
}

// NEW: Stores the Step 1 (Match) result
model Match {
  id               String           @id @default(cuid())
  serviceId        String           @unique @map("service_id")
  service          Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  matchSummaryJson Json?            @map("match_summary_json") // Stores score, analysis, etc.
  status           AsyncTaskStatus  @default(PENDING) // PENDING (for SSE), COMPLETED, FAILED

  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  @@map("matches")
  @@schema("public")
}

// NEW: Stores the Step 2 (Customize) result
model CustomizedResume {
  id               String           @id @default(cuid())
  serviceId        String           @unique @map("service_id")
  service          Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // The editable markdown (FR-6.2)
  markdownContent  String?          @map("markdown_content")
  status           AsyncTaskStatus  @default(PENDING) // For async polling (Requirement 2.3.4)

  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  @@map("customized_resumes")
  @@schema("public")
}

// NEW: Stores the Step 3 (Interview) result
model Interview {
  id                String           @id @default(cuid())
  serviceId         String           @unique @map("service_id")
  service           Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  interviewTipsJson Json?            @map("interview_tips_json") // Stores self-intro, tips list
  status            AsyncTaskStatus  @default(PENDING) // PENDING (for SSE), COMPLETED, FAILED

  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  @@map("interviews")
  @@schema("public")
}


// ================================================================= //
//  7. REFACTORED: RAG Model (Knowledge Base)
//     (Replaces prototype 'KnowledgeEntry')
// ================================================================= //

// REFACTORED: Simplified prototype 'KnowledgeEntry' for a global RAG store (Req 2.2.2)
model KnowledgeEntry {
  id        String                 @id @default(cuid())
  content   String                 // The text chunk

  // NOTE: Set vector dimensions to match your embedding model (e.g., 2048 for zhipu embedding-3)
  embedding Unsupported("vector(2048)")?

  lang     String                  // 'en' or 'zh'
  source    String?                // e.g., 'resume_writing_guide.pdf'
  category  String?                // 'match', 'customize', 'interview' (FR-4.3)
  isPublic  Boolean                @default(true) @map("is_public")

  createdAt DateTime               @default(now()) @map("created_at")
  updatedAt DateTime               @updatedAt @map("updated_at")

  // DROPPED (from prototype): userId, user relation, metadata.
  // REASON: RAG knowledge base is global (admin-managed), not per-user, for MVP.

  @@index([lang, category, isPublic])
  @@map("knowledge_entries")
  @@schema("public")
}

// NEW: A reusable status for all async tasks (Req 2.3.0)
// Replaces prototype 'TaskStatus'
enum AsyncTaskStatus {
  PENDING   // Covers 'queued' and 'running' from prototype
  COMPLETED // Renamed from 'done'
  FAILED    // Renamed from 'error'
  @@schema("public")
}

// NEW: Tracks progress through the 3-step service (Req 2.1.2)
// Replaces prototype 'ServiceDepth'
enum ServiceStep {
  MATCH
  CUSTOMIZE
  INTERVIEW
  COMPLETED // All 3 steps are done
  @@schema("public")
}

// Tracks key user actions for internal analysis (100% data ownership)
model AnalyticsEvent {
  id        String     @id @default(cuid())

  // Can be null for anonymous events (like page_view on landing)
  userId    String?    @map("user_id")
  user      users_sync? @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  eventName String     @map("event_name") // e.g., "TASK_CREATED"
  payload   Json?      // e.g., { "task": "match", "isFree": true }

  createdAt DateTime   @default(now()) @map("created_at")

  @@index([eventName, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("analytics_events")
  @@schema("public")
}