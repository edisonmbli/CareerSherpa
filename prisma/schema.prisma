generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  engineType      = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["neon_auth", "public"]
}

model users_sync {
  id               String           @id @db.Text
  name             String?          @db.Text
  email            String?          @db.Text
  created_at       DateTime?        @db.Timestamptz(6)
  updated_at       DateTime?        @db.Timestamptz(6)
  deleted_at       DateTime?        @db.Timestamptz(6)

  // 关系字段（从其他模型指向此表的外键）
  analyticsEvents  AnalyticsEvent[]
  detailedResumes  DetailedResume?
  paymentWaitlists PaymentWaitlist?
  quota            Quota?
  resumes          Resume?
  services         Service[]
  coinTransactions CoinTransaction[]

  @@index([deleted_at])
  @@map("users_sync")
  @@schema("neon_auth")
}

model Quota {
  id        String     @id @default(cuid())
  userId    String     @unique @map("user_id")
  balance   Int        @default(0)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @default(now()) @updatedAt @map("updated_at")
  user      users_sync @relation(fields: [userId], references: [id], onDelete: Cascade, map: "quota_user_id_fkey")

  @@map("quotas")
  @@schema("public")
}

model PaymentWaitlist {
  id        String     @id @default(cuid())
  userId    String     @unique @map("user_id")
  email     String
  createdAt DateTime   @default(now()) @map("created_at")
  user      users_sync @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_waitlist")
  @@schema("public")
}

model Resume {
  id                String          @id @default(cuid())
  userId            String          @unique @map("user_id")
  originalText      String?         @map("original_text")
  resumeSummaryJson Json?           @map("resume_summary_json")
  status            AsyncTaskStatus @default(PENDING)
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @default(now()) @updatedAt @map("updated_at")
  user              users_sync      @relation(fields: [userId], references: [id], onDelete: Cascade, map: "resume_user_id_fkey")
  services          Service[]

  @@map("resumes")
  @@schema("public")
}

model DetailedResume {
  id                  String          @id @default(cuid())
  userId              String          @unique @map("user_id")
  originalText        String?         @map("original_text")
  detailedSummaryJson Json?           @map("detailed_summary_json")
  status              AsyncTaskStatus @default(PENDING)
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @default(now()) @updatedAt @map("updated_at")
  user                users_sync      @relation(fields: [userId], references: [id], onDelete: Cascade, map: "detailed_resume_user_id_fkey")
  services            Service[]

  @@map("detailed_resumes")
  @@schema("public")
}

model Service {
  id               String            @id @default(cuid())
  userId           String            @map("user_id")
  resumeId         String            @map("resume_id")
  detailedResumeId String?           @map("detailed_resume_id")
  currentStep      ServiceStep       @default(MATCH) @map("current_step")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @default(now()) @updatedAt @map("updated_at")
  customizedResume CustomizedResume?
  interview        Interview?
  job              Job?
  match            Match?
  user             users_sync        @relation(fields: [userId], references: [id], onDelete: Cascade, map: "service_user_id_fkey")
  detailedResume   DetailedResume?   @relation(fields: [detailedResumeId], references: [id])
  resume           Resume            @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  coinTransactions CoinTransaction[]

  @@index([userId(sort: Desc), createdAt(sort: Desc)])
  @@map("services")
  @@schema("public")
}

model Job {
  id             String          @id @default(cuid())
  serviceId      String          @unique @map("service_id")
  originalText   String?         @map("original_text")
  originalImage  String?         @map("original_image")
  jobSummaryJson Json?           @map("job_summary_json")
  status         AsyncTaskStatus @default(PENDING)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @default(now()) @updatedAt @map("updated_at")
  service        Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("jobs")
  @@schema("public")
}

model Match {
  id               String          @id @default(cuid())
  serviceId        String          @unique @map("service_id")
  matchSummaryJson Json?           @map("match_summary_json")
  status           AsyncTaskStatus @default(PENDING)
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @default(now()) @updatedAt @map("updated_at")
  service          Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("matches")
  @@schema("public")
}

model CustomizedResume {
  id              String          @id @default(cuid())
  serviceId       String          @unique @map("service_id")
  markdownText    String?         @map("markdown_text")
  opsJson         Json?           @map("ops_json")
  degradeReason   String?         @map("degrade_reason")
  status          AsyncTaskStatus @default(PENDING)
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @default(now()) @updatedAt @map("updated_at")
  service         Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("customized_resumes")
  @@schema("public")
}

model Interview {
  id                String          @id @default(cuid())
  serviceId         String          @unique @map("service_id")
  interviewTipsJson Json?           @map("interview_tips_json")
  status            AsyncTaskStatus @default(PENDING)
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @default(now()) @updatedAt @map("updated_at")
  service           Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("interviews")
  @@schema("public")
}

model KnowledgeEntry {
  id        String                 @id @default(cuid())
  title     String?                // H3 标题
  content   String                 // 分块后的文本

  // 根据 Zhipu 官方文档，默认维度为 2048
  embedding Unsupported("vector(2048)")?

  lang      String                 // "zh" or "en"
  source    String?                // e.g., "求职干货宝典_rag_zh.md"
  category  String?                // "cv_customize", "job_match", "interview_strategies" etc.
  isPublic  Boolean                @default(true) @map("is_public")
  createdAt DateTime               @default(now()) @map("created_at")
  updatedAt DateTime               @updatedAt @map("updated_at")

  @@index([lang, category, isPublic])
  @@map("knowledge_entries")
  @@schema("public")
}

model AnalyticsEvent {
  id        String      @id @default(cuid())
  userId    String?     @map("user_id")
  eventName String      @map("event_name")
  payload   Json?
  createdAt DateTime    @default(now()) @map("created_at")
  user      users_sync? @relation(fields: [userId], references: [id])

  @@index([eventName, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("analytics_events")
  @@schema("public")
}

model LlmUsageLog {
  id             String   @id @default(cuid())

  // Associations
  userId         String?  @map("user_id")
  serviceId      String?  @map("service_id")
  taskTemplateId String   @map("task_template_id")

  // Provider & Model
  provider       String
  modelId        String   @map("model_id")
  modelName      String?  @map("model_name")

  // Performance & Cost
  inputTokens    Int      @default(0) @map("input_tokens")
  outputTokens   Int      @default(0) @map("output_tokens")
  totalTokens    Int      @default(0) @map("total_tokens")
  latencyMs      Int      @map("latency_ms")
  cost           Float?   @default(0)

  // Status
  isStream       Boolean  @default(false) @map("is_stream")
  isSuccess      Boolean  @default(true) @map("is_success")
  errorMessage   String?  @map("error_message")

  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([userId, createdAt(sort: Desc)])
  @@index([taskTemplateId, createdAt(sort: Desc)])
  @@map("llm_usage_logs")
  @@schema("public")
}

model CoinTransaction {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  type          CoinTxnType
  status        CoinTxnStatus
  delta         Int         @map("delta")
  balanceAfter  Int         @map("balance_after")
  serviceId     String?     @map("service_id")
  taskId        String?     @map("task_id")
  templateId    String?     @map("template_id")
  messageId     String?     @map("message_id")
  idemKey       String?     @map("idem_key")
  relatedId     String?     @map("related_id")
  metadata      Json?
  createdAt     DateTime    @default(now()) @map("created_at")
  user          users_sync  @relation(fields: [userId], references: [id], onDelete: Cascade)
  service       Service?    @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  related       CoinTransaction? @relation("RelatedLedger", fields: [relatedId], references: [id], onDelete: SetNull)
  refunds       CoinTransaction[] @relation("RelatedLedger")

  @@index([userId, createdAt(sort: Desc)])
  @@index([taskId, createdAt(sort: Desc)])
  @@index([serviceId, createdAt(sort: Desc)])
  @@unique([idemKey])
  @@map("coin_transactions")
  @@schema("public")
}

enum AsyncTaskStatus {
  PENDING
  COMPLETED
  FAILED

  @@schema("public")
}

enum ServiceStep {
  MATCH
  CUSTOMIZE
  INTERVIEW
  COMPLETED

  @@schema("public")
}

enum CoinTxnType {
  SIGNUP_BONUS
  PURCHASE
  SERVICE_DEBIT
  FAILURE_REFUND
  MANUAL_ADJUST

  @@schema("public")
}

enum CoinTxnStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED

  @@schema("public")
}
