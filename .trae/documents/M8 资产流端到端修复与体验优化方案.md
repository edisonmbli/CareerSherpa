## 问题与根因概览
- 轮询未启动与按钮长期禁用：`useTaskPolling` 仅依赖内部 `status`，未与外部状态联动，导致不轮询、UI停滞。
- LLM 校验不一致与重复日志：Prompt 输出 `skills` 为数组，但 zod 期望对象；同时 Service 与 Worker 双处记录失败导致重复日志。
- 结构化失败未返还金币：批处理 Worker 在 `ok=false`（非异常）路径未执行返还。
- 页面反馈不足：缺少“最近状态时间”、失败可重试与覆盖上传的可用性设计。

## 设计对齐
- 需求：`docs/1.Project_Spec.md:128-173`、`docs/2.Solution_Spec.md:43-53, 77-88, 374-424`
- 原则：上传立即返回；扣费在 Server Action；失败原子化返还；轮询用最小频次。

## 后端修复
- 结构化失败返还金币：`lib/worker/handlers.ts`
  - 在结构化成功返回路径中，若 `exec.result.ok===false && variables.wasPaid===true`，执行 `addQuota(userId, cost)`；记录一次失败返还事件。
- 去重 LLM 使用日志：保留 `lib/llm/service.ts` 的一次记录；移除 `lib/worker/handlers.ts` 的二次记录。

## LLM 校验对齐
- zod 兼容：`lib/llm/zod-schemas.ts`
  - `resume_summary.skills` 改为联合：`array(string)` 或 `object(technical|soft|tools)`，容错现有输出。
- Prompt 输出一致：`lib/prompts/en.ts`、`lib/prompts/zh.ts`
  - 指示“能分类则对象；无法分类则数组”，与 zod 同步。

## 前端轮询与交互
- 轮询钩子重写：`lib/hooks/useTaskPolling.ts`
  - 接口：`{ taskId, taskType, enabled, intervalPlan, maxAttempts, onStatusChange }`；以 `taskId+enabled` 触发，首轮立即请求，随后退避（2→3→5→10s）。
  - 返回：`{ status, attempts, lastUpdated }`。
- 组件改造：`components/app/AssetUploader.tsx`
  - 状态机与可用性：`UPLOADING` 时禁用；`PENDING` 恢复可上传（覆盖）；失败展示“小字解释 + 重试”；成功展示 `pdf icon + 文件名 + 时间戳`。
  - Toast：成功入队；失败含“（若为付费队列）已返还金币”。

## 低流量轮询优化（Vercel Free Tier）
- `task-status` 接口（只读）：
  - 支持 `ETag/If-None-Match`，状态未变返回 `304`，无响应体，减少流量。
  - 附带 `lastUpdatedAt` 与精简 JSON（仅必要字段）。
- 客户端轮询策略：
  - 退避与封顶（最多 30 次）；成功/失败立即停止；失败后延时再触发“重试上传”，不自动继续轮询。
  - 并发保护：同一 `taskId` 仅一个轮询定时器；路由切换取消定时器。

## 监控与排障
- 保留 `app/api/auth-debug` 会话诊断；
- 增强事件日志：返还金币事件与失败原因统一打点，便于运营与排障。

## 测试计划
- 单测：
  - 鉴权上下文（`tests/auth-wrapper.test.ts`）；
  - 返还分支（`tests/quotas.test.ts`）；
  - zod 联合类型（`tests/llm/service_validation.test.ts`）；
  - 轮询触发/退避（`tests/hooks/useTaskPolling.test.ts`）。
- E2E：上传简历→触发 `ok=false`→验证：立即返回；QStash 入队；DB `FAILED` + `NULL`；额度返还；前端显示失败与重试入口。

## 实施顺序
1. Worker 返还修复与去重日志；
2. zod/PROMPT 对齐；
3. 轮询钩子与组件改造；
4. `task-status` 加 ETag 与 lastUpdated；
5. 测试与 E2E 自测；

如确认，按该顺序实施，并在每步完成后提供验证结果。