## 概述
- 目标：在提取阶段尽量保留原文，并以统一 JSON 结构落库；在定制阶段只做“必要且最小”的修改，用户能明显感知是自己的简历被点拨。
- 范围：Schema V2 扩展、Prompt 调整、zod 校验、Worker 兜底、切片提取、Tokens 管理与降级、调试与度量脚本。

## Schema 扩展（V2）
- 字段新增：
  - `summary_points: string[]`、`specialties_points: string[]`
  - `experience[].responsibilities: string[]`（保留“负责/唯一负责人”等职责句）
  - `projects[].{name, link, description, highlights}`、`openSource[]`
  - `skills: string[] | { technical, soft, tools }`
  - `certifications[]`、`languages[]`、`awards[]`、`extras[]`
  - `verbatim_*` 分区（如 `verbatim_summary`、`verbatim_experience`）完整备份原文
- 实施：在 `lib/prompts/zh.ts`/`en.ts` 引入 `SCHEMAS_V2.RESUME_SUMMARY` 并切换 `resume_summary` 的 `outputSchema`。

## Prompt 政策
- System：注入完整 JSON Schema；明确“只输出一个 JSON 对象、不得 paraphrase、不得丢弃原文要点”。
- Human：强调“提取而非改写”，分区说明：
  - 要点类：逐条复制原文（保留顺序与措辞）到 `summary_points`/`specialties_points`
  - 职责类：以“负责/主导/唯一负责人”等开头的句子进入 `responsibilities`
  - 高光类：量化结果进入 `highlights`
  - 链接与项目名：原样保留

## zod 校验与 Worker 兜底
- zod：至少一个主分区非空（summary/experience/projects/education/skills）；校验新增 responsibilities/specialties_points 结构。
- Worker：若主分区均空或仅冗余，标记失败、返还金币，并写入 `degradeReason`。

## Tokens 管理与降级
- 配置文件：`lib/llm/config.ts` 按任务维护 `maxInputTokens`、`maxOutputTokens`、`maxTotalTokens`、`chunking` 策略。
- 切片提取：按分区标题窗口化（Summary/Skills/Projects/Experience），分批调用后合并；避免一次性塞满上下文。
- 运行时降级：
  - 第一级：缩短 human（仅保留职责+量化高光）
  - 第二级：限制 `highlights`/`description` 的长度与条数
  - 第三级：仅落 `verbatim_*` + 骨干结构，并返回降级提示
- 模型参数：`getModel(modelId, { maxTokens })` 按任务设置输出上限；输入由切片策略控制。

## 调试与度量
- 脚本增强：
  - `scripts/debug-resume-summary.ts` 打印渲染后 human、剥离 fence 后 JSON、分区覆盖率（条目数与 n-gram 重叠）。
- 覆盖率指标：
  - 要点类 Jaccard/ROUGE-L ≥ 0.9（原文 vs 提取）
  - 条目数一致性（原文要点数≈提取条目数）

## 定制（M9）最小修改
- 输入：`resume_summary_v2`（含 `verbatim_*`）、`job_summary`、`match` 结果
- 输出：
  - 操作列表 ops JSON：`reorder/augment/trim/rewrite-lite`（保留原句与改句并排）
  - Markdown 合成：应用 ops 生成；UI 高亮差异；支持导出 PDF

## 风险与回滚
- 灰度发布：V2 字段先低流量开启；异常随时回退到 V1。
- 严格模式开关：`LLM_STRICT_MODE` 控制失败返还与宽松写入策略。
- 模型降级：主模型不可用时切到 flash，仅做骨干提取；保留 `verbatim_*` 供重试。

## 实施顺序
1. Schema V2 与 `resume_summary` 切换
2. zod 校验与 Worker 兜底补充
3. Prompt 调整与切片提取实现
4. Tokens 配置与降级策略接入
5. 调试脚本与度量上线
6. 定制链路（ops + Markdown）与 UI 差异高亮

## 验证
- 单测：Schema 校验、降级路径、返还逻辑
- E2E：上传→提取→定制→预览→导出；包含长简历与超限场景

确认后我将按该顺序完成实现与验证，并在关键阶段输出度量与可回滚开关状态。